generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Connection URL is provided via prisma.config.ts (Supabase direct, non-pooled). connection_limit is enforced in Prisma client options.
}

model User {
  id               String                 @id @default(uuid())
  email            String                 @unique
  name             String
  password         String
  accountType      UserAccountType        @default(AGENT)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  messages         Message[]
  organizations    OrganizationMember[]
  editorProjects   Project[]              @relation("EditorProjects")
  techProjects     Project[]              @relation("TechProjects")
  managerProjects  Project[]              @relation("ManagerProjects")
  approvedProjects Project[]              @relation("ApprovedProjects")
  customers        OrganizationCustomer[]
  notifications    Notification[]

  // Calendar integrations
  calendarIntegrations UserCalendarIntegration[]
  icsFeed              UserIcsFeed?
  techCalendarEvents   TechnicianCalendarEvent[] @relation("TechCalendarEvents")

  // Availability / Work hours
  availability       UserAvailability[]
  availabilityStatus UserAvailabilityStatus?
}

model Organization {
  id            String                 @id
  name          String
  createdAt     DateTime               @default(now())
  type          OrgType                @default(COMPANY)
  addressLine1  String?
  addressLine2  String?
  city          String?
  region        String?
  postalCode    String?
  countryCode   String?
  lat           Float?
  lng           Float?
  legalName     String?
  logoUrl       String?
  phone         String?
  primaryEmail  String?
  serviceArea   Json?
  slug          String?
  timezone      String?
  websiteUrl    String?
  invitations   Invitation[]
  members       OrganizationMember[]
  projects      Project[]
  customers     OrganizationCustomer[]
  notifications Notification[]
  packages      ServicePackage[]
  addOns        PackageAddOn[]
}

model OrganizationMember {
  id           String       @id @default(uuid())
  userId       String
  orgId        String
  role         OrgRole
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([userId, orgId])
}

model Media {
  id        String    @id @default(cuid())
  projectId String
  key       String
  cdnUrl    String?
  filename  String
  size      Int
  type      MediaType
  createdAt DateTime  @default(now())
  project   Project   @relation(fields: [projectId], references: [id])
}

model Message {
  id        String             @id @default(uuid())
  projectId String
  userId    String
  content   String
  timestamp DateTime           @default(now())
  channel   ProjectChatChannel @default(TEAM)
  thread    String?
  project   Project            @relation(fields: [projectId], references: [id])
  user      User               @relation(fields: [userId], references: [id])
}

enum ProjectChatChannel {
  TEAM
  CUSTOMER
}

model Project {
  id               String                @id @default(uuid())
  addressLine1     String?
  addressLine2     String?
  city             String?
  region           String?
  postalCode       String?
  countryCode      String?
  lat              Float?
  lng              Float?
  notes            String?
  scheduledTime    DateTime
  scheduledEndTime DateTime?
  status           ProjectStatus         @default(BOOKED)
  technicianId     String?
  editorId         String?
  projectManagerId String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  orgId            String
  customerId       String?

  // Delivery fields
  deliveryToken        String?              @unique @default(uuid())
  deliveryEnabledAt    DateTime?

  // Approval fields
  clientApprovalStatus ClientApprovalStatus @default(PENDING_REVIEW)
  clientApprovedAt     DateTime?
  clientApprovedById   String?

  // Payment fields
  stripePaymentIntentId String?
  paidAt                DateTime?
  paymentAmount         Int?
  paymentCurrency       String?

  // Calendar sync fields
  calendarConflict      Boolean               @default(false) // Flag when external event changed
  calendarConflictNote  String?               // Description of the conflict

  // Relations
  calendarEvent    CalendarEvent?
  media            Media[]
  messages         Message[]
  editor           User?                 @relation("EditorProjects", fields: [editorId], references: [id])
  organization     Organization          @relation(fields: [orgId], references: [id])
  technician       User?                 @relation("TechProjects", fields: [technicianId], references: [id])
  projectManager   User?                 @relation("ManagerProjects", fields: [projectManagerId], references: [id])
  customer         OrganizationCustomer? @relation(fields: [customerId], references: [id])
  clientApprovedBy User?                 @relation("ApprovedProjects", fields: [clientApprovedById], references: [id])
  notifications    Notification[]
  pendingOrder     PendingOrder?
  techCalendarEvents TechnicianCalendarEvent[]
}

model OrganizationCustomer {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  email     String?
  phone     String?
  notes     String?
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  user         User?        @relation(fields: [userId], references: [id])
  projects     Project[]
}

model Inquiry {
  id        String        @id @default(uuid())
  name      String
  email     String
  phone     String?
  address   String?
  message   String?
  status    InquiryStatus @default(PENDING)
  createdAt DateTime      @default(now())
}

model CalendarEvent {
  id             String                  @id @default(uuid())
  projectId      String                  @unique
  cronofyEventId String?                 // Legacy Cronofy event ID
  calendarId     String?                 // Legacy calendar ID
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt @default(now())

  // Nylas-specific fields
  nylasEventId   String?                 // Nylas event ID
  nylasCalendarId String?                // Nylas calendar ID
  nylasGrantId   String?                 // Nylas grant ID (for API calls)
  lastSyncedAt   DateTime?               // When last synced to external calendar
  syncStatus     CalendarEventSyncStatus @default(PENDING)
  lastError      String?                 // Last sync error message

  project        Project  @relation(fields: [projectId], references: [id])

  @@index([nylasEventId])
}

model Invitation {
  id            String           @id @default(uuid())
  email         String
  orgId         String
  role          OrgRole
  token         String           @unique
  accepted      Boolean          @default(false)
  inviteType    InvitationType   @default(MEMBER)
  status        InvitationStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  organization  Organization     @relation(fields: [orgId], references: [id])
  notifications Notification[]
}

enum UserAccountType {
  AGENT
  PROVIDER
  COMPANY
}

enum OrgRole {
  OWNER
  ADMIN
  TECHNICIAN
  EDITOR
  PROJECT_MANAGER
  AGENT
}

enum OrgType {
  COMPANY
  PERSONAL
  TEAM
}

enum MediaType {
  PHOTO
  VIDEO
  FLOORPLAN
  DOCUMENT
}

enum ProjectStatus {
  BOOKED
  SHOOTING
  EDITING
  DELIVERED
  CANCELLED
}

enum InquiryStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
  CONVERTED_TO_PROJECT
}

enum InvitationType {
  MEMBER
  CUSTOMER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum NotificationType {
  INVITATION_MEMBER
  INVITATION_CUSTOMER
  PROJECT_ASSIGNED
  NEW_MESSAGE
  PROJECT_APPROVED
}

enum ClientApprovalStatus {
  PENDING_REVIEW
  APPROVED
  CHANGES_REQUESTED
}

enum PendingOrderStatus {
  PENDING_PAYMENT
  PAYMENT_COMPLETED
  PROJECT_CREATED
  EXPIRED
  CANCELLED
}

model Notification {
  id           String           @id @default(uuid())
  userId       String
  orgId        String
  type         NotificationType
  invitationId String?
  projectId    String?
  messageId    String?
  payload      Json?
  createdAt    DateTime         @default(now())
  readAt       DateTime?

  user         User             @relation(fields: [userId], references: [id])
  organization Organization     @relation(fields: [orgId], references: [id])
  invitation   Invitation?      @relation(fields: [invitationId], references: [id])
  project      Project?         @relation(fields: [projectId], references: [id])
}

model PendingOrder {
  id                    String             @id @default(uuid())
  stripeSessionId       String             @unique
  stripePaymentIntentId String?
  agentUserId           String
  agentCustomerId       String
  providerOrgId         String
  orderData             Json
  status                PendingOrderStatus @default(PENDING_PAYMENT)
  totalAmount           Int
  currency              String             @default("usd")
  createdAt             DateTime           @default(now())
  expiresAt             DateTime
  completedAt           DateTime?
  projectId             String?            @unique
  project               Project?           @relation(fields: [projectId], references: [id])

  // Package selection
  packageId             String?
  package               ServicePackage?    @relation(fields: [packageId], references: [id])
  selectedAddOnIds      String[]           @default([])

  @@index([agentUserId])
  @@index([providerOrgId])
  @@index([status])
}

// =============================
// Service Packages & Add-ons
// =============================

model ServicePackage {
  id            String         @id @default(uuid())
  orgId         String
  name          String
  description   String?
  price         Int            // Price in cents
  currency      String         @default("usd")
  mediaTypes    MediaType[]    // Included media types
  isActive      Boolean        @default(true)
  displayOrder  Int            @default(0)
  turnaroundDays Int?          // Expected delivery time
  photoCount    Int?           // Number of photos included
  videoMinutes  Int?           // Minutes of video included
  features      String[]       @default([])  // Feature bullet points
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  organization  Organization   @relation(fields: [orgId], references: [id])
  pendingOrders PendingOrder[]

  @@index([orgId])
  @@index([isActive])
}

model PackageAddOn {
  id            String       @id @default(uuid())
  orgId         String
  name          String
  description   String?
  price         Int          // Price in cents
  currency      String       @default("usd")
  category      AddOnCategory @default(OTHER)
  isActive      Boolean      @default(true)
  displayOrder  Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  organization  Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([isActive])
}

enum AddOnCategory {
  AERIAL        // Drone photography/video
  TWILIGHT      // Twilight/dusk shots
  VIRTUAL_TOUR  // 3D virtual tours
  FLOORPLAN     // Floor plans
  RUSH          // Rush delivery
  OTHER
}

// =============================
// Calendar Integrations
// =============================

enum CalendarProvider {
  GOOGLE
  OUTLOOK
  CRONOFY
  NYLAS
}

enum CalendarIntegrationStatus {
  PENDING
  ACTIVE
  EXPIRED
  DISCONNECTED
}

enum CalendarEventSyncStatus {
  PENDING
  SYNCED
  FAILED
  DELETED
}

// Per-user OAuth calendar connections (Nylas-based)
model UserCalendarIntegration {
  id                String                    @id @default(uuid())
  userId            String
  provider          CalendarProvider
  providerAccountId String?
  calendarId        String
  calendarName      String?
  accessToken       String                    // Encrypted (for legacy/non-Nylas)
  refreshToken      String?                   // Encrypted (for legacy/non-Nylas)
  tokenExpiresAt    DateTime?
  status            CalendarIntegrationStatus @default(PENDING)
  isPrimary         Boolean                   @default(false)
  isWriteTarget     Boolean                   @default(false) // Calendar to write events to
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  lastSyncAt        DateTime?
  lastSyncError     String?

  // Nylas-specific fields
  nylasGrantId      String?                   // Nylas grant ID after OAuth
  nylasCalendarId   String?                   // Nylas calendar ID

  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  calendarEvents TechnicianCalendarEvent[]

  @@unique([userId, provider, calendarId])
  @@index([userId])
  @@index([nylasGrantId])
}

// ICS feed per user
model UserIcsFeed {
  id           String    @id @default(uuid())
  userId       String    @unique
  feedToken    String    @unique @default(uuid())
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  lastAccessAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([feedToken])
}

// Track events synced to external calendars
model TechnicianCalendarEvent {
  id              String                   @id @default(uuid())
  projectId       String
  technicianId    String
  integrationId   String?
  externalEventId String?
  status          CalendarEventSyncStatus  @default(PENDING)
  syncedAt        DateTime?
  lastError       String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  project     Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  technician  User                     @relation("TechCalendarEvents", fields: [technicianId], references: [id], onDelete: Cascade)
  integration UserCalendarIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@unique([projectId, technicianId, integrationId])
  @@index([technicianId])
  @@index([projectId])
}

// Day of week enum for availability
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// User availability / work hours per day
model UserAvailability {
  id        String    @id @default(uuid())
  userId    String
  dayOfWeek DayOfWeek
  isEnabled Boolean   @default(true) // Whether user works this day
  startTime String    @default("09:00") // HH:mm format
  endTime   String    @default("17:00") // HH:mm format
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
}

// Overall availability status for a user
model UserAvailabilityStatus {
  id                 String   @id @default(uuid())
  userId             String   @unique
  isAvailable        Boolean  @default(true) // Quick toggle for overall availability
  availabilityNote   String?  // Optional note (e.g., "On vacation until Jan 15")
  autoDeclineBookings Boolean @default(false) // Auto-decline new assignments when unavailable
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
