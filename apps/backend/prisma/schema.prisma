generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String                    @id @default(uuid())
  clerkUserId          String?                   @unique // Clerk external user ID
  email                String                    @unique
  emailVerifiedAt      DateTime?                 // When email was verified (set on Clerk signup)
  name                 String
  password             String
  avatarUrl            String?                   // Profile picture URL
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  deactivatedAt        DateTime?                 // Account deactivation timestamp (soft delete)
  accountType          UserAccountType           @default(AGENT)
  messages             Message[]
  messageReads         MessageRead[]
  notifications        Notification[]
  customers            OrganizationCustomer[]
  organizations        OrganizationMember[]
  approvedProjects     Project[]                 @relation("ApprovedProjects")
  editorProjects       Project[]                 @relation("EditorProjects")
  managerProjects      Project[]                 @relation("ManagerProjects")
  techProjects         Project[]                 @relation("TechProjects")
  techCalendarEvents   TechnicianCalendarEvent[] @relation("TechCalendarEvents")
  availability         UserAvailability[]
  availabilityStatus   UserAvailabilityStatus?
  calendarIntegrations UserCalendarIntegration[]
  icsFeed              UserIcsFeed?
  useCases             ProviderUseCase[]
  tourProgress         TourProgress[]
  tourStatus           TourStatus?
}

model Organization {
  id            String                 @id
  name          String
  createdAt     DateTime               @default(now())
  legalName     String?
  logoUrl       String?
  phone         String?
  primaryEmail  String?
  serviceArea   Json?
  slug          String?
  timezone      String?
  websiteUrl    String?
  type          OrgType                @default(COMPANY)
  addressLine1  String?
  addressLine2  String?
  city          String?
  region        String?
  postalCode    String?
  countryCode   String?
  lat           Float?
  lng           Float?
  invitations   Invitation[]
  notifications Notification[]
  customers     OrganizationCustomer[]
  members       OrganizationMember[]
  addOns        PackageAddOn[]
  projects      Project[]
  packages      ServicePackage[]
}

model OrganizationMember {
  id           String       @id @default(uuid())
  userId       String
  orgId        String
  role         OrgRole
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([userId, orgId])
}

model Media {
  id        String    @id @default(cuid())
  projectId String
  key       String
  cdnUrl    String?
  filename  String
  size      Int
  type      MediaType
  createdAt DateTime  @default(now())
  project   Project   @relation(fields: [projectId], references: [id])
}

model DownloadArtifact {
  id            String                 @id @default(cuid())
  projectId     String
  type          DownloadArtifactType   @default(ALL_MEDIA)
  status        DownloadArtifactStatus @default(PENDING)
  key           String?                // Storage key (e.g., Uploadcare UUID)
  cdnUrl        String?                // CDN URL to download the artifact
  filename      String?                // Suggested filename for download
  size          Int?                   // File size in bytes
  mediaHash     String?                // Hash of media IDs to detect changes
  error         String?                // Error message if generation failed
  createdAt     DateTime               @default(now())
  expiresAt     DateTime?              // When the artifact should be deleted
  project       Project                @relation(fields: [projectId], references: [id])

  @@index([projectId, type, status])
}

enum DownloadArtifactType {
  ALL_MEDIA
  PHOTOS_ONLY
  VIDEOS_ONLY
}

enum DownloadArtifactStatus {
  PENDING
  GENERATING
  READY
  EXPIRED
  FAILED
}

model Message {
  id           String             @id @default(uuid())
  projectId    String
  userId       String
  content      String
  timestamp    DateTime           @default(now())
  channel      ProjectChatChannel @default(TEAM)
  thread       String?
  project      Project            @relation(fields: [projectId], references: [id])
  user         User               @relation(fields: [userId], references: [id])
  readReceipts MessageRead[]
}

model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model Project {
  id                    String                    @id @default(uuid())
  notes                 String?
  scheduledTime         DateTime
  status                ProjectStatus             @default(BOOKED)
  technicianId          String?
  editorId              String?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  orgId                 String
  customerId            String?
  projectManagerId      String?
  addressLine1          String?
  addressLine2          String?
  city                  String?
  region                String?
  postalCode            String?
  countryCode           String?
  lat                   Float?
  lng                   Float?
  clientApprovalStatus  ClientApprovalStatus      @default(PENDING_REVIEW)
  clientApprovedAt      DateTime?
  clientApprovedById    String?
  deliveryEnabledAt     DateTime?
  deliveryToken         String?                   @unique @default(uuid())
  paidAt                DateTime?
  paymentAmount         Int?
  paymentCurrency       String?
  stripePaymentIntentId String?
  calendarConflict      Boolean                   @default(false)
  calendarConflictNote  String?
  isDemo                Boolean                   @default(false)  // Demo project for tour walkthrough
  calendarEvent         CalendarEvent?
  downloadArtifacts     DownloadArtifact[]
  media                 Media[]
  messages              Message[]
  notifications         Notification[]
  pendingOrder          PendingOrder?
  clientApprovedBy      User?                     @relation("ApprovedProjects", fields: [clientApprovedById], references: [id])
  customer              OrganizationCustomer?     @relation(fields: [customerId], references: [id])
  editor                User?                     @relation("EditorProjects", fields: [editorId], references: [id])
  organization          Organization              @relation(fields: [orgId], references: [id])
  projectManager        User?                     @relation("ManagerProjects", fields: [projectManagerId], references: [id])
  technician            User?                     @relation("TechProjects", fields: [technicianId], references: [id])
  techCalendarEvents    TechnicianCalendarEvent[]
}

model OrganizationCustomer {
  id           String       @id @default(uuid())
  orgId        String
  name         String
  email        String?
  phone        String?
  notes        String?
  userId       String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  organization Organization @relation(fields: [orgId], references: [id])
  user         User?        @relation(fields: [userId], references: [id])
  projects     Project[]
}

model Inquiry {
  id        String        @id @default(uuid())
  name      String
  email     String
  phone     String?
  address   String?
  message   String?
  status    InquiryStatus @default(PENDING)
  createdAt DateTime      @default(now())
}

model CalendarEvent {
  id              String                  @id @default(uuid())
  projectId       String                  @unique
  cronofyEventId  String?
  calendarId      String?
  createdAt       DateTime                @default(now())
  lastError       String?
  lastSyncedAt    DateTime?
  nylasCalendarId String?
  nylasEventId    String?
  nylasGrantId    String?
  syncStatus      CalendarEventSyncStatus @default(PENDING)
  updatedAt       DateTime                @default(now()) @updatedAt
  project         Project                 @relation(fields: [projectId], references: [id])

  @@index([nylasEventId])
}

model Invitation {
  id            String           @id @default(uuid())
  email         String
  orgId         String
  role          OrgRole
  token         String           @unique
  accepted      Boolean          @default(false)
  createdAt     DateTime         @default(now())
  inviteType    InvitationType   @default(MEMBER)
  status        InvitationStatus @default(PENDING)
  organization  Organization     @relation(fields: [orgId], references: [id])
  notifications Notification[]
}

model Notification {
  id           String           @id @default(uuid())
  userId       String
  orgId        String?          // Nullable for user-level notifications
  type         NotificationType
  title        String?          // Short title for the notification
  body         String?          // Longer description/body text
  entityType   String?          // e.g., "project", "invitation", "message", "delivery"
  entityId     String?          // ID of the related entity
  invitationId String?
  projectId    String?
  messageId    String?
  payload      Json?
  createdAt    DateTime         @default(now())
  readAt       DateTime?
  invitation   Invitation?      @relation(fields: [invitationId], references: [id])
  organization Organization?    @relation(fields: [orgId], references: [id])
  project      Project?         @relation(fields: [projectId], references: [id])
  user         User             @relation(fields: [userId], references: [id])

  @@index([userId, readAt])
  @@index([userId, createdAt])
  @@index([userId, type])
}

model PendingOrder {
  id                    String             @id @default(uuid())
  stripeSessionId       String             @unique
  stripePaymentIntentId String?
  agentUserId           String
  agentCustomerId       String
  providerOrgId         String
  orderData             Json
  status                PendingOrderStatus @default(PENDING_PAYMENT)
  totalAmount           Int
  currency              String             @default("usd")
  createdAt             DateTime           @default(now())
  expiresAt             DateTime
  completedAt           DateTime?
  projectId             String?            @unique
  packageId             String?
  selectedAddOnIds      String[]           @default([])
  package               ServicePackage?    @relation(fields: [packageId], references: [id])
  project               Project?           @relation(fields: [projectId], references: [id])

  @@index([agentUserId])
  @@index([providerOrgId])
  @@index([status])
}

model ServicePackage {
  id             String         @id @default(uuid())
  orgId          String
  name           String
  description    String?
  price          Int
  currency       String         @default("usd")
  mediaTypes     MediaType[]
  isActive       Boolean        @default(true)
  displayOrder   Int            @default(0)
  turnaroundDays Int?
  photoCount     Int?
  videoMinutes   Int?
  features       String[]       @default([])
  images         String[]       @default([]) // URLs for package showcase images
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  pendingOrders  PendingOrder[]
  organization   Organization   @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([isActive])
}

model PackageAddOn {
  id           String        @id @default(uuid())
  orgId        String
  name         String
  description  String?
  price        Int
  currency     String        @default("usd")
  category     AddOnCategory @default(OTHER)
  isActive     Boolean       @default(true)
  displayOrder Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  organization Organization  @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([isActive])
}

model UserCalendarIntegration {
  id                String                    @id @default(uuid())
  userId            String
  provider          CalendarProvider
  providerAccountId String?
  calendarId        String
  calendarName      String?
  accessToken       String
  refreshToken      String?
  tokenExpiresAt    DateTime?
  status            CalendarIntegrationStatus @default(PENDING)
  isPrimary         Boolean                   @default(false)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  lastSyncAt        DateTime?
  lastSyncError     String?
  isWriteTarget     Boolean                   @default(false)
  nylasCalendarId   String?
  nylasGrantId      String?
  calendarEvents    TechnicianCalendarEvent[]
  user              User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, calendarId])
  @@index([userId])
  @@index([nylasGrantId])
}

model UserIcsFeed {
  id           String    @id @default(uuid())
  userId       String    @unique
  feedToken    String    @unique @default(uuid())
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  lastAccessAt DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([feedToken])
}

model TechnicianCalendarEvent {
  id              String                   @id @default(uuid())
  projectId       String
  technicianId    String
  integrationId   String?
  externalEventId String?
  status          CalendarEventSyncStatus  @default(PENDING)
  syncedAt        DateTime?
  lastError       String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  integration     UserCalendarIntegration? @relation(fields: [integrationId], references: [id])
  project         Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  technician      User                     @relation("TechCalendarEvents", fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([projectId, technicianId, integrationId])
  @@index([technicianId])
  @@index([projectId])
}

model UserAvailability {
  id        String    @id @default(uuid())
  userId    String
  dayOfWeek DayOfWeek
  isEnabled Boolean   @default(true)
  startTime String    @default("09:00")
  endTime   String    @default("17:00")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
}

model UserAvailabilityStatus {
  id                  String   @id @default(uuid())
  userId              String   @unique
  isAvailable         Boolean  @default(true)
  availabilityNote    String?
  autoDeclineBookings Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ProjectChatChannel {
  TEAM
  CUSTOMER
}

enum UserAccountType {
  AGENT
  PROVIDER
  COMPANY
}

enum OrgRole {
  OWNER
  ADMIN
  TECHNICIAN
  EDITOR
  PROJECT_MANAGER
  AGENT
}

enum OrgType {
  COMPANY
  PERSONAL
  TEAM
}

enum MediaType {
  PHOTO
  VIDEO
  FLOORPLAN
  DOCUMENT
}

enum ProjectStatus {
  PENDING    // Scheduling requested - awaiting time confirmation
  BOOKED     // Specific time scheduled
  SHOOTING
  EDITING
  DELIVERED
  CANCELLED
}

enum InquiryStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
  CONVERTED_TO_PROJECT
}

enum InvitationType {
  MEMBER
  CUSTOMER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum NotificationType {
  INVITATION_MEMBER
  INVITATION_CUSTOMER
  PROJECT_ASSIGNED
  NEW_MESSAGE
  PROJECT_APPROVED
  PROJECT_DELIVERED
  CHANGES_REQUESTED    // Customer requested changes on delivery
  DELIVERY_COMMENT     // New comment on delivery
}

enum ClientApprovalStatus {
  PENDING_REVIEW
  APPROVED
  CHANGES_REQUESTED
}

enum PendingOrderStatus {
  PENDING_PAYMENT
  PAYMENT_COMPLETED
  PROJECT_CREATED
  EXPIRED
  CANCELLED
}

enum AddOnCategory {
  AERIAL
  TWILIGHT
  VIRTUAL_TOUR
  FLOORPLAN
  RUSH
  OTHER
}

enum CalendarProvider {
  GOOGLE
  OUTLOOK
  CRONOFY
  NYLAS
}

enum CalendarIntegrationStatus {
  PENDING
  ACTIVE
  EXPIRED
  DISCONNECTED
}

enum CalendarEventSyncStatus {
  PENDING
  SYNCED
  FAILED
  DELETED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model EmailOtp {
  id        String    @id @default(uuid())
  email     String
  code      String    // 6-digit code, hashed
  token     String    @unique // issued on successful verify
  verified  Boolean   @default(false)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  @@index([email])
}

model ProviderUseCase {
  id      String              @id @default(uuid())
  userId  String
  useCase ProviderUseCaseType
  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, useCase])
  @@index([userId])
}

enum ProviderUseCaseType {
  PHOTOGRAPHY
  VIDEOGRAPHY
  DRONE_AERIAL
  VIRTUAL_TOURS
  FLOOR_PLANS
  EDITING
  STAGING
  MEASUREMENTS
}

// ==================== TOUR / ONBOARDING ====================

enum TourTrack {
  DASHBOARD_OVERVIEW
  JOB_MANAGEMENT
  MESSAGING_CHAT
  SETTINGS_INTEGRATIONS
}

model TourProgress {
  id          String    @id @default(uuid())
  userId      String
  tourTrack   TourTrack
  stepId      String
  completed   Boolean   @default(false)
  completedAt DateTime?
  skippedAt   DateTime?
  startedAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tourTrack, stepId])
  @@index([userId])
  @@index([tourTrack])
}

model TourStatus {
  id                String     @id @default(uuid())
  userId            String     @unique
  hasCompletedSetup Boolean    @default(false)
  dismissedGuide    Boolean    @default(false)
  lastActiveTrack   TourTrack?
  demoProjectId     String?    // Demo project created for tour walkthrough
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}
