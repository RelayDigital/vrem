generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String                 @id @default(uuid())
  email           String                 @unique
  name            String
  password        String
  accountType     UserAccountType        @default(AGENT)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  messages        Message[]
  organizations   OrganizationMember[]
  editorProjects  Project[]              @relation("EditorProjects")
  techProjects    Project[]              @relation("TechProjects")
  managerProjects Project[]              @relation("ManagerProjects")
  customers       OrganizationCustomer[]
}

model Organization {
  id           String                 @id
  name         String
  createdAt    DateTime               @default(now())
  type         OrgType                @default(COMPANY)
  addressLine1 String?
  addressLine2 String?
  city         String?
  region       String?
  postalCode   String?
  countryCode  String?
  lat          Float?
  lng          Float?
  legalName    String?
  logoUrl      String?
  phone        String?
  primaryEmail String?
  serviceArea  Json?
  slug         String?
  timezone     String?
  websiteUrl   String?
  invitations  Invitation[]
  members      OrganizationMember[]
  projects     Project[]
  customers    OrganizationCustomer[]
}

model OrganizationMember {
  id           String       @id @default(uuid())
  userId       String
  orgId        String
  role         OrgRole
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([userId, orgId])
}

model Media {
  id        String    @id @default(cuid())
  projectId String
  key       String
  cdnUrl    String?
  filename  String
  size      Int
  type      MediaType
  createdAt DateTime  @default(now())
  project   Project   @relation(fields: [projectId], references: [id])
}

model Message {
  id        String             @id @default(uuid())
  projectId String
  userId    String
  content   String
  timestamp DateTime           @default(now())
  channel   ProjectChatChannel @default(TEAM)
  thread    String?
  project   Project            @relation(fields: [projectId], references: [id])
  user      User               @relation(fields: [userId], references: [id])
}

enum ProjectChatChannel {
  TEAM
  CUSTOMER
}

model Project {
  id               String                @id @default(uuid())
  addressLine1     String?
  addressLine2     String?
  city             String?
  region           String?
  postalCode       String?
  countryCode      String?
  lat              Float?
  lng              Float?
  notes            String?
  scheduledTime    DateTime
  status           ProjectStatus         @default(BOOKED)
  technicianId     String?
  editorId         String?
  projectManagerId String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  orgId            String
  customerId       String?
  calendarEvent    CalendarEvent?
  media            Media[]
  messages         Message[]
  editor           User?                 @relation("EditorProjects", fields: [editorId], references: [id])
  organization     Organization          @relation(fields: [orgId], references: [id])
  technician       User?                 @relation("TechProjects", fields: [technicianId], references: [id])
  projectManager   User?                 @relation("ManagerProjects", fields: [projectManagerId], references: [id])
  customer         OrganizationCustomer? @relation(fields: [customerId], references: [id])
}

model OrganizationCustomer {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  email     String?
  phone     String?
  notes     String?
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  user         User?        @relation(fields: [userId], references: [id])
  projects     Project[]
}

model Inquiry {
  id        String        @id @default(uuid())
  name      String
  email     String
  phone     String?
  address   String?
  message   String?
  status    InquiryStatus @default(PENDING)
  createdAt DateTime      @default(now())
}

model CalendarEvent {
  id             String   @id @default(uuid())
  projectId      String   @unique
  cronofyEventId String
  calendarId     String
  createdAt      DateTime @default(now())
  project        Project  @relation(fields: [projectId], references: [id])
}

model Invitation {
  id           String       @id @default(uuid())
  email        String
  orgId        String
  role         OrgRole
  token        String       @unique
  accepted     Boolean      @default(false)
  createdAt    DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id])
}

enum UserAccountType {
  AGENT
  PROVIDER
  COMPANY
}

enum OrgRole {
  OWNER
  ADMIN
  TECHNICIAN
  EDITOR
  PROJECT_MANAGER
}

enum OrgType {
  COMPANY
  PERSONAL
}

enum MediaType {
  PHOTO
  VIDEO
  FLOORPLAN
  DOCUMENT
}

enum ProjectStatus {
  BOOKED
  SHOOTING
  EDITING
  DELIVERED
}

enum InquiryStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
  CONVERTED_TO_PROJECT
}
