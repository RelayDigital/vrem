'use client';

import { useEffect, useRef, useState } from 'react';
import { JobRequest, Photographer } from '../../../types';
import { MapPin, Camera, Home, AlertCircle, User, Building2 } from 'lucide-react';
import { Small, Muted } from '../../ui/typography';

interface MapViewProps {
  jobs: JobRequest[];
  photographers: Photographer[];
  selectedJob?: JobRequest | null;
  selectedPhotographer?: Photographer | null;
}

// Declare global google types
declare global {
  interface Window {
    google: typeof google;
    initGoogleMaps: () => void;
  }
}

export function MapView({ jobs, photographers, selectedJob, selectedPhotographer }: MapViewProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const polylineRef = useRef<google.maps.Polyline | null>(null);
  const animationIntervalRef = useRef<NodeJS.Timeout | null>(null);
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [markers, setMarkers] = useState<google.maps.Marker[]>([]);
  const [infoWindows, setInfoWindows] = useState<google.maps.InfoWindow[]>([]);
  const [isGoogleLoaded, setIsGoogleLoaded] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Load Google Maps API
  useEffect(() => {
    const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY;
    
    if (!apiKey) {
      setError('Google Maps API key not configured');
      console.warn('Please add NEXT_PUBLIC_GOOGLE_MAPS_API_KEY to your .env.local file');
      return;
    }

    // Check if already loaded
    if (window.google && window.google.maps) {
      setIsGoogleLoaded(true);
      return;
    }

    // Load Google Maps script
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initGoogleMaps`;
    script.async = true;
    script.defer = true;

    window.initGoogleMaps = () => {
      setIsGoogleLoaded(true);
      setError(null);
    };

    script.onerror = () => {
      setError('Failed to load Google Maps');
      console.error('Error loading Google Maps script');
    };

    document.head.appendChild(script);

    return () => {
      if (window.initGoogleMaps) {
        window.initGoogleMaps = () => {};
      }
    };
  }, []);

  // Initialize map
  useEffect(() => {
    if (!isGoogleLoaded || !mapRef.current || !window.google) return;

    const googleMap = new window.google.maps.Map(mapRef.current, {
      mapTypeControl: true,
      streetViewControl: false,
      fullscreenControl: true,
      styles: [
        {
          featureType: 'poi',
          elementType: 'labels',
          stylers: [{ visibility: 'off' }],
        },
      ],
    });

    setMap(googleMap);
  }, [isGoogleLoaded]);

  // Create markers for jobs and photographers
  useEffect(() => {
    if (!map || !window.google) return;

    // Clear existing markers and info windows
    markers.forEach((marker) => marker.setMap(null));
    infoWindows.forEach((infoWindow) => infoWindow.close());
    
    const newMarkers: google.maps.Marker[] = [];
    const newInfoWindows: google.maps.InfoWindow[] = [];
    const bounds = new window.google.maps.LatLngBounds();
    
    // Track the currently open info window
    let currentlyOpenInfoWindow: google.maps.InfoWindow | null = null;

    // Create markers for jobs
  const pendingJobs = jobs.filter((j) => j.status === 'pending');
    const assignedJobs = jobs.filter((j) => j.status === 'assigned' || j.status === 'in_progress');
    const otherJobs = jobs.filter((j) => !['pending', 'assigned', 'in_progress'].includes(j.status));

    // Helper function to create icon from Lucide icon as SVG data URL with circular background
    const createIconFromLucide = (iconComponent: typeof Building2 | typeof User, color: string, size: number = 32) => {
      // Create a temporary container to render the icon
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', size.toString());
      svg.setAttribute('height', size.toString());
      svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
      svg.setAttribute('fill', 'none');
      
      // Create circular background
      const circleBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circleBg.setAttribute('cx', (size / 2).toString());
      circleBg.setAttribute('cy', (size / 2).toString());
      circleBg.setAttribute('r', ((size - 4) / 2).toString());
      circleBg.setAttribute('fill', color);
      circleBg.setAttribute('stroke', '#ffffff');
      circleBg.setAttribute('stroke-width', '2.5');
      svg.appendChild(circleBg);
      
      // Create a group for the icon, scaled and centered
      const iconGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      const iconSize = size * 0.5; // Icon is 50% of the circle size
      const iconOffset = (size - iconSize) / 2;
      iconGroup.setAttribute('transform', `translate(${iconOffset}, ${iconOffset}) scale(${iconSize / 24})`);
      iconGroup.setAttribute('stroke', '#ffffff');
      iconGroup.setAttribute('stroke-width', '2');
      iconGroup.setAttribute('stroke-linecap', 'round');
      iconGroup.setAttribute('stroke-linejoin', 'round');
      iconGroup.setAttribute('fill', 'none');
      
      // Building2 icon path (from Lucide)
      if (iconComponent === Building2) {
        const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path1.setAttribute('d', 'M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z');
        path1.setAttribute('fill', '#ffffff');
        path1.setAttribute('fill-opacity', '0.9');
        iconGroup.appendChild(path1);
        const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path2.setAttribute('d', 'M6 12h12');
        iconGroup.appendChild(path2);
        const path3 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path3.setAttribute('d', 'M6 20h12');
        iconGroup.appendChild(path3);
        const path4 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path4.setAttribute('d', 'M10 6h4');
        iconGroup.appendChild(path4);
        const path5 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path5.setAttribute('d', 'M10 8h4');
        iconGroup.appendChild(path5);
        const path6 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path6.setAttribute('d', 'M10 16h4');
        iconGroup.appendChild(path6);
      } 
      // User icon path (from Lucide)
      else if (iconComponent === User) {
        const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path1.setAttribute('d', 'M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2');
        iconGroup.appendChild(path1);
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '7');
        circle.setAttribute('r', '4');
        iconGroup.appendChild(circle);
      }
      
      svg.appendChild(iconGroup);
      
      const svgString = new XMLSerializer().serializeToString(svg);
      const base64 = btoa(unescape(encodeURIComponent(svgString)));
      const dataUrl = `data:image/svg+xml;base64,${base64}`;
      
      return {
        url: dataUrl,
        scaledSize: new window.google.maps.Size(size, size),
        anchor: new window.google.maps.Point(size / 2, size / 2),
      };
    };

    // Helper function to create building icon using Lucide Building2
    const createBuildingIcon = (color: string) => {
      return createIconFromLucide(Building2, color, 32);
    };

    // Helper function to create person icon using Lucide User
    const createPersonIcon = (color: string) => {
      return createIconFromLucide(User, color, 32);
    };

    // Pending jobs (red)
    pendingJobs.forEach((job) => {
      const position = { lat: job.location.lat, lng: job.location.lng };
      bounds.extend(position);

      const marker = new window.google.maps.Marker({
        position,
        map,
        icon: createBuildingIcon('#ef4444'),
        title: job.propertyAddress,
        zIndex: selectedJob?.id === job.id ? 1000 : 10,
      });

      const isSelected = selectedJob?.id === job.id;
      if (isSelected) {
        marker.setAnimation(window.google.maps.Animation.BOUNCE);
        setTimeout(() => marker.setAnimation(null), 2000);
      }

      const priorityColors: Record<string, string> = {
        urgent: '#ef4444',
        rush: '#f59e0b',
        standard: '#6b7280',
      };

      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="padding: 0; min-width: 280px; max-width: 320px;">
            ${job.propertyImage ? `
              <img src="${job.propertyImage}" alt="${job.propertyAddress}" style="width: 100%; height: 150px; object-fit: cover;" />
            ` : ''}
            <div style="padding: 12px;">
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                <span style="padding: 4px 10px; background: #fee2e2; color: #991b1b; border-radius: 6px; font-size: 11px; font-weight: 500;">
                  Pending
                </span>
                <span style="padding: 4px 10px; background: ${priorityColors[job.priority] === '#ef4444' ? '#fee2e2' : priorityColors[job.priority] === '#f59e0b' ? '#fef3c7' : '#f3f4f6'}; color: ${priorityColors[job.priority]}; border-radius: 6px; font-size: 11px; font-weight: 500; text-transform: capitalize;">
                  ${job.priority}
                </span>
              </div>
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                <strong>Client:</strong> ${job.clientName}
              </div>
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                <strong>Schedule:</strong> ${job.scheduledDate} at ${job.scheduledTime}
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                ${job.mediaType.map((type) => `
                  <span style="padding: 4px 10px; background: #f3f4f6; border-radius: 6px; font-size: 11px; color: #374151; text-transform: capitalize;">
                    ${type}
                  </span>
                `).join('')}
              </div>
              ${job.estimatedDuration ? `
                <div style="font-size: 12px; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                  Duration: ${job.estimatedDuration} minutes
                </div>
              ` : ''}
            </div>
          </div>
        `,
      });

      marker.addListener('click', () => {
        // Close the currently open info window if any
        if (currentlyOpenInfoWindow) {
          currentlyOpenInfoWindow.close();
        }
        // Open the clicked marker's info window
        infoWindow.open(map, marker);
        // Update the reference to the currently open info window
        currentlyOpenInfoWindow = infoWindow;
        
        // Inject title into Google Maps header area
        setTimeout(() => {
          const headerContent = document.querySelector('.gm-style-iw-ch') as HTMLElement;
          if (headerContent && !headerContent.querySelector('.custom-title')) {
            // Clear any existing content
            headerContent.innerHTML = '';
            const titleDiv = document.createElement('div');
            titleDiv.className = 'custom-title';
            titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; color: #1f2937; line-height: 1.3; padding: 0; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            titleDiv.textContent = job.propertyAddress;
            headerContent.appendChild(titleDiv);
          }
        }, 100);
      });

      newMarkers.push(marker);
      newInfoWindows.push(infoWindow);
    });

    // Assigned/In Progress jobs (blue)
    assignedJobs.forEach((job) => {
      const position = { lat: job.location.lat, lng: job.location.lng };
      bounds.extend(position);

      const marker = new window.google.maps.Marker({
        position,
        map,
        icon: createBuildingIcon('#3b82f6'),
        title: job.propertyAddress,
        zIndex: selectedJob?.id === job.id ? 1000 : 20,
      });

      const isSelected = selectedJob?.id === job.id;
      if (isSelected) {
        marker.setAnimation(window.google.maps.Animation.BOUNCE);
        setTimeout(() => marker.setAnimation(null), 2000);
      }

      const assignedPhotographer = photographers.find((p) => p.id === job.assignedPhotographerId);
      const priorityColors: Record<string, string> = {
        urgent: '#ef4444',
        rush: '#f59e0b',
        standard: '#6b7280',
      };

      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="padding: 0; min-width: 280px; max-width: 320px;">
            ${job.propertyImage ? `
              <img src="${job.propertyImage}" alt="${job.propertyAddress}" style="width: 100%; height: 150px; object-fit: cover;" />
            ` : ''}
            <div style="padding: 12px;">
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                <span style="padding: 4px 10px; background: #dbeafe; color: #1e40af; border-radius: 6px; font-size: 11px; font-weight: 500;">
                  ${job.status === 'in_progress' ? 'In Progress' : 'Assigned'}
                </span>
                <span style="padding: 4px 10px; background: ${priorityColors[job.priority] === '#ef4444' ? '#fee2e2' : priorityColors[job.priority] === '#f59e0b' ? '#fef3c7' : '#f3f4f6'}; color: ${priorityColors[job.priority]}; border-radius: 6px; font-size: 11px; font-weight: 500; text-transform: capitalize;">
                  ${job.priority}
                </span>
              </div>
              ${assignedPhotographer ? `
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                  <strong>Photographer:</strong> ${assignedPhotographer.name}
                </div>
              ` : ''}
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                <strong>Client:</strong> ${job.clientName}
              </div>
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                <strong>Schedule:</strong> ${job.scheduledDate} at ${job.scheduledTime}
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                ${job.mediaType.map((type) => `
                  <span style="padding: 4px 10px; background: #f3f4f6; border-radius: 6px; font-size: 11px; color: #374151; text-transform: capitalize;">
                    ${type}
                  </span>
                `).join('')}
              </div>
              ${job.estimatedDuration ? `
                <div style="font-size: 12px; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                  Duration: ${job.estimatedDuration} minutes
                </div>
              ` : ''}
            </div>
          </div>
        `,
      });

      marker.addListener('click', () => {
        // Close the currently open info window if any
        if (currentlyOpenInfoWindow) {
          currentlyOpenInfoWindow.close();
        }
        // Open the clicked marker's info window
        infoWindow.open(map, marker);
        // Update the reference to the currently open info window
        currentlyOpenInfoWindow = infoWindow;
        
        // Inject title into Google Maps header area
        setTimeout(() => {
          const headerContent = document.querySelector('.gm-style-iw-ch') as HTMLElement;
          if (headerContent && !headerContent.querySelector('.custom-title')) {
            // Clear any existing content
            headerContent.innerHTML = '';
            const titleDiv = document.createElement('div');
            titleDiv.className = 'custom-title';
            titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; color: #1f2937; line-height: 1.3; padding: 0; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            titleDiv.textContent = job.propertyAddress;
            headerContent.appendChild(titleDiv);
          }
        }, 100);
      });

      newMarkers.push(marker);
      newInfoWindows.push(infoWindow);
    });

    // Other jobs (gray)
    otherJobs.forEach((job) => {
      const position = { lat: job.location.lat, lng: job.location.lng };
      bounds.extend(position);

      const marker = new window.google.maps.Marker({
        position,
        map,
        icon: createBuildingIcon('#9ca3af'),
        title: job.propertyAddress,
        zIndex: 5,
      });

      const priorityColors: Record<string, string> = {
        urgent: '#ef4444',
        rush: '#f59e0b',
        standard: '#6b7280',
      };

      const statusColors: Record<string, { bg: string; color: string }> = {
        delivered: { bg: '#d1fae5', color: '#065f46' },
        cancelled: { bg: '#fee2e2', color: '#991b1b' },
        editing: { bg: '#fef3c7', color: '#92400e' },
      };

      const statusConfig = statusColors[job.status] || { bg: '#f3f4f6', color: '#374151' };

      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="padding: 0; min-width: 280px; max-width: 320px;">
            ${job.propertyImage ? `
              <img src="${job.propertyImage}" alt="${job.propertyAddress}" style="width: 100%; height: 150px; object-fit: cover;" />
            ` : ''}
            <div style="padding: 12px;">
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                <span style="padding: 4px 10px; background: ${statusConfig.bg}; color: ${statusConfig.color}; border-radius: 6px; font-size: 11px; font-weight: 500; text-transform: capitalize;">
                  ${job.status}
                </span>
                <span style="padding: 4px 10px; background: ${priorityColors[job.priority] === '#ef4444' ? '#fee2e2' : priorityColors[job.priority] === '#f59e0b' ? '#fef3c7' : '#f3f4f6'}; color: ${priorityColors[job.priority]}; border-radius: 6px; font-size: 11px; font-weight: 500; text-transform: capitalize;">
                  ${job.priority}
                </span>
              </div>
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                <strong>Client:</strong> ${job.clientName}
              </div>
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                <strong>Schedule:</strong> ${job.scheduledDate} at ${job.scheduledTime}
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                ${job.mediaType.map((type) => `
                  <span style="padding: 4px 10px; background: #f3f4f6; border-radius: 6px; font-size: 11px; color: #374151; text-transform: capitalize;">
                    ${type}
                  </span>
                `).join('')}
              </div>
              ${job.estimatedDuration ? `
                <div style="font-size: 12px; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                  Duration: ${job.estimatedDuration} minutes
                </div>
              ` : ''}
            </div>
          </div>
        `,
      });

      marker.addListener('click', () => {
        // Close the currently open info window if any
        if (currentlyOpenInfoWindow) {
          currentlyOpenInfoWindow.close();
        }
        // Open the clicked marker's info window
        infoWindow.open(map, marker);
        // Update the reference to the currently open info window
        currentlyOpenInfoWindow = infoWindow;
        
        // Inject title into Google Maps header area
        setTimeout(() => {
          const headerContent = document.querySelector('.gm-style-iw-ch') as HTMLElement;
          if (headerContent && !headerContent.querySelector('.custom-title')) {
            // Clear any existing content
            headerContent.innerHTML = '';
            const titleDiv = document.createElement('div');
            titleDiv.className = 'custom-title';
            titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; color: #1f2937; line-height: 1.3; padding: 0; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            titleDiv.textContent = job.propertyAddress;
            headerContent.appendChild(titleDiv);
          }
        }, 100);
      });

      newMarkers.push(marker);
      newInfoWindows.push(infoWindow);
    });

    // Create markers for photographers
    photographers.forEach((photographer) => {
      const position = {
        lat: photographer.homeLocation.lat,
        lng: photographer.homeLocation.lng,
      };
      bounds.extend(position);

      // Check availability (using today's date as example)
      const today = new Date().toISOString().split('T')[0];
      const isAvailable =
        photographer.availability.find((a) => a.date === today)?.available || false;

      const marker = new window.google.maps.Marker({
        position,
        map,
        icon: createPersonIcon(isAvailable ? '#22c55e' : '#9ca3af'),
        title: `${photographer.name} - ${photographer.homeLocation.address}`,
        zIndex: 15,
      });

      const infoWindow = new window.google.maps.InfoWindow({
        content: `
          <div style="padding: 0; min-width: 280px; max-width: 320px;">
            <div style="padding: 12px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                ${photographer.avatar ? `
                  <img src="${photographer.avatar}" alt="${photographer.name}" style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid ${isAvailable ? '#22c55e' : '#9ca3af'};" />
                ` : `
                  <div style="width: 56px; height: 56px; border-radius: 50%; background: ${isAvailable ? '#d1fae5' : '#f3f4f6'}; display: flex; align-items: center; justify-content: center; border: 2px solid ${isAvailable ? '#22c55e' : '#9ca3af'}; color: ${isAvailable ? '#065f46' : '#6b7280'}; font-weight: 600; font-size: 20px;">
                    ${photographer.name.split(' ').map(n => n[0]).join('')}
                  </div>
                `}
                <div style="flex: 1;">
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="padding: 4px 10px; background: ${isAvailable ? '#d1fae5' : '#f3f4f6'}; color: ${isAvailable ? '#065f46' : '#6b7280'}; border-radius: 6px; font-size: 11px; font-weight: 500;">
                      ${isAvailable ? 'Available' : 'Unavailable'}
                    </span>
                    ${photographer.rating.overall ? `
                      <span style="padding: 4px 10px; background: #fef3c7; color: #92400e; border-radius: 6px; font-size: 11px; font-weight: 500;">
                        ‚≠ê ${photographer.rating.overall}
                      </span>
                    ` : ''}
                  </div>
                </div>
              </div>
              <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                <strong>Location:</strong> ${photographer.homeLocation.address}
              </div>
              ${photographer.companyName ? `
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                  <strong>Company:</strong> ${photographer.companyName}
                </div>
              ` : photographer.isIndependent ? `
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                  <strong>Status:</strong> Independent
                </div>
              ` : ''}
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <div style="text-align: center;">
                  <div style="font-size: 18px; font-weight: 600; color: #1f2937;">${photographer.reliability.totalJobs}</div>
                  <div style="font-size: 11px; color: #6b7280;">Jobs</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 18px; font-weight: 600; color: #1f2937;">${(photographer.reliability.onTimeRate * 100).toFixed(0)}%</div>
                  <div style="font-size: 11px; color: #6b7280;">On-Time</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 18px; font-weight: 600; color: #1f2937;">${photographer.rating.overall}</div>
                  <div style="font-size: 11px; color: #6b7280;">Rating</div>
                </div>
              </div>
              ${photographer.bio ? `
                <div style="font-size: 12px; color: #6b7280; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; line-height: 1.5;">
                  ${photographer.bio}
                </div>
              ` : ''}
            </div>
          </div>
        `,
      });

      marker.addListener('click', () => {
        // Close the currently open info window if any
        if (currentlyOpenInfoWindow) {
          currentlyOpenInfoWindow.close();
        }
        // Open the clicked marker's info window
        infoWindow.open(map, marker);
        // Update the reference to the currently open info window
        currentlyOpenInfoWindow = infoWindow;
        
        // Inject title into Google Maps header area
        setTimeout(() => {
          const headerContent = document.querySelector('.gm-style-iw-ch') as HTMLElement;
          if (headerContent && !headerContent.querySelector('.custom-title')) {
            // Clear any existing content
            headerContent.innerHTML = '';
            const titleDiv = document.createElement('div');
            titleDiv.className = 'custom-title';
            titleDiv.style.cssText = 'font-weight: 600; font-size: 16px; color: #1f2937; line-height: 1.3; padding: 0; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            titleDiv.textContent = photographer.name;
            headerContent.appendChild(titleDiv);
          }
        }, 100);
      });

      newMarkers.push(marker);
      newInfoWindows.push(infoWindow);
    });

    // Fit bounds to show all markers with padding
    if (newMarkers.length > 0) {
      // Check if bounds are valid (not all points at same location)
      const ne = bounds.getNorthEast();
      const sw = bounds.getSouthWest();
      if (ne.lat() !== sw.lat() || ne.lng() !== sw.lng()) {
        map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
      } else {
        // If all markers are at the same location, center and zoom
        const firstMarker = newMarkers[0];
        const position = firstMarker.getPosition();
        if (position) {
          map.setCenter(position);
          map.setZoom(15);
        }
      }
    }

    setMarkers(newMarkers);
    setInfoWindows(newInfoWindows);

    // Cleanup function
    return () => {
      newMarkers.forEach((marker) => marker.setMap(null));
      newInfoWindows.forEach((infoWindow) => infoWindow.close());
    };
  }, [map, jobs, photographers, selectedJob, isGoogleLoaded]);

  // Draw polyline from selected photographer to job location using Directions Service
  useEffect(() => {
    if (!map || !window.google || !selectedPhotographer || !selectedJob) {
      // Clear existing polyline if photographer or job is deselected
      if (polylineRef.current) {
        polylineRef.current.setMap(null);
        polylineRef.current = null;
      }
      return;
    }

    const photographerPosition = new window.google.maps.LatLng(
      selectedPhotographer.homeLocation.lat,
      selectedPhotographer.homeLocation.lng
    );
    const jobPosition = new window.google.maps.LatLng(
      selectedJob.location.lat,
      selectedJob.location.lng
    );

    // Use Directions Service to get route following roads
    const directionsService = new window.google.maps.DirectionsService();

    directionsService.route(
      {
        origin: photographerPosition,
        destination: jobPosition,
        travelMode: window.google.maps.TravelMode.DRIVING,
      },
      (result, status) => {
        if (status === window.google.maps.DirectionsStatus.OK && result) {
          // Clear existing polyline
          if (polylineRef.current) {
            polylineRef.current.setMap(null);
            polylineRef.current = null;
          }

          // Extract the route path from the directions result
          const route = result.routes[0];
          if (route && route.overview_path) {
            // Create base polyline with solid stroke
            const newPolyline = new window.google.maps.Polyline({
              path: route.overview_path,
              geodesic: true,
              strokeColor: '#3b82f6',
              strokeOpacity: 0.8,
              strokeWeight: 5,
            });

            newPolyline.setMap(map);
            polylineRef.current = newPolyline;

            // Create occasional rippling effect - ripple appears and travels along the line
            let rippleOffset = 0;
            let rippleOpacity = 0;
            let lastRippleTime = Date.now();
            const rippleInterval = 2000; // Create new ripple every 2 seconds

            const animateRipple = () => {
              if (!polylineRef.current) return;
              
              const now = Date.now();
              
              // Create a new ripple every 2 seconds
              if (now - lastRippleTime >= rippleInterval) {
                rippleOffset = 0;
                rippleOpacity = 1;
                lastRippleTime = now;
              }
              
              // Animate existing ripple
              if (rippleOpacity > 0) {
                rippleOffset = (rippleOffset + 1.2) % 100;
                rippleOpacity = Math.max(0, rippleOpacity - 0.015);
                
                // Create ripple effect with bright segment that fades
                const icons: google.maps.IconSequence[] = [
                  {
                    icon: {
                      path: 'M 0,-5 0,5',
                      strokeColor: '#ffffff',
                      strokeOpacity: rippleOpacity,
                      strokeWeight: 8,
                      scale: 1,
                    },
                    offset: `${rippleOffset}%`,
                    repeat: '500px',
                  },
                ];

                polylineRef.current.setOptions({ icons });
              } else {
                // No ripple - just solid line
                polylineRef.current.setOptions({ icons: [] });
              }
            };

            // Start animation - update every 20ms
            if (animationIntervalRef.current) {
              clearInterval(animationIntervalRef.current);
            }
            animationIntervalRef.current = setInterval(animateRipple, 20);

            // Fit bounds to show the entire route
            const bounds = new window.google.maps.LatLngBounds();
            route.overview_path.forEach((point) => {
              bounds.extend(point);
            });
            map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
          }
        } else {
          console.error('Directions request failed:', status);
          // Fallback to straight line if directions fail
          if (polylineRef.current) {
            polylineRef.current.setMap(null);
            polylineRef.current = null;
          }

          const fallbackPolyline = new window.google.maps.Polyline({
            path: [photographerPosition, jobPosition],
            geodesic: true,
            strokeColor: '#3b82f6',
            strokeOpacity: 0.8,
            strokeWeight: 3,
          });

          fallbackPolyline.setMap(map);
          polylineRef.current = fallbackPolyline;

          const bounds = new window.google.maps.LatLngBounds();
          bounds.extend(photographerPosition);
          bounds.extend(jobPosition);
          map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
        }
      }
    );

    // Cleanup function
    return () => {
      if (animationIntervalRef.current) {
        clearInterval(animationIntervalRef.current);
        animationIntervalRef.current = null;
      }
      if (polylineRef.current) {
        polylineRef.current.setMap(null);
        polylineRef.current = null;
      }
    };
  }, [map, selectedPhotographer?.id, selectedJob?.id]);

  if (error) {
  return (
      <div className="flex items-center justify-center h-full bg-muted/50 rounded-lg">
        <div className="text-center p-6">
          <AlertCircle className="h-8 w-8 text-destructive mx-auto mb-2" />
          <Muted>{error}</Muted>
        </div>
      </div>
    );
  }

  if (!isGoogleLoaded) {
            return (
      <div className="flex items-center justify-center h-full bg-muted/50 rounded-lg">
        <div className="text-center p-6">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2" />
          <Muted>Loading map...</Muted>
        </div>
      </div>
    );
  }

          return (
    <div className="relative w-full h-full">
      <div ref={mapRef} className="w-full h-full" />

      {/* Legend */}
      <div className="absolute bottom-4 left-4 bg-card/95 backdrop-blur-sm rounded-lg p-3 shadow-lg border border-border z-10">
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-red-500 border-2 border-white" />
            <Small className="text-muted-foreground">Pending Jobs ({jobs.filter((j) => j.status === 'pending').length})</Small>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-blue-500 border-2 border-white" />
            <Small className="text-muted-foreground">Assigned/In Progress</Small>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-emerald-500 border-2 border-white" />
            <Small className="text-muted-foreground">Available Photographers</Small>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-gray-400 border-2 border-white" />
            <Small className="text-muted-foreground">Unavailable</Small>
          </div>
        </div>
      </div>
    </div>
  );
}

