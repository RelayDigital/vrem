"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1382],{7235:(e,s,t)=>{t.d(s,{d:()=>n});var r=t(95155);t(12115);var a=t(27599),l=t(25016);function n(e){let{className:s,...t}=e;return(0,r.jsx)(a.bL,{"data-slot":"switch",className:(0,l.cn)("peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:(0,r.jsx)(a.zi,{"data-slot":"switch-thumb",className:(0,l.cn)("bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0")})})}},24632:(e,s,t)=>{t.d(s,{l:()=>d});var r=t(12115),a=t(20063),l=t(65939),n=t(75701),i=t(80408);function d(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=(0,a.useRouter)(),{user:d,isLoading:o,activeOrganizationId:c,memberships:u}=(0,l.A)(),{redirectTo:m,enforceRedirect:x}=s,h=(0,r.useCallback)(()=>(0,n.in)(u,c),[u,c]);return(0,r.useEffect)(()=>{if(o)return;if(!d)return void t.push("/");let s=e.map(e=>(0,i.FK)(e)),r=(0,i.FK)(d.accountType),a=u.find(e=>e.orgId===c),l=(0,n.hq)(a,r);if(!s.includes(l)){if(!1===x)return;if(m)t.push(m);else{let e=(0,n.zE)(l);t.push(e)}}},[d,o,e,t,m,x,u,c]),{user:d,organizationId:c,memberships:u,isLoading:o,getActiveOrgRole:h}}},35722:(e,s,t)=>{t.d(s,{NV:()=>d,ft:()=>n});var r=t(95657);let a={lat:51.0447,lng:-114.0719},l=new Map;async function n(e){let s="pk.eyJ1IjoiZHVyb2RwIiwiYSI6ImNtaHplcW53cDA4dHQycnB6dnhqeGtveXgifQ.6GR-s3V7vfGRsoVlhSTFhg";if(!s||!e)return null;try{var t,r;let a="https://api.mapbox.com/geocoding/v5/mapbox.places/".concat(encodeURIComponent(e),".json?access_token=").concat(s,"&limit=1"),l=await fetch(a);if(!l.ok)return null;let n=await l.json(),i=null==n||null==(t=n.features)?void 0:t[0];if((null==i||null==(r=i.center)?void 0:r.length)===2){let[e,s]=i.center;return{lat:s,lng:e}}}catch(e){console.error("Failed to geocode address",e)}return null}async function i(e){if(!e.user)return null;let s=e.user,t=e.personalOrg,r=t?[t.addressLine1,t.addressLine2,t.city,t.region,t.postalCode,t.countryCode].filter(Boolean).join(", "):"",i=(null==t?void 0:t.lat)!==void 0&&(null==t?void 0:t.lng)!==void 0?{lat:t.lat,lng:t.lng}:a;if(r){let e=l.get(r);if(e)i=e;else{let e=await n(r);e&&(i=e,l.set(r,e))}}return{id:s.id,userId:s.id,orgMemberId:e.id,orgId:e.orgId,memberId:e.id,role:e.role||e.orgRole||"TECHNICIAN",name:s.name||"Unnamed",email:s.email||"",phone:(null==t?void 0:t.phone)||"",organizationId:s.organizationId||void 0,isIndependent:!0,companyId:void 0,companyName:void 0,homeLocation:{lat:i.lat,lng:i.lng,address:{street:(null==t?void 0:t.addressLine1)||"",city:(null==t?void 0:t.city)||"",stateProvince:(null==t?void 0:t.region)||"",country:(null==t?void 0:t.countryCode)||"",postalCode:(null==t?void 0:t.postalCode)||""}},availability:[],reliability:{totalJobs:0,noShows:0,lateDeliveries:0,onTimeRate:0,averageDeliveryTime:0},skills:{residential:0,commercial:0,aerial:0,twilight:0,video:0},rating:{overall:0,count:0,recent:[]},preferredClients:[],status:"active",createdAt:e.createdAt?new Date(e.createdAt):new Date,avatar:s.avatarUrl,bio:"",services:{photography:!0,video:!1,aerial:!1,floorplan:!1,measurement:!1,twilight:!1,editing:!1,virtualStaging:!1},portfolio:[],certifications:[]}}async function d(){let e=await r.F.organizations.listMembers();return e&&0!==e.length?(await Promise.all(e.map(e=>i(e)))).filter(e=>!!e):[]}},37119:(e,s,t)=>{t.d(s,{m:()=>eq});var r=t(95155),a=t(12115),l=t(154),n=t(10699),i=t(77004),d=t(43419),o=t(56135),c=t(61771),u=t(31856),m=t(54679),x=t(67812),h=t(97003),g=t(68122),p=t(54664),f=t(33884),v=t(65229),j=t(95664),b=t(60890),N=t(54255),y=t(26397),w=t(42196),k=t(89715),C=t(39068),A=t(92001),M=t(35299),E=t(50859),I=t(37354),T=t(71360),z=t(69152),S=t(37772),D=t(4861),R=t(51860),_=t(7620),U=t(91169),P=t(37586),F=t(20508),L=t(11010),O=t(27937),$=t(21873),B=t(93499),q=t(61362),H=t(1084),G=t(67048),J=t(44615),V=t(3829),K=t(69602),Z=t(80003),Q=t(97239),W=t(55423),Y=t(9602),X=t(5789),ee=t(16485),es=t(26983),et=t(71163),er=t(18720),ea=t(73344),el=t(82180),en=t(20120),ei=t(7220),ed=t(97450),eo=t(27346),ec=t(30275),eu=t(64936),em=t(14099);t(64458);var ex=t(32467),eh=t(83101),eg=t(25016);let ep=(0,eh.F)("group/item flex items-center border border-transparent text-sm rounded-md transition-colors [a]:hover:bg-accent/50 [a]:transition-colors duration-100 flex-wrap outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",{variants:{variant:{default:"bg-transparent",outline:"border-border",muted:"bg-muted/50"},size:{default:"p-4 gap-4 ",sm:"py-3 px-4 gap-2.5"}},defaultVariants:{variant:"default",size:"default"}});function ef(e){let{className:s,variant:t="default",size:a="default",asChild:l=!1,...n}=e,i=l?ex.DX:"div";return(0,r.jsx)(i,{"data-slot":"item","data-variant":t,"data-size":a,className:(0,eg.cn)(ep({variant:t,size:a,className:s})),...n})}let ev=(0,eh.F)("flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none group-has-[[data-slot=item-description]]/item:translate-y-0.5",{variants:{variant:{default:"bg-transparent",icon:"size-8 border rounded-sm bg-muted [&_svg:not([class*='size-'])]:size-4",image:"size-10 rounded-sm overflow-hidden [&_img]:size-full [&_img]:object-cover"}},defaultVariants:{variant:"default"}});function ej(e){let{className:s,variant:t="default",...a}=e;return(0,r.jsx)("div",{"data-slot":"item-media","data-variant":t,className:(0,eg.cn)(ev({variant:t,className:s})),...a})}function eb(e){let{className:s,...t}=e;return(0,r.jsx)("div",{"data-slot":"item-content",className:(0,eg.cn)("flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none",s),...t})}function eN(e){let{className:s,...t}=e;return(0,r.jsx)("div",{"data-slot":"item-title",className:(0,eg.cn)("flex w-fit items-center gap-2 text-sm leading-snug font-medium",s),...t})}function ey(e){let{className:s,...t}=e;return(0,r.jsx)("p",{"data-slot":"item-description",className:(0,eg.cn)("text-muted-foreground line-clamp-2 text-sm leading-normal font-normal text-balance","[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",s),...t})}function ew(e){let{className:s,...t}=e;return(0,r.jsx)("div",{"data-slot":"item-actions",className:(0,eg.cn)("flex items-center gap-2",s),...t})}var ek=t(90923),eC=t(51539),eA=t(33789),eM=t(95657),eE=t(35722),eI=t(7235),eT=t(6132),ez=t(5917),eS=t(75426),eD=t(4788),eR=t(89559),e_=t(30924);let eU={PENDING_REVIEW:{label:"Pending Review",color:"text-amber-600",icon:es.A},APPROVED:{label:"Approved",color:"text-green-600",icon:q.A},CHANGES_REQUESTED:{label:"Changes Requested",color:"text-red-600",icon:eT.A}};function eP(e){let{projectId:s,projectStatus:t,canManageDelivery:l,variant:n="inline"}=e,[i,d]=(0,a.useState)(null),[o,c]=(0,a.useState)(!0),[u,m]=(0,a.useState)(!1),[p,f]=(0,a.useState)(!1),[v,j]=(0,a.useState)(!1),[b,N]=(0,a.useState)(!1),[y,w]=(0,a.useState)(!1);(0,a.useEffect)(()=>{(async()=>{try{let e=await eM.F.projectDelivery.getStatus(s);d(e)}catch(e){console.error("Failed to fetch delivery status:",e)}finally{c(!1)}})()},[s]);let k=async()=>{if(i){m(!0);try{let e=await eM.F.projectDelivery.enable(s);d(s=>s?{...s,...e}:null),er.oR.success("Delivery link enabled")}catch(e){console.error("Failed to enable delivery:",e),er.oR.error("Failed to enable delivery")}finally{m(!1)}}},C=async()=>{if(i){m(!0);try{let e=await eM.F.projectDelivery.disable(s);d(s=>s?{...s,...e}:null),er.oR.success("Delivery link disabled"),N(!1)}catch(e){console.error("Failed to disable delivery:",e),er.oR.error("Failed to disable delivery")}finally{m(!1)}}},A=async()=>{if(i){f(!0);try{let e=await eM.F.projectDelivery.regenerateToken(s);d(s=>s?{...s,...e}:null),er.oR.success("Delivery link regenerated. Previous links are now invalid."),w(!1)}catch(e){console.error("Failed to regenerate token:",e),er.oR.error("Failed to regenerate delivery link")}finally{f(!1)}}},E=async()=>{i&&(i.enabled?N(!0):await k())},I=async()=>{if(!(null==i?void 0:i.deliveryToken))return;let e=eM.F.projectDelivery.getDeliveryUrl(i.deliveryToken);try{await navigator.clipboard.writeText(e),j(!0),er.oR.success("Delivery link copied to clipboard"),setTimeout(()=>j(!1),2e3)}catch(e){console.error("Failed to copy:",e),er.oR.error("Failed to copy link")}},T=()=>{if(!(null==i?void 0:i.deliveryToken))return;let e=eM.F.projectDelivery.getDeliveryUrl(i.deliveryToken);window.open(e,"_blank")};if(o)return"inline"===n?(0,r.jsx)(g.E,{className:"h-5 w-24"}):(0,r.jsxs)("div",{className:"rounded-lg border p-4 space-y-3",children:[(0,r.jsx)(g.E,{className:"h-5 w-32"}),(0,r.jsx)(g.E,{className:"h-8 w-full"})]});if(!i)return null;let z=eU[i.clientApprovalStatus],S=z.icon;return"inline"===n?(0,r.jsx)(el.Bc,{children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[l&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(eI.d,{checked:i.enabled,onCheckedChange:E,disabled:u,className:"data-[state=checked]:bg-green-600"}),(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:u?(0,r.jsx)(M.A,{className:"h-3 w-3 animate-spin"}):i.enabled?"Enabled":"Disabled"})]}),i.enabled&&i.deliveryToken&&(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:"h-7 px-2",onClick:I,children:v?(0,r.jsx)(ez.A,{className:"h-3.5 w-3.5 text-green-600"}):(0,r.jsx)(eS.A,{className:"h-3.5 w-3.5"})})}),(0,r.jsx)(el.ZI,{children:"Copy delivery link"})]}),(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:"h-7 px-2",onClick:T,children:(0,r.jsx)(B.A,{className:"h-3.5 w-3.5"})})}),(0,r.jsx)(el.ZI,{children:"Open delivery page"})]}),(0,r.jsxs)(x.E,{variant:"outline",className:(0,eu.cn)("gap-1",z.color),children:[(0,r.jsx)(S,{className:"h-3 w-3"}),(0,r.jsx)("span",{className:"text-xs",children:z.label})]})]}),!i.enabled&&!l&&(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:"Delivery not enabled"})]})}):(0,r.jsxs)(el.Bc,{children:[(0,r.jsxs)("div",{className:"rounded-lg border p-4 space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(eD.A,{className:"h-4 w-4 text-muted-foreground"}),(0,r.jsx)("span",{className:"font-medium",children:"Client Delivery"})]}),l&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:u?(0,r.jsx)(M.A,{className:"h-3 w-3 animate-spin"}):i.enabled?"Enabled":"Disabled"}),(0,r.jsx)(eI.d,{checked:i.enabled,onCheckedChange:E,disabled:u,className:"data-[state=checked]:bg-green-600"})]})]}),i.enabled&&i.deliveryToken&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"flex-1 px-3 py-2 bg-muted rounded-md text-sm font-mono truncate",children:eM.F.projectDelivery.getDeliveryUrl(i.deliveryToken)}),(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"outline",size:"sm",onClick:I,className:"shrink-0",children:v?(0,r.jsx)(ez.A,{className:"h-4 w-4 text-green-600"}):(0,r.jsx)(eS.A,{className:"h-4 w-4"})})}),(0,r.jsx)(el.ZI,{children:"Copy link"})]}),(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"outline",size:"sm",onClick:T,className:"shrink-0",children:(0,r.jsx)(B.A,{className:"h-4 w-4"})})}),(0,r.jsx)(el.ZI,{children:"Open delivery page"})]}),l&&(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"outline",size:"sm",onClick:()=>w(!0),disabled:p,className:"shrink-0",children:p?(0,r.jsx)(M.A,{className:"h-4 w-4 animate-spin"}):(0,r.jsx)(eR.A,{className:"h-4 w-4"})})}),(0,r.jsx)(el.ZI,{children:"Regenerate link"})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between pt-2 border-t",children:[(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:"Client Approval Status"}),(0,r.jsxs)(x.E,{variant:"outline",className:(0,eu.cn)("gap-1.5",z.color),children:[(0,r.jsx)(S,{className:"h-3.5 w-3.5"}),z.label]})]}),"APPROVED"===i.clientApprovalStatus&&i.clientApprovedAt&&i.clientApprovedBy&&(0,r.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Approved by ",i.clientApprovedBy.name," on"," ",new Date(i.clientApprovedAt).toLocaleDateString()]}),"CHANGES_REQUESTED"===i.clientApprovalStatus&&(0,r.jsx)("div",{className:"text-xs text-muted-foreground",children:"Client requested changes"}),"PENDING_REVIEW"===i.clientApprovalStatus&&i.deliveryEnabledAt&&(0,r.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Delivery ready since"," ",new Date(i.deliveryEnabledAt).toLocaleDateString()]})]}),!i.enabled&&(0,r.jsx)("div",{className:"text-sm text-muted-foreground",children:l?"Enable delivery to share media with your client.":"Delivery has not been enabled for this project."})]}),(0,r.jsx)(en.Lt,{open:b,onOpenChange:N,children:(0,r.jsxs)(en.EO,{children:[(0,r.jsxs)(en.wd,{children:[(0,r.jsx)(en.r7,{children:"Disable Delivery Link?"}),(0,r.jsx)(en.$v,{children:"The client will no longer be able to access this delivery page. You can re-enable it at any time."})]}),(0,r.jsxs)(en.ck,{children:[(0,r.jsx)(en.Zr,{disabled:u,children:"Cancel"}),(0,r.jsx)(en.Rx,{onClick:C,disabled:u,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:u?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(M.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Disabling..."]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e_.A,{className:"h-4 w-4 mr-2"}),"Disable"]})})]})]})}),(0,r.jsx)(en.Lt,{open:y,onOpenChange:w,children:(0,r.jsxs)(en.EO,{children:[(0,r.jsxs)(en.wd,{children:[(0,r.jsx)(en.r7,{children:"Regenerate Delivery Link?"}),(0,r.jsx)(en.$v,{children:"This will create a new delivery link. The previous link will stop working immediately. Anyone with the old link will no longer have access."})]}),(0,r.jsxs)(en.ck,{children:[(0,r.jsx)(en.Zr,{disabled:p,children:"Cancel"}),(0,r.jsx)(en.Rx,{onClick:A,disabled:p,children:p?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(M.A,{className:"h-4 w-4 mr-2 animate-spin"}),"Regenerating..."]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eR.A,{className:"h-4 w-4 mr-2"}),"Regenerate"]})})]})]})})]})}var eF=t(89617),eL=t(55678),eO=t(69802),e$=t(76457);let eB=()=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-0.5",children:[(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-current animate-bounce [animation-delay:-0.3s]"}),(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-current animate-bounce [animation-delay:-0.15s]"}),(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-current animate-bounce"})]});function eq(e){var s,t,ex,eh,eg,ep,ev,eI,eT,ez,eS,eD,eR,e_,eU,eq,eH,eG;let{job:eJ,technician:eV,projectManager:eK,editor:eZ,messages:eQ,currentUserId:eW,currentUserName:eY,currentUserAvatar:eX,isClient:e0=!1,open:e1,onOpenChange:e2,currentUserAccountType:e4,onSendMessage:e5,onEditMessage:e3,onDeleteMessage:e7,onStatusChange:e6,onAssignTechnician:e9,onChangeTechnician:e8,onAssignCustomer:se,onAssignProjectManager:ss,onAssignEditor:st,variant:sr="sheet",onFullScreen:sa,onOpenInNewPage:sl,initialTab:sn,initialChatTab:si}=e,{activeOrganizationId:sd,activeMembership:so}=(0,eF.Q)(),sc=(0,eL.w)(),su=(0,eO.I)(),sm=null!=eX?eX:su.currentUserAvatar,sx=!!eJ&&su.isLoadingMessages(eJ.id),sh="AGENT"===(e4||"").toUpperCase(),[sg,sp]=(0,a.useState)(sn||"discussion"),sf=((null==so?void 0:so.role)||(null==so?void 0:so.orgRole)||"").toUpperCase(),sv="PERSONAL"===((null==so||null==(s=so.organization)?void 0:s.type)||(null==so?void 0:so.organizationType)||"PERSONAL"),sj=(0,a.useMemo)(()=>sf&&""!==sf?sv?"PERSONAL_OWNER":sf:"NONE",[sf,sv]),sb=(0,a.useMemo)(()=>!!sh||(0,e$.nS)(sj),[sj,sh]),sN=(0,a.useMemo)(()=>"PROVIDER"===(e4||"").toUpperCase()&&sv,[e4,sv]),sy=!sh&&!sN,sw=sy&&sb,sk=sh||sN||sb?"client":"team",[sC,sA]=(0,a.useState)(si||sk),sM=(0,a.useMemo)(()=>sh||"client"===sC?"CUSTOMER":"TEAM",[sC,sh]),sE=(0,a.useMemo)(()=>eJ?su.getTypingUsers(eJ.id,sM):[],[eJ,su,sM]);(0,a.useEffect)(()=>{sb||"client"!==sC||sA("team"),sy||"team"!==sC||sA("client")},[sb,sy,sC]);let[sI,sT]=(0,a.useState)(null),[sz,sS]=(0,a.useState)(null),[sD,sR]=(0,a.useState)(null),[s_,sU]=(0,a.useState)(null),[sP,sF]=(0,a.useState)(null),[sL,sO]=(0,a.useState)(!1),[s$,sB]=(0,a.useState)(!1),[sq,sH]=(0,a.useState)([]),[sG,sJ]=(0,a.useState)(new Set),[sV,sK]=(0,a.useState)(!1),[sZ,sQ]=(0,a.useState)(!1),[sW,sY]=(0,a.useState)(null),[sX,s0]=(0,a.useState)(""),[s1,s2]=(0,a.useState)({open:!1,service:""}),[s4,s5]=(0,a.useState)(null),[s3,s7]=(0,a.useState)(!1),[s6,s9]=(0,a.useState)(!1),[s8,te]=(0,a.useState)([]),[ts,tt]=(0,a.useState)([]),[tr,ta]=(0,a.useState)([]),[tl,tn]=(0,a.useState)([]),ti=(0,a.useRef)(new Set),[td,to]=(0,a.useState)(""),[tc,tu]=(0,a.useState)(""),[tm,tx]=(0,a.useState)(""),[th,tg]=(0,a.useState)(!1),tp=(0,a.useRef)(null),tf=(0,a.useRef)(null),tv=(0,a.useRef)(null),tj=(0,a.useRef)(null),tb=(0,a.useRef)(null),tN=(0,a.useRef)(new Set),ty=(0,ec.a)();(0,a.useMemo)(()=>(null==eJ?void 0:eJ.projectManagerId)===eW,[eW,null==eJ?void 0:eJ.projectManagerId]);let tw=(0,a.useMemo)(()=>{var e;let s=eJ?{projectManagerId:null!=(e=eJ.projectManagerId)?e:null}:null;return(0,e$.Kh)(sj,s,eW)},[sj,null==eJ?void 0:eJ.projectManagerId,eW]),tk=tw&&!sN,tC=(0,a.useMemo)(()=>!sN&&(0,e$.qc)(sj),[sj,sN]),tA=(0,a.useMemo)(()=>(0,e$.aN)(sj),[sj]),tM=(0,a.useMemo)(()=>(0,e$.jC)(sj),[sj]),tE=(0,a.useMemo)(()=>{var e;if(!sh||!eJ)return{canDelete:!1,canCancel:!1};let s=null==(e=eJ.status)?void 0:e.toLowerCase(),t=!!eJ.assignedTechnicianId;return"delivered"===s?{canDelete:!1,canCancel:!1}:"cancelled"!==s&&("pending"!==s||t)?{canDelete:!1,canCancel:!0}:{canDelete:!0,canCancel:!1}},[sh,null==eJ?void 0:eJ.status,null==eJ?void 0:eJ.assignedTechnicianId]),tI=(0,a.useMemo)(()=>{var e,s,t;let r=eJ?{projectManagerId:null!=(s=eJ.projectManagerId)?s:null,customerId:null!=(t=eJ.customerId)?t:null}:null;return(0,e$.mR)(sj,r,eW,{userAccountType:e4,customerUserId:null==eJ||null==(e=eJ.customer)?void 0:e.userId})},[sj,null==eJ?void 0:eJ.projectManagerId,null==eJ?void 0:eJ.customerId,null==eJ||null==(t=eJ.customer)?void 0:t.userId,eW,e4]),tT=e=>e?e.split(" ").map(e=>e[0]).join("").slice(0,2):"NA",tz=e=>{let{isAssigned:s,name:t,avatar:a,label:l,onClear:n,canEdit:i,disabled:d,children:o}=e;return i?(0,r.jsxs)(ei.rI,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(ei.ty,{asChild:!0,disabled:d,children:(0,r.jsxs)("button",{className:(0,eu.cn)("flex items-center gap-2 px-2 py-1 -ml-2 rounded-md transition-colors","hover:bg-muted/50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1",d&&"opacity-50 cursor-not-allowed"),children:[(0,r.jsx)(f.eu,{className:"h-7 w-7",children:s?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f.BK,{src:a,alt:t}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted-foreground/20",children:tT(t)})]}):(0,r.jsx)(f.q5,{className:"text-xs bg-transparent border-2 border-secondary border-dashed"})}),(0,r.jsx)("span",{className:(0,eu.cn)("text-sm",s?"text-foreground":"text-muted-foreground"),children:s?t:l})]})}),s&&n&&(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),n()},className:(0,eu.cn)("flex items-center justify-center size-5 rounded-full transition-colors","text-muted-foreground hover:text-foreground hover:bg-muted/80","focus:outline-none focus:ring-2 focus:ring-ring"),disabled:d,children:(0,r.jsx)(v.A,{className:"size-3"})})]}),o]}):(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.eu,{className:"h-7 w-7",children:s?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f.BK,{src:a,alt:t}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted-foreground/20",children:tT(t)})]}):(0,r.jsx)(f.q5,{className:"text-xs bg-transparent border-2 border-secondary border-dashed"})}),(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:s?t:"Unassigned"})]})},tS=(e,s,t,r)=>{let a=s.trim().toLowerCase();return a?e.filter(e=>{var s;let l=(null==(s=t(e))?void 0:s.toLowerCase())||"",n=((null==r?void 0:r(e))||"").toLowerCase();return l.includes(a)||n.includes(a)}):e},tD=(0,a.useMemo)(()=>tS(ts,td,e=>e.name||"",e=>e.email),[ts,td]),tR=(0,a.useMemo)(()=>tS(tr,tc,e=>{var s,t;return(null==(s=e.user)?void 0:s.name)||(null==(t=e.personalOrg)?void 0:t.legalName)||""},e=>{var s;return null==(s=e.user)?void 0:s.email}),[tr,tc]),t_=(0,a.useMemo)(()=>tS(tl,tm,e=>{var s,t;return(null==(s=e.user)?void 0:s.name)||(null==(t=e.personalOrg)?void 0:t.legalName)||""},e=>{var s;return null==(s=e.user)?void 0:s.email}),[tl,tm]),tU=(0,a.useMemo)(()=>(null==eJ?void 0:eJ.customerId)&&ts.find(e=>e.id===eJ.customerId)||null,[ts,eJ]),tP=(0,a.useMemo)(()=>(null==eJ?void 0:eJ.projectManagerId)&&tr.find(e=>{var s;return e.userId===eJ.projectManagerId||(null==(s=e.user)?void 0:s.id)===eJ.projectManagerId})||null,[tr,eJ]),tF=(0,a.useMemo)(()=>(null==eJ?void 0:eJ.editorId)&&tl.find(e=>{var s;return e.userId===eJ.editorId||(null==(s=e.user)?void 0:s.id)===eJ.editorId})||null,[tl,eJ]),tL=(0,a.useMemo)(()=>(null==eJ?void 0:eJ.assignedTechnicianId)&&s8.find(e=>e.id===eJ.assignedTechnicianId||e.userId===eJ.assignedTechnicianId)||null,[s8,null==eJ?void 0:eJ.assignedTechnicianId]),tO=tL?{name:tL.name,avatarUrl:tL.avatar,role:tL.role||"TECHNICIAN"}:eV||((null==eJ?void 0:eJ.technician)?{name:eJ.technician.name,avatarUrl:eJ.technician.avatarUrl,role:"TECHNICIAN"}:null),t$=(null==tU?void 0:tU.name)||(null==eJ?void 0:eJ.clientName)||"Unassigned",tB=(null==tP||null==(ex=tP.user)?void 0:ex.name)||(null==tP||null==(eh=tP.personalOrg)?void 0:eh.legalName)||(null==tP||null==(eg=tP.user)?void 0:eg.email)||(null==eK?void 0:eK.name)||(null==eK?void 0:eK.fullName)||(null==eK?void 0:eK.email)||(null==eJ||null==(ep=eJ.projectManager)?void 0:ep.name)||(null==eJ||null==(ev=eJ.projectManager)?void 0:ev.fullName)||(null==eJ||null==(eI=eJ.projectManager)?void 0:eI.email)||((null==eJ?void 0:eJ.projectManagerId)?"Assigned":"Unassigned"),tq=(null==tF||null==(eT=tF.user)?void 0:eT.name)||(null==tF||null==(ez=tF.personalOrg)?void 0:ez.legalName)||(null==tF||null==(eS=tF.user)?void 0:eS.email)||(null==eZ?void 0:eZ.name)||(null==eZ?void 0:eZ.fullName)||(null==eZ?void 0:eZ.email)||(null==eJ||null==(eD=eJ.editor)?void 0:eD.name)||(null==eJ||null==(eR=eJ.editor)?void 0:eR.fullName)||(null==eJ||null==(e_=eJ.editor)?void 0:e_.email)||((null==eJ?void 0:eJ.editorId)?"Assigned":"Unassigned"),tH=(null==tP||null==(eU=tP.user)?void 0:eU.avatarUrl)||(null==eK?void 0:eK.avatarUrl)||(null==eJ||null==(eq=eJ.projectManager)?void 0:eq.avatarUrl)||"",tG=(null==tF||null==(eH=tF.user)?void 0:eH.avatarUrl)||(null==eZ?void 0:eZ.avatarUrl)||(null==eJ||null==(eG=eJ.editor)?void 0:eG.avatarUrl)||"";(0,a.useEffect)(()=>{sb||"client"!==sC||sA("team")},[sC,sb]);let tJ=(0,a.useCallback)(e=>{switch((e||"").toUpperCase()){case c.zu.VIDEO:return"video";case c.zu.FLOORPLAN:return"floor-plan";case c.zu.VIRTUAL_TOUR:return"3d-content";case c.zu.DOCUMENT:return"file";case c.zu.PHOTO:default:return"image"}},[]),tV=(0,a.useCallback)(e=>{switch(e){case"video":return c.zu.VIDEO;case"floor-plan":return c.zu.FLOORPLAN;case"3d-content":return c.zu.VIRTUAL_TOUR;case"file":return c.zu.DOCUMENT;default:return c.zu.PHOTO}},[]),tK=(0,a.useCallback)(e=>({id:e.id,name:e.filename,type:tJ(e.type),url:e.externalUrl||e.cdnUrl||e.key||"",size:e.size,uploadedAt:new Date(e.createdAt),key:e.key}),[tJ]),tZ=(0,l.hG)({extensions:[n.A.configure({heading:!1,horizontalRule:!1,underline:!1}),d.A,o.Ay.configure({openOnClick:!1,HTMLAttributes:{class:"text-primary underline"}}),i.A.configure({placeholder:"Type a message..."})],content:"",immediatelyRender:!1,editorProps:{attributes:{class:"prose prose-sm sm:prose-base focus:outline-none max-w-none min-h-[64px] max-h-[200px] overflow-y-auto px-3.5 py-3 text-sm"}}});(0,a.useEffect)(()=>{(async()=>{let e=sd||(null==eJ?void 0:eJ.organizationId);if(e&&e1&&(eM.F.organizations.setActiveOrganization(e),!sh))try{let e=tA?eM.F.customers.list():Promise.resolve([]),[s,t,r]=await Promise.all([(0,eE.NV)(),e,eM.F.organizations.listMembers()]);te(s),tt(tA?t:[]),ta(r.filter(e=>["OWNER","ADMIN","PROJECT_MANAGER"].includes(e.role||e.orgRole||""))),tn(r.filter(e=>"EDITOR"===(e.role||e.orgRole||"")))}catch(e){console.error("Failed to load assignment data",e)}})()},[sd,null==eJ?void 0:eJ.organizationId,e1,sh]),(0,a.useEffect)(()=>{if((null==eJ?void 0:eJ.media)&&eJ.media.length>0){let e=eJ.media.map(tK);sH(e),e.forEach(e=>ti.current.add(e.key||e.id))}else null==eJ||eJ.id,sH([]),ti.current.clear()},[null==eJ?void 0:eJ.id,null==eJ?void 0:eJ.media,tK]),(0,a.useEffect)(()=>{let e=!1;return(async()=>{if(!(null==eJ?void 0:eJ.id)||!e1)return;let s=sd||(null==eJ?void 0:eJ.organizationId);s&&eM.F.organizations.setActiveOrganization(s),sQ(!0);try{let s=await eM.F.media.listForProject(eJ.id);if(!e){let e=s.map(tK);sH(e),e.forEach(e=>ti.current.add(e.key||e.id))}}catch(s){e||(console.error("Failed to load media for project",s),er.oR.error("Failed to load media for this project"))}finally{e||sQ(!1)}})(),()=>{e=!0}},[sd,null==eJ?void 0:eJ.id,null==eJ?void 0:eJ.organizationId,tK,e1]);let tQ=async e=>{if(!eJ||!tA)return;let s=!e;tg(!0);try{if(se&&e){await se(e),await sc.refreshJobs();let s=sc.getJobById(eJ.id);s&&sc.selectJob(s)}else{let s=await eM.F.projects.assignCustomer(eJ.id,e||null);sc.updateJob(eJ.id,s),sc.selectJob(eM.F.mapProjectToJobCard(s))}er.oR.success(s?"Customer unassigned":"Customer assigned")}catch(e){console.error("Failed to assign customer",e)}finally{tg(!1)}},tW=async e=>{if(!eJ||!tC)return;let s=!e;tg(!0);try{if(ss&&e){await ss(e),await sc.refreshJobs();let s=sc.getJobById(eJ.id);s&&sc.selectJob(s)}else{let s=await eM.F.projects.assignProjectManager(eJ.id,e||null);sc.updateJob(eJ.id,s),sc.selectJob(eM.F.mapProjectToJobCard(s))}er.oR.success(s?"Project manager unassigned":"Project manager assigned")}catch(e){console.error("Failed to assign project manager",e)}finally{tg(!1)}},tY=async e=>{if(!eJ||!tk)return;let s=!e;tg(!0);try{if(st&&e){await st(e),await sc.refreshJobs();let s=sc.getJobById(eJ.id);s&&sc.selectJob(s)}else{let s=await eM.F.projects.assignEditor(eJ.id,e||null);sc.updateJob(eJ.id,s),sc.selectJob(eM.F.mapProjectToJobCard(s))}er.oR.success(s?"Editor unassigned":"Editor assigned")}catch(e){console.error("Failed to assign editor",e)}finally{tg(!1)}},tX=(0,l.hG)({extensions:[n.A.configure({heading:!1,horizontalRule:!1,underline:!1}),d.A,o.Ay.configure({openOnClick:!1,HTMLAttributes:{class:"text-primary underline"}})],content:"",immediatelyRender:!1,editorProps:{attributes:{class:"prose prose-sm sm:prose-base focus:outline-none max-w-none min-h-[64px] max-h-[120px] overflow-y-auto px-3.5 py-3 text-sm"}}});(0,a.useEffect)(()=>{if(tZ){let e="client"===sC?"Type a message for the client...":"Type a message for the team...",s=tZ.extensionManager.extensions.find(e=>"placeholder"===e.name);s&&s.options&&(s.options.placeholder=e,tZ.view.dispatch(tZ.state.tr))}},[tZ,sC]),(0,a.useEffect)(()=>{tZ&&tZ.setEditable(!(e0&&"team"===sC))},[tZ,e0,sC]),(0,a.useEffect)(()=>{!e1&&tZ&&(tZ.commands.clearContent(),sT(null),sp("discussion"),sO(!1),sU(null),tX&&tX.commands.clearContent())},[e1,tZ,tX]),(0,a.useEffect)(()=>{if(!tZ)return;let e=()=>{let e=tZ.getText().trim().length>0;sO(e),eJ&&tZ.isEditable&&("CUSTOMER"!==sM||tI)&&("TEAM"===sM&&e0||(e?su.emitTyping(eJ.id,sM):su.stopTyping(eJ.id,sM)))};return tZ.on("update",e),tZ.on("selectionUpdate",e),e(),()=>{tZ.off("update",e),tZ.off("selectionUpdate",e)}},[tZ,eJ,sM,tI,e0,su]);let t0=(0,a.useCallback)(e=>{if(!e)return e;let s=e.trim();return(s=s.replace(/(<p><br\s*\/?><\/p>\s*)+$/gi,"")).replace(/(<p>\s*<\/p>\s*)+$/gi,"")},[]),t1=(0,a.useCallback)(()=>{if(!tZ||!e5||!eJ)return;let e=t0(tZ.getHTML());if(!tZ.getText().trim())return;let s="client"===(sh?"client":sC)?"CUSTOMER":"TEAM";if("CUSTOMER"===s&&!tI)return void er.oR.error("You don't have permission to send messages in customer chat");let t=sI?sI.threadId||sI.thread||sI.id:void 0;su.stopTyping(eJ.id,s),e5(e,s,t),tZ.commands.clearContent(),sT(null),sO(!1),tZ.commands.focus()},[tZ,e5,sC,sI,sh,eJ,su,t0,tI]),t2=(0,a.useCallback)(e=>{sU(e.id)},[]);(0,a.useEffect)(()=>{if(s_&&tX){let e=eQ.find(e=>e.id===s_);e&&(tX.setEditable(!0),setTimeout(()=>{tX.commands.setContent(e.content),tX.commands.focus("end"),sB(tX.getText().trim().length>0)},50))}else!s_&&tX&&(tX.commands.clearContent(),sB(!1))},[s_,tX,eQ]),(0,a.useEffect)(()=>{if(!tX)return;let e=()=>{sB(tX.getText().trim().length>0)};return tX.on("update",e),tX.on("selectionUpdate",e),e(),()=>{tX.off("update",e),tX.off("selectionUpdate",e)}},[tX]);let t4=(0,a.useCallback)(()=>{if(!tX||!s_||!e3)return;let e=t0(tX.getHTML());if(!tX.getText().trim())return void sU(null);e3(s_,e),sU(null),tX.commands.clearContent()},[tX,s_,e3,t0]),t5=(0,a.useCallback)(()=>{sU(null),tX&&tX.commands.clearContent()},[tX]),t3=(0,a.useCallback)(e=>{sF(e)},[]),t7=(0,a.useCallback)(()=>{sP&&e7&&(e7(sP),sF(null))},[sP,e7]),t6=(0,a.useCallback)(()=>{sF(null)},[]);(0,a.useEffect)(()=>{if(!tZ)return;let e=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),t1())},s=tZ.view.dom;return s.addEventListener("keydown",e),()=>{s.removeEventListener("keydown",e)}},[tZ,t1]);let t9=(0,a.useCallback)(async()=>{if(eJ){s9(!0);try{await sc.deleteJob(eJ.id),s7(!1),e2(!1)}catch(e){}finally{s9(!1)}}},[eJ,sc,e2]),t8=e=>{switch(e){case"image":return(0,r.jsx)(w.A,{className:"size-10 text-muted-foreground"});case"video":return(0,r.jsx)(b.A,{className:"size-10 text-muted-foreground"});case"floor-plan":return(0,r.jsx)(k.A,{className:"size-10 text-muted-foreground"});case"3d-content":return(0,r.jsx)(C.A,{className:"size-10 text-muted-foreground"});default:return(0,r.jsx)(A.A,{className:"size-10 text-muted-foreground"})}},re=async(e,s)=>{if(!e||!e.allEntries||0===e.allEntries.length||!eJ)return;let t=sd||eJ.organizationId;t&&eM.F.organizations.setActiveOrganization(t);let r=[];for(let t of e.allEntries){let e={key:t.uuid||t.fileId||t.cdnUrl,cdnUrl:t.cdnUrl,filename:t.name,size:t.size,type:tV(s)};if(!(!e.key||ti.current.has(e.key)))try{let s=await eM.F.media.addToProject(eJ.id,e);r.push(tK(s)),ti.current.add(e.key)}catch(e){console.error("Failed to register media upload",e),er.oR.error("Failed to save ".concat((null==t?void 0:t.name)||"upload"))}}r.length>0&&(sH(e=>{let s=[...e];return r.forEach(e=>{s.some(s=>s.id===e.id||s.key===e.key)||s.push(e)}),s}),er.oR.success("".concat(r.length," media item").concat(r.length>1?"s":""," added")))},rs=e=>sq.filter(s=>s.type===e),rt=(0,a.useMemo)(()=>sq&&sq.length>0,[sq]),rr=(e=>{switch(e){case"urgent":return{label:"Urgent",color:"text-destructive"};case"rush":return{label:"Rush",color:"text-orange-500"};default:return{label:"Standard",color:"text-primary"}}})((null==eJ?void 0:eJ.priority)||"standard"),ra=(e=>{switch(e){case"pending":return{label:"Pending",bgColor:"bg-status-pending",textColor:"text-status-pending",indicatorColor:"bg-status-pending"};case"assigned":return{label:"Assigned",bgColor:"bg-status-assigned",textColor:"text-status-assigned",indicatorColor:"bg-status-assigned"};case"in_progress":return{label:"In Progress",bgColor:"bg-status-in-progress",textColor:"text-status-in-progress",indicatorColor:"bg-status-in-progress"};case"editing":return{label:"Editing",bgColor:"bg-status-editing",textColor:"text-status-editing",indicatorColor:"bg-status-editing"};case"delivered":return{label:"Delivered",bgColor:"bg-status-delivered",textColor:"text-status-delivered",indicatorColor:"bg-status-delivered"};case"cancelled":return{label:"Cancelled",bgColor:"bg-status-cancelled",textColor:"text-status-cancelled",indicatorColor:"bg-status-cancelled"};default:return{label:e,bgColor:"bg-muted",textColor:"text-muted-foreground",indicatorColor:"bg-muted-foreground"}}})((null==eJ?void 0:eJ.status)||"pending"),rl=e=>{switch(e){case"image":case"floor-plan":return"image/*";case"video":return"video/*";default:return"*"}},rn=e=>{window.open(e.url,"_blank")},ri=async e=>{if(!eJ||sh||sG.has(e))return;let s=sd||eJ.organizationId;s&&eM.F.organizations.setActiveOrganization(s),sJ(s=>new Set(s).add(e));let t=sq.find(s=>s.id===e);sH(s=>s.filter(s=>s.id!==e));try{await eM.F.media.deleteFromProject(eJ.id,e),t&&(t.url.startsWith("blob:")&&URL.revokeObjectURL(t.url),t.key&&ti.current.delete(t.key)),er.oR.success("Media deleted")}catch(e){console.error("Failed to delete media",e),t&&sH(e=>[...e,t]),er.oR.error("Failed to delete media")}finally{sJ(s=>{let t=new Set(s);return t.delete(e),t})}},rd=async(e,s)=>{if(!e.trim()||!eJ||sV)return;try{new URL(e)}catch(e){er.oR.error("Please enter a valid URL");return}let t=e.split("/"),r=t[t.length-1]||"Virtual Tour";sK(!0);try{let t=sd||eJ.organizationId;if(t&&eM.F.organizations.setActiveOrganization(t),ti.current.has(e)){er.oR.success("Media already added"),s0("");return}let a=await eM.F.media.addToProject(eJ.id,{key:e,cdnUrl:e,filename:r,size:0,type:tV(s)});ti.current.add(e),sH(e=>{let s=tK(a);return e.some(e=>e.id===s.id||e.key===s.key)?e:[...e,s]}),er.oR.success("Media added")}catch(e){console.error("Failed to save media URL",e),er.oR.error("Failed to save media URL")}finally{s0(""),sK(!1)}},ro=(e,s)=>{let t=rs(e);return sh&&0===t.length?null:("floor-plan"===e||"3d-content"===e||(e.charAt(0).toUpperCase(),e.slice(1)),"3d-content"===e)?(0,r.jsx)("div",{className:"py-4 space-y-4",children:0===t.length?(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(eA.p,{type:"url",placeholder:"Enter 3D model URL (e.g., https://example.com/model.glb)",value:sX,onChange:e=>s0(e.target.value),onKeyDown:e=>{"Enter"!==e.key||sh||sV||rd(sX,"3d-content")},disabled:sh||sV,className:"flex-1"}),(0,r.jsxs)(h.$,{onClick:()=>rd(sX,"3d-content"),disabled:!sX.trim()||sh||sV,children:[sV?(0,r.jsx)(M.A,{className:"h-4 w-4 mr-2 animate-spin"}):(0,r.jsx)(E.A,{className:"h-4 w-4 mr-2"}),sV?"Adding...":"Add URL"]})]}),(0,r.jsx)(ea.P,{className:"text-xs text-muted-foreground",children:sh?"Media uploads are not available for agent accounts. You’ll see shared media here once it’s added.":"Enter a URL to a 3D model file (GLB, GLTF, OBJ, FBX, etc.)"})]})}):(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(ea.P,{className:"text-sm font-medium text-foreground",children:[t.length," ",1===t.length?"item":"items"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(eA.p,{type:"url",placeholder:"Enter 3D model URL",value:sX,onChange:e=>s0(e.target.value),onKeyDown:e=>{"Enter"!==e.key||sh||sV||rd(sX,"3d-content")},disabled:sh||sV,className:"w-[300px]"}),(0,r.jsxs)(h.$,{onClick:()=>rd(sX,"3d-content"),disabled:!sX.trim()||sh||sV,variant:"outline",size:"sm",children:[sV?(0,r.jsx)(M.A,{className:"h-4 w-4 mr-2 animate-spin"}):(0,r.jsx)(E.A,{className:"h-4 w-4 mr-2"}),sV?"Adding...":"Add URL"]})]})]}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:t.map((e,s)=>(0,r.jsxs)("div",{className:"group relative aspect-square rounded-lg border border-border overflow-hidden bg-muted hover:border-primary transition-colors",children:[(0,r.jsxs)("div",{className:"size-full flex flex-col items-center justify-center bg-muted p-4",children:[t8(e.type),(0,r.jsx)(ea.P,{className:"text-xs text-muted-foreground mt-2 text-center line-clamp-2",children:e.name})]}),(0,r.jsx)("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(h.$,{variant:"ghost",size:"icon",className:"h-8 w-8 bg-background/90 hover:bg-background",onClick:()=>rn(e),children:(0,r.jsx)(I.A,{className:"h-4 w-4"})}),!sh&&(0,r.jsx)(h.$,{variant:"ghost",size:"icon",className:"h-8 w-8 bg-background/90 hover:bg-background hover:text-destructive",onClick:()=>ri(e.id),children:(0,r.jsx)(T.A,{className:"h-4 w-4"})})]})}),(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2",children:(0,r.jsx)(ea.P,{className:"text-xs text-white truncate",children:e.name})})]},e.id||"media-".concat(s,"-").concat(e.url)))})]})}):0===t.length?sh?null:(0,r.jsx)("div",{className:"py-4 space-y-4",children:("image"===e||"video"===e||"floor-plan"===e||"file"===e)&&(0,r.jsx)("div",{className:"flex flex-col items-center gap-2",children:(0,r.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,r.jsx)(em.vY,{pubkey:"dbf470d49c954f9f6143",classNameUploader:"uc-light uc-gray",sourceList:"local, camera, gdrive, facebook",userAgentIntegration:"llm-nextjs",filesViewMode:"grid",useCloudImageEditor:!1,accept:rl(e),onChange:s=>void re(s,e),onCommonUploadSuccess:e=>console.log("Uploaded files URL list",e.successEntries.map(e=>e.cdnUrl))})})})}):(0,r.jsxs)("div",{className:"py-4 space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[(0,r.jsxs)(ea.P,{className:"text-sm font-medium text-foreground",children:[t.length," ",1===t.length?"item":"items"]}),(0,r.jsx)("div",{className:"flex items-center gap-2 flex-wrap",children:!sh&&("image"===e||"video"===e||"floor-plan"===e||"file"===e)&&(0,r.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,r.jsx)(em.vY,{pubkey:"dbf470d49c954f9f6143",classNameUploader:"uc-light uc-gray",sourceList:"local, camera, gdrive, facebook",userAgentIntegration:"llm-nextjs",filesViewMode:"grid",useCloudImageEditor:!1,accept:rl(e),onChange:s=>void re(s,e),onCommonUploadSuccess:e=>console.log("Uploaded files URL list",e.successEntries.map(e=>e.cdnUrl))})})})]}),(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:t.map((e,s)=>(0,r.jsxs)("div",{className:"group relative aspect-square rounded-lg border border-border overflow-hidden bg-muted hover:border-primary transition-colors",children:[("image"===e.type||"floor-plan"===e.type)&&(0,r.jsx)("img",{src:e.url,alt:e.name,className:"size-full object-cover"}),"video"===e.type&&(0,r.jsx)("div",{className:"size-full flex items-center justify-center bg-muted",children:(0,r.jsx)(b.A,{className:"size-12 text-muted-foreground"})}),("3d-content"===e.type||"file"===e.type)&&(0,r.jsxs)("div",{className:"size-full flex flex-col items-center justify-center bg-muted p-4",children:[t8(e.type),(0,r.jsx)(ea.P,{className:"text-xs text-muted-foreground mt-2 text-center line-clamp-2",children:e.name})]}),(0,r.jsx)("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(h.$,{variant:"ghost",size:"icon",className:"h-8 w-8 bg-background/90 hover:bg-background",onClick:()=>rn(e),children:(0,r.jsx)(I.A,{className:"h-4 w-4"})}),!sh&&(0,r.jsx)(h.$,{variant:"ghost",size:"icon",className:"h-8 w-8 bg-background/90 hover:bg-background hover:text-destructive",onClick:()=>ri(e.id),children:(0,r.jsx)(T.A,{className:"h-4 w-4"})})]})}),(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2",children:(0,r.jsx)(ea.P,{className:"text-xs text-white truncate",children:e.name})})]},e.id||"media-".concat(s,"-").concat(e.url)))})]})},rc=(0,a.useMemo)(()=>eQ.map(e=>{var s,t,r,a;let l=(null==e||null==(s=e.user)?void 0:s.accountType)==="AGENT"||(null==e||null==(t=e.user)?void 0:t.account_type)==="AGENT",n=(null==e?void 0:e.channel)||(l||"client"===e.chatType?"CUSTOMER":"TEAM");return{...e,channel:n,chatType:"CUSTOMER"===n?"client":"team",thread:null!=(a=null!=(r=e.thread)?r:e.threadId)?a:null}}),[eQ]),ru=rc.filter(e=>"client"===e.chatType),rm=rc.filter(e=>"team"===e.chatType),rx=e=>{let s=new Map,t=[];e.forEach(e=>{s.set(e.id,{...e,replies:[]})}),s.forEach(e=>{e.thread&&s.has(e.thread)?s.get(e.thread).replies.push(e):t.push(e)});let r=e=>{e.sort((e,s)=>new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime()),e.forEach(e=>r(e.replies))};return r(t),t};(0,a.useMemo)(()=>rx(ru),[ru]),(0,a.useMemo)(()=>rx(rm),[rm]);let[rh,rg]=(0,a.useState)({}),rp=(0,a.useMemo)(()=>{let e=new Map;return eQ.forEach(s=>e.set(s.id,s)),e},[eQ]),rf=(0,a.useMemo)(()=>{let e=new Map;return eQ.forEach(s=>{s.userAvatar&&e.set(s.userId,s.userAvatar)}),e},[eQ]),rv=(0,a.useCallback)(e=>{let s=rp.get(e);if(!s)return[];let t=eQ.filter(s=>s.threadId===e||s.thread===e),r=new Set;return[s,...t].filter(e=>!r.has(e.id)&&(r.add(e.id),!0)).sort((e,s)=>new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime())},[eQ,rp]),rj=(0,a.useCallback)(e=>eQ.filter(s=>s.threadId===e||s.thread===e).length,[eQ]),rb=(0,a.useMemo)(()=>{let e=new Set;return[...ru].filter(s=>!e.has(s.id)&&(e.add(s.id),!0)).sort((e,s)=>new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime())},[ru]),rN=(0,a.useMemo)(()=>{let e=new Set;return[...rm].filter(s=>!e.has(s.id)&&(e.add(s.id),!0)).sort((e,s)=>new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime())},[rm]),ry=(0,a.useCallback)((e,s)=>{let t=su.getMessageReadReceipts(e.id).filter(s=>s.userId!==e.userId);if(0===t.length)return(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsx)("span",{className:(0,eu.cn)("text-xs",s),children:"Not read yet"})});let a=[...t].sort((e,s)=>new Date(s.readAt).getTime()-new Date(e.readAt).getTime());return(0,r.jsx)("div",{className:"flex flex-col gap-2",children:a.map(e=>{let t=rf.get(e.userId);return(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)(f.eu,{className:"h-4 w-4 border border-background",children:[(0,r.jsx)(f.BK,{src:t,alt:e.userName}),(0,r.jsx)(f.q5,{className:"text-[9px] bg-muted",children:tT(e.userName)})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:(0,eu.cn)("text-[11px]",s),children:e.userName}),(0,r.jsxs)("span",{className:(0,eu.cn)("text-[10px]",s),children:["Read ",(0,et.GP)(new Date(e.readAt),"h:mm a")]})]})]},e.userId)})})},[su,rf]);(0,a.useEffect)(()=>{tN.current.clear()},[null==eJ?void 0:eJ.id]),(0,a.useEffect)(()=>{if(!eJ)return;let e=("client"===sC?rb:rN).filter(e=>e.userId!==eW).filter(e=>!tN.current.has(e.id)&&!su.getMessageReadReceipts(e.id).some(e=>e.userId===eW)).map(e=>e.id);e.length>0&&(e.forEach(e=>tN.current.add(e)),su.markMessagesAsRead(eJ.id,e,sM))},[sC,sM,eW,rb,rN,eJ,su]);let rw=function(e){let s=!(arguments.length>1)||void 0===arguments[1]||arguments[1],t=!(arguments.length>2)||void 0===arguments[2]||arguments[2],a=e.userId===eW,n=s_===e.id,i=rj(e.id),d=e.threadId||e.thread,o=d?rp.get(d):null,c=!a&&s;return(0,r.jsxs)("div",{className:(0,eu.cn)("flex group",a?"justify-end":"justify-start",s?"mt-3":"mt-0.5"),children:[!a&&(0,r.jsx)("div",{className:"w-8 mr-2 flex-shrink-0 self-end",children:t?(0,r.jsxs)(f.eu,{className:"h-8 w-8",children:[(0,r.jsx)(f.BK,{src:e.userAvatar,alt:e.userName}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted",children:e.userName.split(" ").map(e=>e[0]).join("")})]}):(0,r.jsx)("div",{className:"h-8 w-8"})}),(0,r.jsxs)("div",{className:(0,eu.cn)("flex flex-col max-w-[80%]",a?"items-end":"items-start"),children:[(0,r.jsxs)("div",{className:(0,eu.cn)("flex items-center gap-1",a?"flex-row-reverse":"flex-row"),children:[(0,r.jsxs)("div",{className:(0,eu.cn)("relative px-3 py-2 shadow-sm",a?(0,eu.cn)("bg-primary text-primary-foreground",s&&t?"rounded-2xl rounded-br-md":s?"rounded-2xl rounded-br-md rounded-br-md":t?"rounded-2xl rounded-tr-md rounded-br-md":"rounded-2xl rounded-r-md"):(0,eu.cn)("bg-muted text-foreground",s&&t||s?"rounded-2xl rounded-bl-md":t?"rounded-2xl rounded-tl-md rounded-bl-md":"rounded-2xl rounded-l-md")),children:[c&&(0,r.jsx)("span",{className:"text-xs font-medium text-primary block mb-1",children:e.userName}),o&&(0,r.jsx)("button",{onClick:()=>sS(o),className:(0,eu.cn)("w-full mb-2 p-2 rounded-lg text-left transition-colors",a?"bg-primary-foreground/10 hover:bg-primary-foreground/20":"bg-background/50 hover:bg-background/70"),children:(0,r.jsxs)("div",{className:(0,eu.cn)("border-l-2 pl-2",a?"border-primary-foreground/50":"border-primary"),children:[(0,r.jsx)("span",{className:(0,eu.cn)("text-xs font-medium block",a?"text-primary-foreground/80":"text-primary"),children:o.userName}),(0,r.jsx)("span",{className:(0,eu.cn)("text-xs line-clamp-2",a?"text-primary-foreground/70":"text-muted-foreground"),dangerouslySetInnerHTML:{__html:o.content.replace(/<[^>]*>/g,"").slice(0,100)+(o.content.length>100?"...":"")}})]})}),n?(0,r.jsx)("div",{className:"min-w-[200px]",children:(0,r.jsxs)("div",{className:"bg-background/20 rounded-lg overflow-hidden",children:[(0,r.jsx)(l.$Z,{editor:tX,className:"[&_.ProseMirror]:min-h-[40px] [&_.ProseMirror]:max-h-[100px] [&_.ProseMirror]:overflow-y-auto [&_.ProseMirror]:px-2 [&_.ProseMirror]:py-2 [&_.ProseMirror]:text-sm [&_.ProseMirror]:focus:outline-none"}),(0,r.jsxs)("div",{className:"flex items-center justify-end gap-2 px-2 py-1.5 border-t border-white/10",children:[(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:t5,children:"Cancel"}),(0,r.jsx)(h.$,{size:"sm",className:"h-6 px-2 text-xs",onClick:t4,disabled:!tX||!s$,children:"Save"})]})]})}):(0,r.jsx)("div",{className:(0,eu.cn)("text-sm leading-relaxed prose prose-sm max-w-none","[&_p]:mb-1 [&_p:last-child]:mb-0","[&_strong]:font-semibold [&_em]:italic [&_u]:underline","[&_code]:bg-black/10 [&_code]:px-1 [&_code]:py-0.5 [&_code]:rounded [&_code]:text-xs","[&_ul]:list-disc [&_ul]:ml-4 [&_ol]:list-decimal [&_ol]:ml-4","[&_blockquote]:border-l-2 [&_blockquote]:pl-2 [&_blockquote]:italic",a?"[&_a]:text-primary-foreground [&_a]:underline [&_blockquote]:border-primary-foreground/50":"[&_a]:text-primary [&_a]:underline [&_blockquote]:border-border"),dangerouslySetInnerHTML:{__html:e.content}}),!n&&(0,r.jsxs)("div",{className:(0,eu.cn)("flex items-center gap-1 mt-1",a?"justify-end":"justify-start"),children:[(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)("span",{className:(0,eu.cn)("text-[10px] cursor-default",a?"text-primary-foreground/70":"text-muted-foreground"),children:(0,et.GP)(new Date(e.createdAt),"h:mm a")})}),(0,r.jsx)(el.ZI,{side:"top",className:"text-xs",children:(0,et.GP)(new Date(e.createdAt),"EEEE, MMMM d, yyyy 'at' h:mm a")})]}),a&&(0,r.jsx)(z.A,{className:(0,eu.cn)("h-3 w-3","text-primary-foreground/70")})]})]}),!n&&(0,r.jsxs)(ei.rI,{children:[(0,r.jsx)(ei.ty,{asChild:!0,children:(0,r.jsx)("button",{className:(0,eu.cn)("flex items-center justify-center h-6 w-6 rounded-full text-muted-foreground hover:text-foreground hover:bg-muted opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"),children:(0,r.jsx)(S.A,{className:"h-4 w-4"})})}),(0,r.jsxs)(ei.SQ,{align:a?"end":"start",className:"w-48",children:[(0,r.jsxs)(ei._2,{onClick:()=>sT(e),children:[(0,r.jsx)(D.A,{className:"h-4 w-4 mr-2"}),"Reply"]}),(0,r.jsxs)(ei._2,{onClick:()=>{er.oR.info("Reactions coming soon!")},children:[(0,r.jsx)(R.A,{className:"h-4 w-4 mr-2"}),"React"]}),(0,r.jsxs)(ei.lv,{children:[(0,r.jsxs)(ei.nV,{children:[(0,r.jsx)(_.A,{className:"h-4 w-4 mr-2"}),"Forward"]}),(0,r.jsxs)(ei.M5,{className:"w-48",children:[sy&&"team"!==sC&&(0,r.jsxs)(ei._2,{onClick:()=>{e5&&(e5('<blockquote class="border-l-2 border-primary pl-2 italic"><p class="text-xs text-muted-foreground mb-1">Forwarded from '.concat(e.userName,":</p>").concat(e.content,"</blockquote>"),"TEAM"),er.oR.success("Message forwarded to Team Chat"))},children:[(0,r.jsx)(U.A,{className:"h-4 w-4 mr-2"}),"Team Chat"]}),"client"!==sC&&tI&&(0,r.jsxs)(ei._2,{onClick:()=>{e5&&(e5('<blockquote class="border-l-2 border-primary pl-2 italic"><p class="text-xs text-muted-foreground mb-1">Forwarded from '.concat(e.userName,":</p>").concat(e.content,"</blockquote>"),"CUSTOMER"),er.oR.success("Message forwarded to Customer Chat"))},children:[(0,r.jsx)(P.A,{className:"h-4 w-4 mr-2"}),"Customer Chat"]}),(0,r.jsxs)(ei._2,{onClick:()=>{sR(e),er.oR.info("Direct messages coming soon!")},children:[(0,r.jsx)(F.A,{className:"h-4 w-4 mr-2"}),"Direct Message..."]})]})]}),(0,r.jsx)(ei.mB,{}),(0,r.jsx)(ei._2,{disabled:!0,className:"cursor-default focus:bg-transparent",children:(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsx)("span",{className:"text-[11px] text-muted-foreground",children:"Read by"}),ry(e,"text-muted-foreground")]})}),a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ei.mB,{}),(0,r.jsxs)(ei._2,{onClick:()=>t2(e),children:[(0,r.jsx)(L.A,{className:"h-4 w-4 mr-2"}),"Edit"]}),(0,r.jsxs)(ei._2,{onClick:()=>t3(e.id),className:"text-destructive focus:text-destructive",children:[(0,r.jsx)(T.A,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]})]}),!n&&i>0&&(0,r.jsxs)("button",{onClick:()=>sS(e),className:(0,eu.cn)("flex items-center gap-1 text-xs text-primary hover:underline mt-0.5",a?"self-end mr-1":"self-start ml-1"),children:[(0,r.jsx)(P.A,{className:"h-3 w-3"}),i," ",1===i?"reply":"replies",(0,r.jsx)(O.A,{className:"h-3 w-3"})]})]})]},e.id)},rk=e=>(0,r.jsx)("div",{className:(0,eu.cn)("flex items-center justify-between gap-4","sheet"===sr?"sticky top-0 z-50 bg-background/95 backdrop-blur supports-backdrop-filter:bg-background/60":"p-4"),children:(0,r.jsxs)(ef,{size:"sm",variant:"outline",className:"size-full",children:[(0,r.jsx)(ej,{className:"",children:(0,r.jsx)($.A,{className:"size-6"})}),(0,r.jsxs)(eb,{className:"",children:[(0,r.jsx)(eN,{className:"",children:(null==eJ?void 0:eJ.propertyAddress)||"Job"}),!sh&&(null==eJ?void 0:eJ.clientName)&&(0,r.jsxs)(ey,{className:"",children:["Customer: ",eJ.clientName]})]}),(0,r.jsxs)(ew,{className:"",children:[(0,r.jsxs)(ei.rI,{children:[(0,r.jsx)(ei.ty,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,r.jsx)(S.A,{className:"h-4 w-4"})})}),(0,r.jsxs)(ei.SQ,{align:"end",className:"w-52",children:[sa&&(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),sa&&sa()},className:"cursor-pointer",children:[(0,r.jsx)(I.A,{className:"mr-2 h-4 w-4"}),"View full screen"]}),sl&&(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),sl()},className:"cursor-pointer",children:[(0,r.jsx)(B.A,{className:"mr-2 h-4 w-4"}),"Open in new page"]}),(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),(()=>{if(!eJ)return;let e="".concat(window.location.origin,"/jobs/").concat(eJ.id);navigator.clipboard.writeText(e),er.oR.success("Link copied to clipboard")})()},className:"cursor-pointer",children:[(0,r.jsx)(E.A,{className:"mr-2 h-4 w-4"}),"Copy link"]}),(null==eJ?void 0:eJ.status)==="delivered"&&(null==eJ?void 0:eJ.deliveryToken)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),window.open("/delivery/".concat(eJ.deliveryToken),"_blank")},className:"cursor-pointer",children:[(0,r.jsx)(B.A,{className:"mr-2 h-4 w-4"}),"Open delivery page"]}),(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault();let s="".concat(window.location.origin,"/delivery/").concat(eJ.deliveryToken);navigator.clipboard.writeText(s),er.oR.success("Delivery link copied to clipboard")},className:"cursor-pointer",children:[(0,r.jsx)(E.A,{className:"mr-2 h-4 w-4"}),"Copy delivery link"]})]}),e6&&(null==eJ?void 0:eJ.status)!=="delivered"&&(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),e6&&e6("delivered")},className:"cursor-pointer",children:[(0,r.jsx)(q.A,{className:"mr-2 h-4 w-4"}),"Mark as complete"]}),tM&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ei.mB,{}),(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),s7(!0)},className:"cursor-pointer text-destructive focus:text-destructive",children:[(0,r.jsx)(T.A,{className:"mr-2 h-4 w-4"}),"Delete job"]})]}),(tE.canDelete||tE.canCancel)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ei.mB,{}),(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),s7(!0)},className:"cursor-pointer text-destructive focus:text-destructive",children:[(0,r.jsx)(T.A,{className:"mr-2 h-4 w-4"}),tE.canDelete?"Delete order":"Cancel order"]})]})]})]}),(0,r.jsx)(el.Bc,{children:(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"ghost",size:"icon",onClick:()=>e2(!1),className:"h-8 w-8",children:"sheet"===sr?(0,r.jsx)(H.A,{className:"h-4 w-4"}):(0,r.jsx)(v.A,{className:"h-4 w-4"})})}),(0,r.jsx)(el.ZI,{children:"Close"})]})})]})]})}),rC=e=>{let s=(0,r.jsxs)(r.Fragment,{children:["discussion"===sg&&sw&&(0,r.jsxs)("div",{className:"flex items-center gap-6 mb-4","data-tour":"messaging-tabs",children:[sb&&(0,r.jsxs)(h.$,{variant:"ghost",onClick:()=>sA("client"),className:(0,eu.cn)("relative h-8 inline-flex items-center gap-1.5 text-[13px] font-medium transition-colors","client"===sC?"text-foreground":"text-muted-foreground hover:text-foreground"),children:[(0,r.jsx)(P.A,{className:"size-3.5"}),"Customer Chat","client"===sC&&(0,r.jsx)("span",{className:"absolute bottom-[-4px] left-0 right-0 h-0.5 bg-primary rounded-full"})]}),sy&&(0,r.jsxs)(h.$,{variant:"ghost",onClick:()=>sA("team"),className:(0,eu.cn)("relative h-8 inline-flex items-center gap-1.5 text-[13px] font-medium transition-colors","team"===sC?"text-foreground":"text-muted-foreground hover:text-foreground"),children:[(0,r.jsx)(F.A,{className:"size-3.5"}),"Team Chat",!e0&&(0,r.jsx)(x.E,{variant:"secondary",className:"ml-1 text-xs h-4 px-1.5",children:"Private"}),"team"===sC&&(0,r.jsx)("span",{className:"absolute bottom-[-4px] left-0 right-0 h-0.5 bg-primary rounded-full"})]})]}),sI&&(0,r.jsxs)("div",{className:"flex items-center justify-between bg-muted p-3 rounded-lg text-sm mb-sm",children:[(0,r.jsxs)("span",{className:"text-muted-foreground",children:["Replying to ",sI.userName]}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",onClick:()=>sT(null),className:"h-6 text-xs",children:"Cancel"})]}),sE.length>0&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mb-2",children:[(0,r.jsx)(eB,{}),(0,r.jsx)("span",{children:0===sE.length?"":1===sE.length?"".concat(sE[0].userName," is typing..."):2===sE.length?"".concat(sE[0].userName," and ").concat(sE[1].userName," are typing..."):"".concat(sE[0].userName," and ").concat(sE.length-1," others are typing...")})]}),(0,r.jsx)("div",{className:"flex flex-col gap-0","data-tour":"messaging-compose",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsxs)(f.eu,{className:"h-8 w-8 shrink-0",children:[(0,r.jsx)(f.BK,{src:sm,alt:eY}),(0,r.jsx)(f.q5,{className:"bg-primary text-primary-foreground text-xs",children:eY.split(" ").map(e=>e[0]).join("")})]}),(0,r.jsxs)("div",{className:"flex-1 relative bg-muted/50 border border-border rounded-2xl overflow-hidden flex flex-col",children:[(0,r.jsx)(l.$Z,{editor:tZ,className:"[&_.ProseMirror]:min-h-[64px] [&_.ProseMirror]:max-h-[200px] [&_.ProseMirror]:overflow-y-auto [&_.ProseMirror]:px-3.5 [&_.ProseMirror]:py-3 [&_.ProseMirror]:text-sm [&_.ProseMirror]:text-foreground [&_.ProseMirror]:focus:outline-none [&_.ProseMirror]:prose [&_.ProseMirror]:prose-sm [&_.ProseMirror]:max-w-none [&_.ProseMirror_p.is-editor-empty:first-child::before]:content-[attr(data-placeholder)] [&_.ProseMirror_p.is-editor-empty:first-child::before]:text-muted-foreground [&_.ProseMirror_p.is-editor-empty:first-child::before]:float-left [&_.ProseMirror_p.is-editor-empty:first-child::before]:pointer-events-none [&_.ProseMirror_p.is-editor-empty:first-child::before]:h-0 [&_.ProseMirror_strong]:font-semibold [&_.ProseMirror_em]:italic [&_.ProseMirror_u]:underline"}),(0,r.jsxs)("div",{className:"flex items-center justify-between px-3.5 py-2 border-t border-border/40",children:[ty?(0,r.jsxs)(ed.AM,{children:[(0,r.jsx)(ed.Wv,{asChild:!0,children:(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 hover:bg-muted",disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(S.A,{className:"size-3.5 text-foreground"})})}),(0,r.jsx)(ed.hl,{className:"w-auto p-2",align:"start",children:(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("bold"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleBold().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(G.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("italic"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleItalic().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(J.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("underline"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleUnderline().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(V.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("strike"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleStrike().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(K.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)("div",{className:"h-4 w-px bg-border mx-0.5"}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("bulletList"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleBulletList().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(Z.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("orderedList"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleOrderedList().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(Q.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 hover:bg-muted",onClick:()=>null==tZ?void 0:tZ.chain().focus().liftListItem("listItem").run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(W.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)("div",{className:"h-4 w-px bg-border mx-0.5"}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("codeBlock"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleCodeBlock().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(Y.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("blockquote"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleBlockquote().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(X.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("link"))&&"bg-muted border border-primary"),onClick:()=>{let e=null==tZ?void 0:tZ.getAttributes("link").href,s=window.prompt("Enter URL:",e);if(null!==s){if(""===s){null==tZ||tZ.chain().focus().extendMarkRange("link").unsetLink().run();return}null==tZ||tZ.chain().focus().extendMarkRange("link").setLink({href:s}).run()}},disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(E.A,{className:"size-3.5 text-foreground"})})]})})]}):(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("bold"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleBold().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(G.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("italic"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleItalic().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(J.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("underline"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleUnderline().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(V.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("strike"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleStrike().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(K.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)("div",{className:"h-4 w-px bg-border mx-0.5"}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("bulletList"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleBulletList().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(Z.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("orderedList"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleOrderedList().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(Q.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 hover:bg-muted",onClick:()=>null==tZ?void 0:tZ.chain().focus().liftListItem("listItem").run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(W.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)("div",{className:"h-4 w-px bg-border mx-0.5"}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("codeBlock"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleCodeBlock().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(Y.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("blockquote"))&&"bg-muted border border-primary"),onClick:()=>null==tZ?void 0:tZ.chain().focus().toggleBlockquote().run(),disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(X.A,{className:"size-3.5 text-foreground"})}),(0,r.jsx)(h.$,{variant:"ghost",size:"sm",className:(0,eu.cn)("h-7 w-7 p-0 hover:bg-muted",(null==tZ?void 0:tZ.isActive("link"))&&"bg-muted border border-primary"),onClick:()=>{let e=null==tZ?void 0:tZ.getAttributes("link").href,s=window.prompt("Enter URL:",e);if(null!==s){if(""===s){null==tZ||tZ.chain().focus().extendMarkRange("link").unsetLink().run();return}null==tZ||tZ.chain().focus().extendMarkRange("link").setLink({href:s}).run()}},disabled:!tZ||e0&&"team"===sC,children:(0,r.jsx)(E.A,{className:"size-3.5 text-foreground"})})]}),(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)("span",{children:(0,r.jsx)(h.$,{onClick:t1,disabled:!tZ||!sL||e0&&"team"===sC||"client"===sC&&!tI,className:"h-[34px] px-[18px] rounded-full bg-primary text-primary-foreground hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,r.jsx)("span",{className:"text-sm font-medium",children:"Comment"})})})}),"client"===sC&&!tI&&(0,r.jsx)(el.ZI,{children:(0,r.jsx)("p",{children:"You can only write to customer chat on projects you manage"})})]})]})]})]})})]});return"page"===sr?(0,r.jsx)("div",{className:"flex flex-col border-t p-4 md:p-6 pt-0 gap-0 bg-background",children:s}):(0,r.jsx)(e,{className:"flex flex-col! border-t p-4 md:p-6 pt-0 gap-0",children:s})},rA=()=>{var e,s;return(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{ref:tb,className:(0,eu.cn)("h-full overflow-y-auto","dialog"===sr?"max-h-[calc(90vh-200px)]":"page"===sr?"h-full":"flex-1"),children:(0,r.jsxs)(ek.tU,{defaultValue:"task",className:"gap-0 size-full px-4 md:px-8",children:[(0,r.jsxs)(ek.j7,{className:"grid w-full grid-cols-2 mt-6",children:[(0,r.jsx)(ek.Xi,{value:"task",onClick:()=>sp("discussion"),className:"flex items-center gap-2 cursor-pointer",children:"Task"}),(0,r.jsx)(ek.Xi,{value:"media",onClick:()=>sp("media"),className:"flex items-center gap-2 cursor-pointer",children:"Media"})]}),(0,r.jsx)(ek.av,{value:"task",className:"mt-0",children:(0,r.jsxs)("div",{className:"py-6 space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-[minmax(0,140px)_1fr] gap-y-3.5",children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Address"}),(0,r.jsx)("div",{className:"text-sm font-medium text-foreground",children:(null==eJ?void 0:eJ.propertyAddress)||"—"}),sh&&(null==eJ?void 0:eJ.organizationName)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Provider"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[eJ.organizationLogoUrl&&(0,r.jsxs)(f.eu,{className:"h-6 w-6",children:[(0,r.jsx)(f.BK,{src:eJ.organizationLogoUrl,alt:eJ.organizationName}),(0,r.jsx)(f.q5,{className:"text-[10px] bg-muted",children:eJ.organizationName.charAt(0).toUpperCase()})]}),(0,r.jsx)("span",{className:"text-sm font-medium text-foreground",children:eJ.organizationName})]})]}),!sh&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Customer"}),(0,r.jsx)("div",{className:"flex items-center",children:tz({isAssigned:"Unassigned"!==t$,name:t$,avatar:null!=(s=null==tU?void 0:tU.avatar)?s:void 0,label:"Assign Customer",onClear:tU?()=>tQ(""):void 0,canEdit:tA,disabled:th,children:(0,r.jsxs)(ei.SQ,{align:"start",className:"w-72 max-h-[300px] overflow-y-auto p-0",children:[(0,r.jsx)("div",{className:"px-2 py-2 sticky top-0 bg-background z-10",children:(0,r.jsx)(eA.p,{placeholder:"Search customers...",value:td,onChange:e=>to(e.target.value),autoFocus:!0})}),(0,r.jsx)(ei.mB,{className:"mb-0"}),tD.map(e=>{var s;return(0,r.jsxs)(ei._2,{onSelect:s=>{s.preventDefault(),tQ(e.id)},className:"flex items-center gap-2",children:[(0,r.jsxs)(f.eu,{className:"h-8 w-8",children:[(0,r.jsx)(f.BK,{src:null!=(s=e.avatar)?s:void 0,alt:e.name}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted",children:tT(e.name)})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:e.name}),e.email&&(0,r.jsx)("span",{className:"text-xs text-muted-foreground",children:e.email})]})]},e.id)}),0===tD.length&&(0,r.jsx)(ei._2,{disabled:!0,children:"No customers found"})]})})})]}),!sN&&(!sh||"Unassigned"!==tB)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"PM Assigned"}),(0,r.jsx)("div",{className:"flex items-center",children:tz({isAssigned:"Unassigned"!==tB,name:tB,avatar:tH,label:"Assign PM",onClear:tP?()=>tW(""):void 0,canEdit:tC,disabled:th,children:(0,r.jsxs)(ei.SQ,{align:"start",className:"w-72 max-h-[300px] overflow-y-auto p-0",children:[(0,r.jsx)("div",{className:"px-2 py-2 sticky top-0 bg-background z-10",children:(0,r.jsx)(eA.p,{placeholder:"Search project managers...",value:tc,onChange:e=>tu(e.target.value),autoFocus:!0})}),(0,r.jsx)(ei.mB,{className:"mb-0"}),tR.map(e=>{var s,t,a,l,n,i;let d=(null==(s=e.user)?void 0:s.id)||e.userId,o=(null==(t=e.user)?void 0:t.name)||(null==(a=e.personalOrg)?void 0:a.legalName)||(null==(l=e.user)?void 0:l.email)||"Assigned",c=null==(n=e.user)?void 0:n.avatarUrl;return(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),d&&tW(d)},className:"flex items-center gap-2",children:[(0,r.jsxs)(f.eu,{className:"h-8 w-8",children:[(0,r.jsx)(f.BK,{src:c,alt:o}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted",children:tT(o)})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:o}),(null==(i=e.user)?void 0:i.email)&&(0,r.jsx)("span",{className:"text-xs text-muted-foreground",children:e.user.email})]})]},e.id)}),0===tR.length&&(0,r.jsx)(ei._2,{disabled:!0,children:"No project managers available"})]})})})]}),!sN&&(!sh||tO)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Tech Assigned"}),(0,r.jsx)("div",{className:"flex items-center",children:tk&&!sh?(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsxs)("button",{onClick:tO?e8:e9,className:(0,eu.cn)("flex items-center gap-2 px-2 py-1 -ml-2 rounded-md transition-colors","hover:bg-muted/50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1"),disabled:tO?(null==eJ?void 0:eJ.status)!=="assigned"&&(null==eJ?void 0:eJ.status)!=="in_progress":!e9,children:[(0,r.jsx)(f.eu,{className:"h-7 w-7",children:tO?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f.BK,{src:tO.avatarUrl,alt:tO.name}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted-foreground/20",children:tT(tO.name)})]}):(0,r.jsx)(f.q5,{className:"text-xs bg-transparent border-2 border-secondary border-dashed"})}),(0,r.jsx)("span",{className:(0,eu.cn)("text-sm",tO?"text-foreground":"text-muted-foreground"),children:tO?tO.name:"Assign Technician"})]}),tO&&e8&&((null==eJ?void 0:eJ.status)==="assigned"||(null==eJ?void 0:eJ.status)==="in_progress")&&(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),e8()},className:(0,eu.cn)("flex items-center justify-center size-5 rounded-full transition-colors","text-muted-foreground hover:text-foreground hover:bg-muted/80","focus:outline-none focus:ring-2 focus:ring-ring"),children:(0,r.jsx)(v.A,{className:"size-3"})})]}):(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.eu,{className:"h-7 w-7",children:tO?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f.BK,{src:tO.avatarUrl,alt:tO.name}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted-foreground/20",children:tT(tO.name)})]}):(0,r.jsx)(f.q5,{className:"text-xs bg-transparent border-2 border-secondary border-dashed"})}),(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:tO?tO.name:"Unassigned"})]})})]}),!sh&&!sN&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Editor Assigned"}),(0,r.jsx)("div",{className:"flex items-center",children:tz({isAssigned:"Unassigned"!==tq,name:tq,avatar:tG,label:"Assign Editor",onClear:tF?()=>tY(""):void 0,canEdit:tk,disabled:th,children:(0,r.jsxs)(ei.SQ,{align:"start",className:"w-72 max-h-[300px] overflow-y-auto p-0",children:[(0,r.jsx)("div",{className:"px-2 py-2 sticky top-0 bg-background z-10",children:(0,r.jsx)(eA.p,{placeholder:"Search editors...",value:tm,onChange:e=>tx(e.target.value),autoFocus:!0})}),(0,r.jsx)(ei.mB,{className:"mb-0"}),t_.map(e=>{var s,t,a,l,n;let i=(null==(s=e.user)?void 0:s.id)||e.userId,d=(null==(t=e.user)?void 0:t.name)||(null==(a=e.personalOrg)?void 0:a.legalName)||"Unassigned",o=null==(l=e.user)?void 0:l.avatarUrl;return(0,r.jsxs)(ei._2,{onSelect:e=>{e.preventDefault(),i&&tY(i)},className:"flex items-center gap-2",children:[(0,r.jsxs)(f.eu,{className:"h-8 w-8",children:[(0,r.jsx)(f.BK,{src:o,alt:d}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted",children:tT(d)})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:d}),(null==(n=e.user)?void 0:n.email)&&(0,r.jsx)("span",{className:"text-xs text-muted-foreground",children:e.user.email})]})]},e.id)}),0===t_.length&&(0,r.jsx)(ei._2,{disabled:!0,children:"No editors available"})]})})})]}),(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Schedule Date"}),(0,r.jsx)("div",{className:"text-sm text-muted-foreground",children:(null==eJ?void 0:eJ.scheduledDate)?(0,et.GP)(new Date(eJ.scheduledDate),"d MMMM yyyy"):"Not scheduled"}),(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center","data-tour":"job-status-section",children:"Status"}),(0,r.jsx)("div",{"data-tour":"job-status-section",children:(0,r.jsxs)(x.E,{variant:"flat",className:"flex items-center gap-1.5 mb-1 px-0",children:[(0,r.jsx)("div",{className:(0,eu.cn)("size-1.5 rounded-full",ra.indicatorColor)}),(0,r.jsx)("span",{className:(0,eu.cn)("text-[13px] font-medium",ra.textColor),children:ra.label})]})}),!sh&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Delivery"}),(0,r.jsx)("div",{children:(0,r.jsx)(eP,{projectId:(null==eJ?void 0:eJ.id)||"",projectStatus:(null==eJ?void 0:eJ.status)||"",canManageDelivery:tw,variant:"inline"})})]}),sh&&(null==eJ||null==(e=eJ.status)?void 0:e.toLowerCase())==="delivered"&&(null==eJ?void 0:eJ.deliveryToken)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Delivery"}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)(h.$,{variant:"outline",size:"sm",className:"h-7 gap-1.5",onClick:()=>window.open("/delivery/".concat(eJ.deliveryToken),"_blank"),children:[(0,r.jsx)(B.A,{className:"h-3.5 w-3.5"}),"View Delivery"]})})]}),(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Tags"}),(0,r.jsx)("div",{className:"flex flex-wrap items-center gap-2",children:((null==eJ?void 0:eJ.mediaType)||[]).map((e,s)=>{let t=(e=>{switch(e){case"photo":default:return j.A;case"video":return b.A;case"aerial":return N.A;case"twilight":return y.A}})(e);return(0,r.jsxs)(x.E,{variant:"muted",children:[(0,r.jsx)(t,{className:"h-3 w-3"}),e.charAt(0).toUpperCase()+e.slice(1)]},e)})}),(0,r.jsx)("div",{className:"text-[13px] font-medium text-muted-foreground tracking-wide self-center",children:"Priority"}),(0,r.jsx)("div",{className:(0,eu.cn)("text-[13px] font-medium",rr.color),children:rr.label})]}),(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsxs)("div",{className:"flex items-center gap-6 border-b border-border pt-2 pb-1",children:[(0,r.jsxs)(h.$,{variant:"ghost",size:ty?"icon":"default",onClick:()=>sp("description"),className:(0,eu.cn)("relative h-8 inline-flex items-center gap-1.5 text-[13px] font-medium transition-colors","description"===sg?"text-foreground":"text-muted-foreground hover:text-foreground"),children:[(0,r.jsx)(k.A,{className:"size-3.5"}),(0,r.jsx)("span",{className:"hidden md:block",children:"Description"}),"description"===sg&&(0,r.jsx)("span",{className:"absolute bottom-[-4px] left-0 right-0 h-0.5 bg-primary rounded-full"})]}),(0,r.jsxs)(h.$,{variant:"ghost",size:ty?"icon":"default",onClick:()=>sp("discussion"),className:(0,eu.cn)("relative h-8 inline-flex items-center gap-1.5 text-[13px] font-medium transition-colors","discussion"===sg?"text-foreground":"text-muted-foreground hover:text-foreground"),children:[(0,r.jsx)(P.A,{className:"size-3.5"}),(0,r.jsx)("span",{className:"hidden md:block",children:"Discussion"}),"discussion"===sg&&(0,r.jsx)("span",{className:"absolute bottom-[-4px] left-0 right-0 h-0.5 bg-primary rounded-full"})]})]})}),(0,r.jsxs)("div",{className:"pt-4 space-y-4",children:["description"===sg&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(ea.H4,{className:"text-sm font-semibold text-muted-foreground mb-2",children:"Location"}),(0,r.jsx)(ea.P,{className:"text-sm",children:(null==eJ?void 0:eJ.propertyAddress)||"—"})]}),(0,r.jsx)(p.w,{}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)(ea.H4,{className:"text-sm font-semibold text-muted-foreground mb-2 flex items-center gap-2",children:[(0,r.jsx)(ee.A,{className:"h-4 w-4"}),"Date"]}),(0,r.jsx)(ea.P,{className:"text-sm",children:(null==eJ?void 0:eJ.scheduledDate)?(()=>{let[e,s,t]=eJ.scheduledDate.split("-").map(Number),r=new Date(e,s-1,t);return(0,et.GP)(r,"MMM d, yyyy")})():"Not scheduled"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)(ea.H4,{className:"text-sm font-semibold text-muted-foreground mb-2 flex items-center gap-2",children:[(0,r.jsx)(es.A,{className:"h-4 w-4"}),"Time"]}),(0,r.jsx)(ea.P,{className:"text-sm",children:(null==eJ?void 0:eJ.scheduledTime)&&(null==eJ?void 0:eJ.estimatedDuration)?(()=>{let e=eJ.estimatedDuration||60,[s,t,r]=eJ.scheduledDate.split("-").map(Number),[a,l]=eJ.scheduledTime.split(":").map(Number),n=new Date(s,t-1,r,a||0,l||0,0,0),i=new Date(n.getTime()+60*e*1e3);Intl.DateTimeFormat().resolvedOptions().timeZone;let d=new Date().toLocaleTimeString("en-US",{timeZoneName:"short"}).split(" ").pop()||"";return"".concat((0,et.GP)(n,"h:mm a")," - ").concat((0,et.GP)(i,"h:mm a")," ").concat(d)})():(null==eJ?void 0:eJ.scheduledTime)||"Not scheduled"})]})]}),(null==eJ?void 0:eJ.requirements)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(p.w,{}),(0,r.jsxs)("div",{children:[(0,r.jsx)(ea.H4,{className:"text-sm font-semibold text-muted-foreground mb-2",children:"Requirements"}),(0,r.jsx)(ea.P,{className:"text-sm whitespace-pre-wrap",children:eJ.requirements})]})]})]}),"discussion"===sg&&(0,r.jsx)("div",{className:"flex flex-col gap-4",children:sx?(0,r.jsxs)("div",{className:"flex flex-col gap-4 py-4 min-h-[400px]",children:[(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)(g.E,{className:"size-8 rounded-full shrink-0"}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(g.E,{className:"h-4 w-24"}),(0,r.jsx)(g.E,{className:"h-16 w-64 rounded-xl"})]})]}),(0,r.jsx)("div",{className:"flex gap-3 justify-end",children:(0,r.jsxs)("div",{className:"space-y-2 flex flex-col items-end",children:[(0,r.jsx)(g.E,{className:"h-4 w-20"}),(0,r.jsx)(g.E,{className:"h-12 w-48 rounded-xl"})]})}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)(g.E,{className:"size-8 rounded-full shrink-0"}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(g.E,{className:"h-4 w-28"}),(0,r.jsx)(g.E,{className:"h-20 w-72 rounded-xl"})]})]}),(0,r.jsx)("div",{className:"flex gap-3 justify-end",children:(0,r.jsxs)("div",{className:"space-y-2 flex flex-col items-end",children:[(0,r.jsx)(g.E,{className:"h-4 w-16"}),(0,r.jsx)(g.E,{className:"h-10 w-40 rounded-xl"})]})})]}):"client"===sC?(0,r.jsx)(eo.F,{className:"flex-1 pr-2 min-h-[400px]",children:(0,r.jsx)("div",{children:0===rb.length?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[(0,r.jsx)(P.A,{className:"h-12 w-12 text-muted-foreground/30 mb-3"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:sh?"No messages yet":"No messages in customer chat yet"}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Start the conversation below"})]}):rb.map((e,s,t)=>{let r=s>0?t[s-1]:null,a=s<t.length-1?t[s+1]:null,l=!r||r.userId!==e.userId,n=!a||a.userId!==e.userId;return rw(e,l,n)})})}):(0,r.jsx)(eo.F,{className:"flex-1 pr-2 min-h-[400px]",children:(0,r.jsx)("div",{children:0===rN.length?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[(0,r.jsx)(P.A,{className:"h-12 w-12 text-muted-foreground/30 mb-3"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"No messages in team chat yet"}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Start the conversation below"})]}):rN.map((e,s,t)=>{let r=s>0?t[s-1]:null,a=s<t.length-1?t[s+1]:null,l=!r||r.userId!==e.userId,n=!a||a.userId!==e.userId;return rw(e,l,n)})})})}),"attachments"===sg&&(0,r.jsx)("div",{className:"text-center py-12 text-muted-foreground text-sm",children:"No attachments yet"})]})]})}),(0,r.jsx)(ek.av,{value:"media",className:"mt-0",children:(0,r.jsx)("div",{className:"py-6",children:sZ?(0,r.jsxs)("div",{className:"flex items-center justify-center gap-2 text-sm text-muted-foreground py-12",children:[(0,r.jsx)(M.A,{className:"h-4 w-4 animate-spin"}),"Loading media..."]}):sh&&!rt?(0,r.jsx)("div",{className:"text-sm text-muted-foreground text-center py-12",children:"No media has been uploaded yet. You’ll see photos, videos, and files here once they’re added."}):(0,r.jsxs)(eC.nD,{type:"multiple",className:"w-full space-y-2",children:[(!sh||rs("image").length>0)&&(0,r.jsxs)(eC.As,{value:"images",className:"border rounded-lg px-4",children:[(0,r.jsx)(eC.$m,{className:"hover:no-underline",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(w.A,{className:"h-5 w-5 text-muted-foreground"}),(0,r.jsx)("span",{className:"font-medium",children:"Images"}),rs("image").length>0&&(0,r.jsx)(x.E,{variant:"secondary",className:"ml-2",children:rs("image").length})]})}),(0,r.jsx)(eC.ub,{children:ro("image",tp)})]}),(!sh||rs("video").length>0)&&(0,r.jsxs)(eC.As,{value:"videos",className:"border rounded-lg px-4",children:[(0,r.jsx)(eC.$m,{className:"hover:no-underline",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(b.A,{className:"h-5 w-5 text-muted-foreground"}),(0,r.jsx)("span",{className:"font-medium",children:"Videos"}),rs("video").length>0&&(0,r.jsx)(x.E,{variant:"secondary",className:"ml-2",children:rs("video").length})]})}),(0,r.jsx)(eC.ub,{children:ro("video",tf)})]}),(!sh||rs("floor-plan").length>0)&&(0,r.jsxs)(eC.As,{value:"floor-plans",className:"border rounded-lg px-4",children:[(0,r.jsx)(eC.$m,{className:"hover:no-underline",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(k.A,{className:"h-5 w-5 text-muted-foreground"}),(0,r.jsx)("span",{className:"font-medium",children:"Floor Plans"}),rs("floor-plan").length>0&&(0,r.jsx)(x.E,{variant:"secondary",className:"ml-2",children:rs("floor-plan").length})]})}),(0,r.jsx)(eC.ub,{children:ro("floor-plan",tv)})]}),(!sh||rs("3d-content").length>0)&&(0,r.jsxs)(eC.As,{value:"3d-content",className:"border rounded-lg px-4",children:[(0,r.jsx)(eC.$m,{className:"hover:no-underline",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(C.A,{className:"h-5 w-5 text-muted-foreground"}),(0,r.jsx)("span",{className:"font-medium",children:"Virtual Tours"}),rs("3d-content").length>0&&(0,r.jsx)(x.E,{variant:"secondary",className:"ml-2",children:rs("3d-content").length})]})}),(0,r.jsx)(eC.ub,{children:ro("3d-content",tj)})]}),(!sh||rs("file").length>0)&&(0,r.jsxs)(eC.As,{value:"files",className:"border rounded-lg px-4",children:[(0,r.jsx)(eC.$m,{className:"hover:no-underline",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(A.A,{className:"h-5 w-5 text-muted-foreground"}),(0,r.jsx)("span",{className:"font-medium",children:"Files"}),rs("file").length>0&&(0,r.jsx)(x.E,{variant:"secondary",className:"ml-2",children:rs("file").length})]})}),(0,r.jsx)(eC.ub,{children:ro("file",tj)})]})]})})})]})})})},rM=eJ?"page"===sr?(0,r.jsxs)("div",{className:"size-full flex flex-col overflow-hidden h-[calc(100vh-var(--header-h))]",children:[(0,r.jsx)("div",{className:"border-b flex-shrink-0",children:rk(u.qp)}),(0,r.jsx)("div",{className:"flex-1 overflow-hidden",children:rA()}),"discussion"===sg&&(0,r.jsx)("div",{className:"flex-shrink-0",children:rC(()=>null)})]}):"dialog"===sr?(0,r.jsx)(m.lG,{open:e1,onOpenChange:e2,children:(0,r.jsxs)(m.Cf,{"data-tour":"job-task-view",className:"md:min-w-[90vw] min-w-[calc(100vw-1rem)] md:max-w-[90vw] md:h-[90vh] h-[calc(100vh-1rem)] md:max-h-[90vh] p-0 gap-0 overflow-hidden flex flex-col [&>button]:hidden",children:[(0,r.jsxs)(m.L3,{className:"sr-only",children:[eJ.propertyAddress," - ",eJ.clientName]}),(0,r.jsx)(m.c7,{className:"border-b",children:rk(m.L3)}),rA(),"discussion"===sg&&rC(m.Es)]})}):(0,r.jsx)(u.cj,{open:e1,onOpenChange:e2,children:(0,r.jsxs)(u.h,{side:"right",className:"w-full sm:max-w-[40vw] md:min-w-[600px] flex flex-col p-0 gap-0","data-tour":"job-task-view",children:[(0,r.jsxs)(u.qp,{className:"sr-only",children:[eJ.propertyAddress," - ",eJ.clientName]}),(0,r.jsx)(u.Fm,{className:"border-b",children:rk(u.qp)}),rA(),"discussion"===sg&&rC(u.XW)]})}):null;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(en.Lt,{open:s3,onOpenChange:s7,children:(0,r.jsxs)(en.EO,{children:[(0,r.jsxs)(en.wd,{children:[(0,r.jsx)(en.r7,{children:sh?tE.canDelete?"Delete order":"Cancel order":"Delete job"}),(0,r.jsx)(en.$v,{children:sh?tE.canDelete?"This will permanently remove this order. Are you sure you want to continue?":"This will cancel your order. The provider will be notified. Are you sure you want to continue?":"This will permanently remove the job and its data. Are you sure you want to continue?"})]}),(0,r.jsxs)(en.ck,{children:[(0,r.jsx)(en.Zr,{onClick:()=>s7(!1),disabled:s6,children:"Go back"}),(0,r.jsxs)(en.Rx,{onClick:t9,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:s6,children:[s6&&(0,r.jsx)(M.A,{className:"mr-2 h-4 w-4 animate-spin"}),sh?tE.canDelete?"Delete order":"Cancel order":"Delete job"]})]})]})}),(0,r.jsx)(en.Lt,{open:null!==sP,onOpenChange:e=>!e&&t6(),children:(0,r.jsxs)(en.EO,{children:[(0,r.jsxs)(en.wd,{children:[(0,r.jsx)(en.r7,{children:"Delete Message"}),(0,r.jsx)(en.$v,{children:sP&&(eQ.some(e=>e.threadId===sP)?"This message has replies. Only the message will be deleted, replies will remain.":"Are you sure you want to delete this message? This action cannot be undone.")})]}),(0,r.jsxs)(en.ck,{children:[(0,r.jsx)(en.Zr,{onClick:t6,children:"Cancel"}),(0,r.jsx)(en.Rx,{onClick:t7,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete"})]})]})}),(0,r.jsx)(en.Lt,{open:s1.open,onOpenChange:e=>s2({open:e,service:""}),children:(0,r.jsxs)(en.EO,{children:[(0,r.jsxs)(en.wd,{children:[(0,r.jsxs)(en.r7,{children:[s1.service," Integration"]}),(0,r.jsxs)(en.$v,{children:[s1.service," integration is coming soon! This feature will allow you to directly attach files from your"," ",s1.service," account."]})]}),(0,r.jsx)(en.ck,{children:(0,r.jsx)(en.Rx,{onClick:()=>{s2({open:!1,service:""}),s5(null)},children:"Got it"})})]})}),rM,(()=>{if(!sz)return null;let e=rv(sz.id);return(0,r.jsx)(u.cj,{open:!!sz,onOpenChange:()=>sS(null),children:(0,r.jsxs)(u.h,{side:"right",className:"w-full sm:max-w-md p-0 flex flex-col",children:[(0,r.jsx)(u.Fm,{className:"px-4 py-3 border-b",children:(0,r.jsx)(u.qp,{className:"text-base",children:"Thread"})}),(0,r.jsx)(eo.F,{className:"flex-1 px-4",children:(0,r.jsx)("div",{className:"py-4 space-y-1",children:e.map((e,s)=>{let t=e.userId===eW,a=0===s;return(0,r.jsxs)("div",{className:(0,eu.cn)("flex mb-2",t?"justify-end":"justify-start"),children:[!t&&(0,r.jsxs)(f.eu,{className:"h-7 w-7 mr-2 mt-auto mb-1 flex-shrink-0",children:[(0,r.jsx)(f.BK,{src:e.userAvatar,alt:e.userName}),(0,r.jsx)(f.q5,{className:"text-xs bg-muted",children:e.userName.split(" ").map(e=>e[0]).join("")})]}),(0,r.jsxs)("div",{className:(0,eu.cn)("flex flex-col max-w-[80%]",t?"items-end":"items-start"),children:[!t&&(0,r.jsx)("span",{className:"text-xs text-muted-foreground ml-1 mb-0.5",children:e.userName}),(0,r.jsxs)("div",{className:(0,eu.cn)("relative px-3 py-2 rounded-2xl shadow-sm",t?"bg-primary text-primary-foreground rounded-br-md":"bg-muted text-foreground rounded-bl-md",a&&"ring-2 ring-primary/20"),children:[a&&(0,r.jsx)("div",{className:"text-[10px] font-medium mb-1 opacity-70",children:"Original message"}),(0,r.jsx)("div",{className:(0,eu.cn)("text-sm leading-relaxed prose prose-sm max-w-none","[&_p]:mb-1 [&_p:last-child]:mb-0",t?"[&_a]:text-primary-foreground":"[&_a]:text-primary"),dangerouslySetInnerHTML:{__html:e.content}}),(0,r.jsx)("div",{className:(0,eu.cn)("flex items-center gap-1 mt-1",t?"justify-end":"justify-start"),children:(0,r.jsxs)(el.m_,{children:[(0,r.jsx)(el.k$,{asChild:!0,children:(0,r.jsx)("span",{className:(0,eu.cn)("text-[10px] cursor-default",t?"text-primary-foreground/70":"text-muted-foreground"),children:(0,et.GP)(new Date(e.createdAt),"h:mm a")})}),(0,r.jsx)(el.ZI,{side:"top",className:"text-xs",children:(0,et.GP)(new Date(e.createdAt),"EEEE, MMMM d, yyyy 'at' h:mm a")})]})})]})]})]},e.id)})})})]})})})()]})}},51539:(e,s,t)=>{t.d(s,{$m:()=>o,As:()=>d,nD:()=>i,ub:()=>c});var r=t(95155);t(12115);var a=t(58609),l=t(24033),n=t(64936);function i(e){let{...s}=e;return(0,r.jsx)(a.bL,{"data-slot":"accordion",...s})}function d(e){let{className:s,...t}=e;return(0,r.jsx)(a.q7,{"data-slot":"accordion-item",className:(0,n.cn)("border-b last:border-b-0",s),...t})}function o(e){let{className:s,children:t,...i}=e;return(0,r.jsx)(a.Y9,{className:"flex",children:(0,r.jsxs)(a.l9,{"data-slot":"accordion-trigger",className:(0,n.cn)("focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",s),...i,children:[t,(0,r.jsx)(l.A,{className:"text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200"})]})})}function c(e){let{className:s,children:t,...l}=e;return(0,r.jsx)(a.UC,{"data-slot":"accordion-content",className:"data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm",...l,children:(0,r.jsx)("div",{className:(0,n.cn)("pt-0 pb-4",s),children:t})})}},69802:(e,s,t)=>{t.d(s,{w:()=>u,I:()=>m});var r=t(95155),a=t(12115),l=t(95657),n=t(9829);class i{connect(e){if(this.socket&&this.socket.connected)return;let s=e||localStorage.getItem("token")||void 0;this.socket=(0,n.io)("".concat("http://localhost:3001","/chat"),{autoConnect:!0,transports:["websocket"],auth:{token:s}}),this.socket.on("connect_error",e=>{{let s=e.message||"WebSocket connection failed";window.dispatchEvent(new CustomEvent("backend-websocket-error",{detail:{message:"WebSocket: ".concat(s)}}))}}),this.socket.on("connect",()=>{window.dispatchEvent(new CustomEvent("backend-websocket-success"))}),this.socket.on("disconnect",e=>{"io client disconnect"!==e&&window.dispatchEvent(new CustomEvent("backend-websocket-error",{detail:{message:"WebSocket disconnected: ".concat(e)}}))}),this.socket.on("messageCreated",e=>{let s=this.mapIncomingMessage(e);s&&this.messageHandlers.forEach(e=>e(s))}),this.socket.on("userTyping",e=>{this.typingHandlers.forEach(s=>s(e))}),this.socket.on("presenceUpdate",e=>{this.presenceUpdateHandlers.forEach(s=>s(e))}),this.socket.on("presenceList",e=>{this.presenceListHandlers.forEach(s=>s(e))}),this.socket.on("messagesRead",e=>{this.messagesReadHandlers.forEach(s=>s(e))})}disconnect(){this.socket&&(this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null),this.typingDebounceTimers.forEach(e=>clearTimeout(e)),this.typingDebounceTimers.clear(),this.typingState.clear()}async joinProject(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"TEAM";return this.socket||this.connect(),new Promise((t,r)=>{var a;null==(a=this.socket)||a.emit("joinProject",{projectId:e,channel:s},e=>{(null==e?void 0:e.error)?r(Error(e.error)):t()})})}async sendMessage(e,s){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"TEAM",r=arguments.length>3?arguments[3]:void 0;return this.socket||this.connect(),new Promise((a,l)=>{var n;null==(n=this.socket)||n.emit("sendMessage",{projectId:e,content:s,channel:t,thread:r},e=>{if(null==e?void 0:e.error)l(Error(e.error));else{let s=this.mapIncomingMessage(e);s?a(s):l(Error("Malformed message payload"))}})})}onMessage(e){this.messageHandlers.add(e)}offMessage(e){this.messageHandlers.delete(e)}emitTyping(e,s,t){var r,a;let l="".concat(e,":").concat(s),n=this.typingState.get(l),i=this.typingDebounceTimers.get(l);if(i&&(clearTimeout(i),this.typingDebounceTimers.delete(l)),t){n||(this.typingState.set(l,!0),null==(r=this.socket)||r.emit("typing",{projectId:e,channel:s,isTyping:!0}));let t=setTimeout(()=>{var t;this.typingState.set(l,!1),null==(t=this.socket)||t.emit("typing",{projectId:e,channel:s,isTyping:!1}),this.typingDebounceTimers.delete(l)},2e3);this.typingDebounceTimers.set(l,t)}else n&&(this.typingState.set(l,!1),null==(a=this.socket)||a.emit("typing",{projectId:e,channel:s,isTyping:!1}))}stopTyping(e,s){this.emitTyping(e,s,!1)}onTyping(e){this.typingHandlers.add(e)}offTyping(e){this.typingHandlers.delete(e)}onPresenceUpdate(e){this.presenceUpdateHandlers.add(e)}offPresenceUpdate(e){this.presenceUpdateHandlers.delete(e)}onPresenceList(e){this.presenceListHandlers.add(e)}offPresenceList(e){this.presenceListHandlers.delete(e)}async markMessagesRead(e,s,t){return this.socket||this.connect(),new Promise((r,a)=>{var l;null==(l=this.socket)||l.emit("markRead",{messageIds:s,projectId:e,channel:t},e=>{(null==e?void 0:e.error)?a(Error(e.error)):r({success:e.success,markedCount:e.markedCount})})})}onMessagesRead(e){this.messagesReadHandlers.add(e)}offMessagesRead(e){this.messagesReadHandlers.delete(e)}mapIncomingMessage(e){var s,t,r,a,l,n;if(!e)return null;let i=e.channel||((null==(s=e.user)?void 0:s.accountType)==="AGENT"||(null==(t=e.user)?void 0:t.account_type)==="AGENT"?"CUSTOMER":"TEAM");return{id:e.id,jobId:e.projectId,userId:e.userId,userName:(null==(r=e.user)?void 0:r.name)||"Unknown User",userAvatar:null==(a=e.user)?void 0:a.avatarUrl,content:e.content,createdAt:new Date(e.timestamp||e.createdAt||new Date),channel:i,thread:null!=(l=e.thread)?l:null,threadId:null!=(n=e.thread)?n:null,chatType:"CUSTOMER"===i?"client":"team"}}constructor(){this.socket=null,this.messageHandlers=new Set,this.typingHandlers=new Set,this.presenceUpdateHandlers=new Set,this.presenceListHandlers=new Set,this.messagesReadHandlers=new Set,this.typingDebounceTimers=new Map,this.typingState=new Map}}let d=new i;var o=t(18720);let c=(0,a.createContext)(void 0);function u(e){let{children:s,defaultUserId:t,defaultUserName:n,defaultUserAvatar:i}=e,[u,m]=(0,a.useState)([]),[x,h]=(0,a.useState)(t),[g,p]=(0,a.useState)(n),[f,v]=(0,a.useState)(i),[j,b]=(0,a.useState)(!1),[N,y]=(0,a.useState)(new Set),w=(0,a.useRef)(new Map),k=(0,a.useRef)(new Set),[C,A]=(0,a.useState)(new Map),[M,E]=(0,a.useState)(new Map),[I,T]=(0,a.useState)(new Map);(0,a.useEffect)(()=>(d.connect(),b(!0),()=>{d.disconnect(),b(!1)}),[]),(0,a.useEffect)(()=>{let e=e=>{m(s=>s.some(s=>s.id===e.id)?s:[...s,e])};return d.onMessage(e),()=>d.offMessage(e)},[]),(0,a.useEffect)(()=>{let e=e=>{if(e.userId===x)return;let s="".concat(e.projectId,":").concat(e.channel);A(t=>{let r=new Map(t),a=new Map(r.get(s)||new Map);return e.isTyping?a.set(e.userId,{userId:e.userId,userName:e.userName}):a.delete(e.userId),a.size>0?r.set(s,a):r.delete(s),r})};return d.onTyping(e),()=>d.offTyping(e)},[x]),(0,a.useEffect)(()=>{let e=e=>{e.projectId&&E(s=>{let t=new Map(s),r=new Map(t.get(e.projectId)||new Map);return e.isOnline?r.set(e.userId,{userId:e.userId,userName:e.userName,isOnline:!0}):r.delete(e.userId),t.set(e.projectId,r),t})},s=e=>{E(s=>{let t=new Map(s),r=new Map;for(let s of e.users)r.set(s.userId,s);return t.set(e.projectId,r),t})};return d.onPresenceUpdate(e),d.onPresenceList(s),()=>{d.offPresenceUpdate(e),d.offPresenceList(s)}},[]),(0,a.useEffect)(()=>{let e=e=>{T(s=>{let t=new Map(s);for(let s of e.messageIds){let r=t.get(s)||[];r.some(s=>s.userId===e.readBy.userId)||t.set(s,[...r,{userId:e.readBy.userId,userName:e.readBy.userName,readAt:new Date(e.readAt)}])}return t})};return d.onMessagesRead(e),()=>d.offMessagesRead(e)},[]);let z=(0,a.useCallback)(e=>u.filter(s=>s.jobId===e),[u]),S=(0,a.useCallback)(e=>N.has(e),[N]),D=(0,a.useCallback)(async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"TEAM",t=arguments.length>2?arguments[2]:void 0,r="".concat(e,":").concat(s),a=Date.now(),n=w.current.get(r);if((!n||!(a-n<5e3))&&!k.current.has(r)){k.current.add(r),y(s=>new Set(s).add(e));try{t&&l.F.organizations.setActiveOrganization(t);let a=await l.F.chat.getMessages(e,s);w.current.set(r,Date.now());let n=a.map(e=>({...e,createdAt:new Date(e.createdAt),channel:e.channel||s,chatType:"CUSTOMER"===(e.channel||s)?"client":"team"}));m(t=>[...t.filter(t=>t.jobId!==e||t.channel!==s),...n]),j&&d.joinProject(e,s).catch(()=>{})}catch(e){console.error("Error fetching messages:",e)}finally{k.current.delete(r),y(s=>{let t=new Set(s);return t.delete(e),t})}}},[j]),R=(0,a.useCallback)(async(e,s,t,r)=>{if(!x||!g)return void console.warn("Cannot send message: user info not set");try{let a=null;if(j)a=await d.sendMessage(e,s,t,r);else{let n=await l.F.chat.sendMessage(e,s,t,r);a={...n,jobId:e,userId:x,userName:g,userAvatar:f,content:s,channel:t,chatType:"CUSTOMER"===t?"client":"team",thread:r||null,threadId:r||void 0,createdAt:new Date(n.createdAt||new Date)}}a&&(m(e=>[...e,a]),window.dispatchEvent(new CustomEvent("messageCreated",{detail:a})))}catch(e){console.error("Error sending message:",e),o.oR.error("Failed to send message")}},[j,x,g,f]),_=(0,a.useCallback)((e,s)=>{m(t=>t.map(t=>t.id===e?{...t,content:s}:t));let t=localStorage.getItem("chatMessages");if(t){let r=JSON.parse(t).map(t=>t.id===e?{...t,content:s}:t);localStorage.setItem("chatMessages",JSON.stringify(r))}window.dispatchEvent(new CustomEvent("messageUpdated",{detail:{messageId:e,content:s}}))},[]),U=(0,a.useCallback)(async e=>{m(s=>s.filter(s=>s.id!==e));let s=localStorage.getItem("chatMessages");if(s){let t=JSON.parse(s).filter(s=>s.id!==e);localStorage.setItem("chatMessages",JSON.stringify(t))}try{await l.F.messages.delete(e)}catch(e){console.error("Failed to delete message on backend",e)}window.dispatchEvent(new CustomEvent("messageDeleted",{detail:{messageId:e}}))},[]),P=(0,a.useCallback)((e,s,t)=>{h(e),p(s),v(t)},[]),F=(0,a.useCallback)((e,s)=>{let t="".concat(e,":").concat(s),r=C.get(t);return r?Array.from(r.values()):[]},[C]),L=(0,a.useCallback)((e,s)=>{d.emitTyping(e,s,!0)},[]),O=(0,a.useCallback)((e,s)=>{d.stopTyping(e,s)},[]),$=(0,a.useCallback)(e=>{let s=M.get(e);return s?Array.from(s.values()):[]},[M]),B=(0,a.useCallback)((e,s)=>{var t;let r=M.get(e);return null!=(t=null==r?void 0:r.has(s))&&t},[M]),q=(0,a.useCallback)(e=>I.get(e)||[],[I]),H=(0,a.useCallback)((e,s,t)=>{j&&0!==s.length&&d.markMessagesRead(e,s,t).catch(e=>{console.error("Failed to mark messages as read:",e)})},[j]);return(0,r.jsx)(c.Provider,{value:{messages:u,getMessagesForJob:z,fetchMessages:D,isLoadingMessages:S,sendMessage:R,editMessage:_,deleteMessage:U,getTypingUsers:F,emitTyping:L,stopTyping:O,getOnlineUsers:$,isUserOnline:B,getMessageReadReceipts:q,markMessagesAsRead:H,currentUserId:x,currentUserName:g,currentUserAvatar:f,setUserInfo:P},children:s})}function m(){let e=(0,a.useContext)(c);if(void 0===e)throw Error("useMessaging must be used within a MessagingProvider");return e}},89617:(e,s,t)=>{t.d(s,{Q:()=>l});var r=t(12115),a=t(65939);function l(){let{memberships:e,activeOrganizationId:s,switchOrganization:t}=(0,a.A)(),l=(0,r.useMemo)(()=>s&&e.find(e=>e.orgId===s)||null,[s,e]);return{memberships:e,activeOrganizationId:s,activeMembership:l,setActiveOrganization:t}}},90923:(e,s,t)=>{t.d(s,{Xi:()=>d,av:()=>o,j7:()=>i,tU:()=>n});var r=t(95155);t(12115);var a=t(25667),l=t(64936);function n(e){let{className:s,...t}=e;return(0,r.jsx)(a.bL,{"data-slot":"tabs",className:(0,l.cn)("flex flex-col gap-2",s),...t})}function i(e){let{className:s,...t}=e;return(0,r.jsx)(a.B8,{"data-slot":"tabs-list",className:(0,l.cn)("bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-md p-[3px] flex",s),...t})}function d(e){let{className:s,...t}=e;return(0,r.jsx)(a.l9,{"data-slot":"tabs-trigger",className:(0,l.cn)("data-[state=active]:bg-card dark:data-[state=active]:text-foreground focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:bg-background text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 hover:bg-secondary cursor-pointer",s),...t})}function o(e){let{className:s,...t}=e;return(0,r.jsx)(a.UC,{"data-slot":"tabs-content",className:(0,l.cn)("flex-1 outline-none",s),...t})}}}]);