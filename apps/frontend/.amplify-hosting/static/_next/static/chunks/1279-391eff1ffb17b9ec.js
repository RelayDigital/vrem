"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1279,5939],{25703:(e,t,o)=>{o.d(t,{AY:()=>m,Mw:()=>h,Wo:()=>d,ue:()=>g});var r=o(95155),a=o(12115),n=o(20063),i=o(84579);o(52516);var s=o(95657),l=o(18720),c=o(65939);let d={DASHBOARD_OVERVIEW:{title:"Dashboard Overview",description:"Learn how to navigate your dashboard and understand key metrics",icon:"\uD83D\uDCCA",route:"/dashboard"},JOB_MANAGEMENT:{title:"Job Management",description:"Master viewing and tracking jobs",icon:"\uD83D\uDCCB",route:"/jobs/all-jobs"},MESSAGING_CHAT:{title:"Messaging & Chat",description:"Communicate with your team and customers",icon:"\uD83D\uDCAC",route:"/jobs/all-jobs"},SETTINGS_INTEGRATIONS:{title:"Settings & Integrations",description:"Configure your account and connect external services",icon:"⚙️",route:"/settings/account"}},u=(0,a.createContext)(void 0);function g(e,t){let o=p[e];if(!(null==t?void 0:t.accountType))return o;let{accountType:r,orgType:a,orgRole:n}=t,i="PERSONAL"===a&&"COMPANY"===r?"PROVIDER":r;return o.filter(e=>!e.allowedAccountTypes||(1===e.allowedAccountTypes.length&&"COMPANY"===e.allowedAccountTypes[0]?"PERSONAL"!==a&&"COMPANY"===a&&("OWNER"===n||"ADMIN"===n):e.allowedAccountTypes.includes(i)))}let p={DASHBOARD_OVERVIEW:[{id:"agent-welcome",targetSelector:'[data-tour="dashboard-article"]',title:"Welcome to Your Dashboard!",description:"This is your central hub for ordering and tracking real estate media. Let's take a quick tour.",placement:"bottom",allowedAccountTypes:["AGENT"]},{id:"agent-create-order",targetSelector:'[data-tour="jobs-create-button"]',title:"Create New Orders",description:"Click here to order photography, videography, or other media services for your listings.",placement:"bottom",allowedAccountTypes:["AGENT"]},{id:"agent-stats",targetSelector:'[data-tour="agent-stats"]',title:"Order Status",description:"Track the status of all your orders at a glance - pending, in progress, and completed.",placement:"bottom",allowedAccountTypes:["AGENT"]},{id:"agent-jobs-tabs",targetSelector:'[data-tour="jobs-tabs"]',title:"Filter Your Orders",description:"Use these tabs to filter orders by status. Quickly find pending, assigned, in-progress, or completed jobs.",placement:"bottom",allowedAccountTypes:["AGENT"]},{id:"agent-jobs-list",targetSelector:'[data-tour="agent-jobs-list"]',title:"Your Orders",description:"View all your media orders here. Click any order to see details, track progress, or communicate with your provider.",placement:"top",allowedAccountTypes:["AGENT"]},{id:"dashboard-welcome",targetSelector:'[data-tour="dashboard-article"]',title:"Welcome to Your Dashboard!",description:"This is your central hub for managing all your real estate media projects. Let's take a quick tour.",placement:"bottom",allowedAccountTypes:["PROVIDER"]},{id:"dashboard-metrics",targetSelector:'[data-tour="dashboard-metrics"]',title:"Key Metrics",description:"Track your performance with real-time statistics including active jobs, completed projects, and ratings.",placement:"bottom",allowedAccountTypes:["PROVIDER"]},{id:"dashboard-calendar",targetSelector:'[data-tour="dashboard-calendar"]',title:"Your Schedule",description:"View your upcoming jobs on the calendar. Click any event to see job details.",placement:"top",allowedAccountTypes:["PROVIDER"]},{id:"dashboard-map",targetSelector:'[data-tour="dashboard-map"]',title:"Live Job Map",description:"See all your scheduled jobs on an interactive map. Click pins to view job details and get directions.",placement:"top",allowedAccountTypes:["PROVIDER"]},{id:"dashboard-jobs",targetSelector:'[data-tour="dashboard-jobs"]',title:"Active Jobs",description:"Quick access to your current projects. Click any job to view details or update status.",placement:"top",allowedAccountTypes:["PROVIDER"]}],JOB_MANAGEMENT:[{id:"agent-jobs-intro",targetSelector:'[data-tour="agent-jobs-list"]',title:"Your Orders",description:"Here you can see all your media orders. We've created a demo order to show you around.",placement:"top",allowedAccountTypes:["AGENT"]},{id:"agent-jobs-open-demo",targetSelector:'[data-tour="agent-jobs-list"]',title:"View Order Details",description:"Click on the demo order to see its full details, track progress, and communicate with your provider.",placement:"top",allowedAccountTypes:["AGENT"],openDemoProject:!0,requiresInteraction:!0,actionText:"Click the demo order card to continue"},{id:"agent-job-details",targetSelector:'[data-tour="job-task-view"]',title:"Order Details",description:"This panel shows all information about your order including status, scheduled time, and property details.",placement:"left",allowedAccountTypes:["AGENT"]},{id:"agent-job-status",targetSelector:'[data-tour="job-status-section"]',title:"Track Order Status",description:"Watch your order progress through each stage: Booked → Shooting → Editing → Delivered.",placement:"left",allowedAccountTypes:["AGENT"]},{id:"agent-job-chat",targetSelector:'[data-tour="messaging-section"], [data-tour="messaging-compose"]',title:"Message Your Provider",description:"Use the chat to communicate directly with your media provider about this order.",placement:"top",allowedAccountTypes:["AGENT"]},{id:"jobs-overview",targetSelector:'[data-tour="jobs-header"], [data-tour="jobs-view"]',title:"Job Management",description:"This is where you view and manage all your photography and videography jobs.",placement:"bottom",allowedAccountTypes:["PROVIDER"]},{id:"jobs-filters",targetSelector:'[data-tour="jobs-filters"]',title:"Search & Filter",description:"Search for jobs by address or client name, filter by status or priority, and sort by date or client.",placement:"bottom",allowedAccountTypes:["PROVIDER"]},{id:"jobs-list",targetSelector:'[data-tour="jobs-list"]',title:"Job Cards",description:"Each card shows key job info including address, status, and scheduled time. Click any job to see full details.",placement:"top",allowedAccountTypes:["PROVIDER"]},{id:"jobs-status-provider",targetSelector:'[data-tour="jobs-list"]',title:"Update Job Status",description:"As you complete work, update the job status to keep everyone informed. Jobs progress from Assigned → In Progress → Editing → Delivered.",placement:"top",allowedAccountTypes:["PROVIDER"]},{id:"jobs-assign",targetSelector:'[data-tour="jobs-list"]',title:"Assign Team Members",description:"Assign photographers, videographers, and editors to jobs. They'll receive automatic notifications.",placement:"top",allowedAccountTypes:["COMPANY"]}],MESSAGING_CHAT:[{id:"messaging-intro",targetSelector:'[data-tour="jobs-list"]',title:"Job Messaging",description:"Every job has built-in messaging. Click on the demo job to see the chat feature.",placement:"top",allowedAccountTypes:["PROVIDER"],openDemoProject:!0,requiresInteraction:!0,actionText:"Click the demo job card to continue"},{id:"messaging-task-view",targetSelector:'[data-tour="job-task-view"]',title:"Job Details & Chat",description:"This is the job detail view where you can see all job information and communicate via chat.",placement:"left",allowedAccountTypes:["PROVIDER"]},{id:"messaging-channels",targetSelector:'[data-tour="messaging-tabs"]',title:"Message Channels",description:"Each job has two channels: Team Chat (internal discussions) and Customer Chat (client-facing messages).",placement:"bottom",allowedAccountTypes:["COMPANY"]},{id:"messaging-customer-chat",targetSelector:'[data-tour="messaging-section"], [data-tour="messaging-compose"]',title:"Customer Chat",description:"Use the chat to communicate with your customers about this job. All messages are saved for your reference.",placement:"top",allowedAccountTypes:["PROVIDER"]},{id:"messaging-compose",targetSelector:'[data-tour="messaging-compose"]',title:"Send Messages",description:"Type your message and press Enter to send. You can also attach files and images.",placement:"top",allowedAccountTypes:["PROVIDER"]}],SETTINGS_INTEGRATIONS:[{id:"settings-welcome",targetSelector:'[data-tour="settings-header"]',title:"Settings & Preferences",description:"Configure your account, connect calendars, and manage your preferences here.",placement:"bottom",route:"/settings/account"},{id:"settings-navigation",targetSelector:'[data-tour="settings-nav"]',title:"Settings Navigation",description:"Use the sidebar to navigate between different settings sections: Personal, Organization, Security, and more.",placement:"right"},{id:"settings-account",targetSelector:'[data-tour="settings-content"]',title:"Account Settings",description:"Update your name, email, and profile information. Changes are saved automatically.",placement:"left"},{id:"settings-tour-restart",targetSelector:'[data-tour="settings-tour-section"]',title:"Restart the Tour Anytime",description:"You can always come back here to restart the setup guide and revisit any of the tutorials whenever you need a refresher.",placement:"top"},{id:"settings-calendar",targetSelector:'[data-tour="settings-calendar-link"]',title:"Calendar Integration",description:"Connect your Google or Outlook calendar to automatically sync your job schedule.",placement:"right",route:"/settings/calendar",allowedAccountTypes:["PROVIDER"]},{id:"settings-notifications",targetSelector:'[data-tour="settings-notifications-link"]',title:"Notification Preferences",description:"Control how and when you receive notifications about jobs, messages, and updates.",placement:"right"},{id:"settings-org",targetSelector:'[data-tour="settings-org-section"]',title:"Organization Settings",description:"Manage your company profile, team members, and billing information.",placement:"right",allowedAccountTypes:["COMPANY"]}]};function m(e){let{children:t}=e,o=(0,n.useRouter)(),p=(0,n.usePathname)(),{user:m,activeOrganizationId:h,memberships:v}=(0,c.A)(),w=(0,a.useMemo)(()=>{var e;if(!m||!h||!v)return{accountType:null==m?void 0:m.accountType};let t=v.find(e=>e.orgId===h);if(!t)return{accountType:m.accountType};let o=(null==(e=t.organization)?void 0:e.type)||"PERSONAL",r=t.orgRole||t.role||"MEMBER";return{accountType:m.accountType,orgType:o,orgRole:r}},[m,h,v]),[b,f]=(0,a.useState)(null),[y,E]=(0,a.useState)(!0),[A,S]=(0,a.useState)(null),[T,I]=(0,a.useState)(null),[C,k]=(0,a.useState)(0),[O,j]=(0,a.useState)(!1),R=(0,a.useRef)(null),N=(0,a.useRef)(0),P=(0,a.useRef)(!1),F=(0,a.useRef)(null),D=(0,a.useRef)(null),x=(0,a.useRef)(!1),z=(0,a.useRef)(null),M=["JOB_MANAGEMENT","MESSAGING_CHAT"],G=(0,a.useCallback)(()=>{F.current&&window.dispatchEvent(new CustomEvent("openJobTaskView",{detail:{id:F.current}}))},[]),V=(0,a.useCallback)(async()=>{try{E(!0),S(null);let e=await s.F.tours.getStatus();if(f(e),e.hasDemoProject&&!O&&!P.current){console.log("Found orphaned demo project, cleaning up...");let t=e.demoProjectId;try{await s.F.tours.deleteDemoProject(),t&&window.dispatchEvent(new CustomEvent("jobDeleted",{detail:{jobId:t}})),window.dispatchEvent(new CustomEvent("tourDemoProjectChanged"))}catch(e){console.error("Failed to cleanup orphaned demo project:",e)}}}catch(e){console.error("Failed to fetch tour status:",e),S(e.message||"Failed to load tour status")}finally{E(!1)}},[O]);(0,a.useEffect)(()=>{V()},[V]);let _=(0,a.useRef)(!1);(0,a.useEffect)(()=>()=>{P.current&&s.F.tours.deleteDemoProject().catch(console.error)},[]);let L=(0,a.useCallback)(e=>{var t,o;return null!=(o=null==b||null==(t=b.trackProgress)?void 0:t[e])?o:null},[b]),B=["DASHBOARD_OVERVIEW","JOB_MANAGEMENT","MESSAGING_CHAT","SETTINGS_INTEGRATIONS"],Y=(0,a.useCallback)(()=>{let e=B.reduce((e,t)=>{var o,r;let a=g(t,w);if(0===a.length)return e;let n=null==b||null==(o=b.trackProgress)?void 0:o[t];return{completed:e.completed+(null!=(r=null==n?void 0:n.completed)?r:0),total:e.total+a.length}},{completed:0,total:0});return{...e,percentage:e.total>0?Math.round(e.completed/e.total*100):0}},[b,w]),J=(0,a.useCallback)(e=>e.map(e=>{let t=e.requiresInteraction||e.openDemoProject,o=e.description;if(t){let t=e.actionText||"Click the highlighted element to continue";o="".concat(e.description,"\n\n\uD83D\uDC46 **").concat(t,"**")}return{element:e.targetSelector,popover:{title:e.title,description:o,side:e.placement||"bottom",align:"center",showButtons:t?["previous","close"]:["next","previous","close"],popoverClass:t?"vrem-tour-popover vrem-tour-requires-interaction":"vrem-tour-popover"}}}),[]),U=(0,a.useCallback)(()=>{window.dispatchEvent(new CustomEvent("tourDemoProjectChanged"))},[]),q=(0,a.useCallback)(async()=>{if(P.current){let e=F.current;try{await s.F.tours.deleteDemoProject(),P.current=!1,F.current=null,e&&window.dispatchEvent(new CustomEvent("jobDeleted",{detail:{jobId:e}})),U()}catch(e){console.error("Failed to delete demo project:",e)}}},[U]),W=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=g(e,w);if(!r||0===r.length)return void l.oR.error("Tour steps not configured");let a=Math.min(Math.max(0,t),r.length-1);I(e),k(a),j(!0),z.current=e,setTimeout(()=>{let t=(0,i.B)({showProgress:!0,animate:!0,allowClose:!0,overlayColor:"rgba(0, 0, 0, 0.75)",stagePadding:10,popoverClass:"vrem-tour-popover",steps:J(r),onDestroyStarted:()=>{q(),z.current=null,x.current=!1,j(!1),I(null),k(0)},onHighlightStarted:(t,o,a)=>{let n=r[a.state.activeIndex||0];n&&(s.F.tours.updateProgress({tourTrack:e,stepId:n.id,completed:!1}).catch(console.error),n.requiresInteraction||n.openDemoProject?x.current=!0:x.current=!1)},onNextClick:(a,n,c)=>{let u=c.state.activeIndex||0,g=r[u],m=r[u+1],h=u===r.length-1;if(g&&s.F.tours.updateProgress({tourTrack:e,stepId:g.id,completed:!0}).catch(console.error),h){s.F.tours.completeTrack(e).catch(console.error),q(),t.destroy(),j(!1),I(null),k(0),V(),l.oR.success("".concat(d[e].title," completed!"));return}if((null==g?void 0:g.openDemoProject)&&F.current){G();let e=()=>{document.querySelector('[data-tour="job-task-view"]')?(k(u+1),t.moveNext()):setTimeout(e,100)};setTimeout(e,300);return}if((null==m?void 0:m.route)&&p!==m.route){t.destroy(),k(u+1),o.push(m.route),setTimeout(()=>{let t=r.slice(u+1);if(t.length>0){let o=(0,i.B)({showProgress:!0,animate:!0,allowClose:!0,overlayColor:"rgba(0, 0, 0, 0.75)",stagePadding:10,popoverClass:"vrem-tour-popover",steps:J(t),onDestroyStarted:()=>{q(),z.current=null,x.current=!1,j(!1),I(null),k(0)},onNextClick:(r,a,n)=>{let i=n.state.activeIndex||0,c=i===t.length-1,u=t[i];if(u&&s.F.tours.updateProgress({tourTrack:e,stepId:u.id,completed:!0}).catch(console.error),c){s.F.tours.completeTrack(e).catch(console.error),q(),o.destroy(),j(!1),I(null),k(0),V(),l.oR.success("".concat(d[e].title," completed!"));return}o.moveNext()}});D.current=o,o.drive()}},500);return}k(u+1),t.moveNext()},onPrevClick:(e,o,r)=>{k(Math.max(0,(r.state.activeIndex||0)-1)),t.movePrevious()},onCloseClick:()=>{t.destroy()}});D.current=t,t.drive(a)},300)},[J,p,o,null==m?void 0:m.accountType,q,V,G]),H=(0,a.useCallback)(async function(e){var t;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=d[e].route;if((null==m||null==(t=m.accountType)?void 0:t.toUpperCase())==="AGENT"&&("JOB_MANAGEMENT"===e||"MESSAGING_CHAT"===e)&&(a="/dashboard"),M.includes(e))if(h)try{s.F.organizations.setActiveOrganization(h);let e=await s.F.tours.createDemoProject();P.current=!0,F.current=e.id,U(),await new Promise(e=>setTimeout(e,500))}catch(e){console.error("Failed to create demo project:",e),l.oR.error("Failed to create demo project: ".concat((null==e?void 0:e.message)||"Unknown error"))}else l.oR.error("No organization selected. Please select an organization first.");p!==a?(R.current=e,N.current=r,o.push(a)):W(e,r)},[p,o,W,U,h,null==m?void 0:m.accountType]),K=(0,a.useCallback)((e,t)=>{H(e,t)},[H]);(0,a.useEffect)(()=>{if(!_.current&&!y&&b&&"/dashboard"===p&&!b.dismissedGuide&&!b.hasCompletedSetup&&!Object.values(b.trackProgress||{}).some(e=>e&&(e.completed>0||e.finished))){_.current=!0;let e=setTimeout(()=>{H("DASHBOARD_OVERVIEW")},1e3);return()=>clearTimeout(e)}},[y,b,p,H]),(0,a.useEffect)(()=>{if(R.current){let e=R.current,t=N.current;p===d[e].route&&(R.current=null,N.current=0,setTimeout(()=>{W(e,t)},500))}},[p,W]),(0,a.useEffect)(()=>{let e=e=>{if(x.current&&D.current&&z.current){var t;if((null==(t=e.detail)?void 0:t.id)===F.current||F.current){let e=()=>{if(document.querySelector('[data-tour="job-task-view"]')){var t,o,r;x.current=!1;let e=z.current,a=g(e,w),n=(null==(o=D.current)||null==(t=o.getState())?void 0:t.activeIndex)||0,i=a[n];i&&s.F.tours.updateProgress({tourTrack:e,stepId:i.id,completed:!0}).catch(console.error),k(n+1),null==(r=D.current)||r.moveNext()}else setTimeout(e,100)};setTimeout(e,300)}}};return window.addEventListener("jobTaskViewOpened",e),()=>{window.removeEventListener("jobTaskViewOpened",e)}},[null==m?void 0:m.accountType]);let Q=(0,a.useCallback)(()=>{D.current&&D.current.moveNext()},[]),X=(0,a.useCallback)(()=>{D.current&&D.current.movePrevious()},[]),Z=(0,a.useCallback)(()=>{if(D.current&&T){let e=g(T,w)[C];e&&s.F.tours.updateProgress({tourTrack:T,stepId:e.id,skipped:!0}).catch(console.error),D.current.moveNext()}},[T,C,null==m?void 0:m.accountType]),$=(0,a.useCallback)(async()=>{D.current&&D.current.destroy(),R.current=null,N.current=0,z.current=null,x.current=!1,await q(),j(!1),I(null),k(0)},[q]),ee=(0,a.useCallback)(async e=>{try{await s.F.tours.completeTrack(e),await V(),l.oR.success("".concat(d[e].title," completed!"))}catch(e){console.error("Failed to complete track:",e),l.oR.error("Failed to mark track as complete")}},[V]),et=(0,a.useCallback)(async()=>{try{D.current&&D.current.destroy(),await q(),j(!1),I(null),k(0),z.current=null,x.current=!1,await s.F.tours.dismissGuide(),await V()}catch(e){console.error("Failed to dismiss guide:",e),l.oR.error("Failed to dismiss guide")}},[V,q]),eo=(0,a.useCallback)(async()=>{try{D.current&&D.current.destroy(),j(!1),I(null),k(0),z.current=null,x.current=!1,P.current=!1,F.current=null,await s.F.tours.resetProgress(),await V(),l.oR.success("Tour progress has been reset")}catch(e){console.error("Failed to reset progress:",e),l.oR.error("Failed to reset progress")}},[V]),er=!y&&!A&&!(null==b?void 0:b.dismissedGuide)&&!(null==b?void 0:b.hasCompletedSetup);return(0,r.jsx)(u.Provider,{value:{status:b,isLoading:y,error:A,activeTour:T,activeStepIndex:C,isTourActive:O,shouldShowGuide:er,tourStepContext:w,getTrackProgress:L,getOverallProgress:Y,startTour:H,startTourFromStep:K,nextStep:Q,prevStep:X,skipStep:Z,exitTour:$,completeTrack:ee,dismissGuide:et,resetProgress:eo,refetchStatus:V},children:t})}function h(){let e=(0,a.useContext)(u);if(void 0===e)throw Error("useTour must be used within a TourProvider");return e}},35561:(e,t,o)=>{o.d(t,{Ke:()=>s,Nt:()=>n,R6:()=>i});var r=o(95155),a=o(57259);function n(e){let{...t}=e;return(0,r.jsx)(a.bL,{"data-slot":"collapsible",...t})}function i(e){let{...t}=e;return(0,r.jsx)(a.R6,{"data-slot":"collapsible-trigger",...t})}function s(e){let{...t}=e;return(0,r.jsx)(a.Ke,{"data-slot":"collapsible-content",...t})}},65939:(e,t,o)=>{o.d(t,{A:()=>u,O:()=>d});var r=o(95155),a=o(12115),n=o(28014),i=o(47471),s=o(95657),l=o(20063);let c=(0,a.createContext)(void 0);function d(e){let{children:t}=e,[o,d]=(0,a.useState)(null),[u,g]=(0,a.useState)([]),[p,m]=(0,a.useState)(null),[h,v]=(0,a.useState)(null),[w,b]=(0,a.useState)(!0),f=(0,l.useRouter)(),{signIn:y,setActive:E}=(0,n.go)(),{signUp:A,setActive:S}=(0,n.yC)(),{signOut:T}=(0,n.ho)(),{isSignedIn:I,isLoaded:C,getToken:k}=(0,i.d)(),O=e=>{let t=(e.accountType||"").toUpperCase(),o="AGENT"===t?"AGENT":"PROVIDER"===t?"PROVIDER":"COMPANY"===t?"COMPANY":"PROVIDER";return{...e,accountType:o,role:o}};(0,a.useEffect)(()=>{(async()=>{if(console.debug("[AuthContext] initAuth START | isClerkLoaded=%s isSignedIn=%s",C,I),!C)return console.debug("[AuthContext] Waiting for Clerk to load...");if(I){var e,t,o,r,a,n;try{let r=await k();if(console.debug("[AuthContext] Clerk token obtained: %s",r?"".concat(r.substring(0,20),"..."):"NONE"),r){let a,n;localStorage.setItem("token",r),v(r);let i=0,l=localStorage.getItem("organizationId");for(console.debug("[AuthContext] Before bootstrap | storedOrgId=%s",l||"NONE");i<=2;)try{console.debug("[AuthContext] Calling /auth/me/bootstrap (attempt %d)",i+1),a=await s.F.auth.bootstrap(),console.debug("[AuthContext] Bootstrap SUCCESS | userId=%s personalOrgId=%s recommendedOrgId=%s memberships=%d",a.id,a.personalOrgId,a.recommendedActiveOrgId,(null==(e=a.memberships)?void 0:e.length)||0);break}catch(a){let e=null==a||null==(t=a.message)?void 0:t.includes("403"),r=null==a||null==(o=a.message)?void 0:o.includes("404");if((e||r)&&i<2){console.warn("[AuthContext] Bootstrap attempt ".concat(i+1," failed with org error, clearing org and retrying...")),localStorage.removeItem("organizationId"),s.F.organizations.setActiveOrganization(null),i++;continue}throw a}if(!a)throw Error("Failed to bootstrap after retries");d(O(a));let c=a.memberships||[];g(c);let u=s.F.organizations.getActiveOrganization(),p=u&&c.some(e=>e.orgId===u),h=!u;console.debug("[AuthContext] Org resolution | storedOrg=%s isValid=%s isFirstLogin=%s memberships=[%s]",u||"NONE",p,h,c.map(e=>e.orgId).join(", ")),u&&!p&&(console.warn("[AuthContext] Stored org ".concat(u," is no longer valid, clearing...")),localStorage.removeItem("organizationId")),n=p?u:h&&a.personalOrgId?a.personalOrgId:a.recommendedActiveOrgId||a.personalOrgId||null,console.debug("[AuthContext] Resolved orgId=%s (storedValid=%s, isFirstLogin=%s, recommended=%s, personal=%s)",n,p?u:"N/A",h,a.recommendedActiveOrgId,a.personalOrgId),n?s.F.organizations.setActiveOrganization(n):(console.error("[AuthContext] No valid org after bootstrap - this should not happen"),s.F.organizations.setActiveOrganization(null)),m(n),console.debug("[AuthContext] initAuth COMPLETE | activeOrgId=%s",n)}}catch(e){if((null==e||null==(r=e.message)?void 0:r.includes("Network Error"))||(null==e||null==(a=e.message)?void 0:a.includes("Failed to fetch"))||(null==e||null==(n=e.message)?void 0:n.includes("ERR_CONNECTION_REFUSED"))||(null==e?void 0:e.name)==="TypeError"){console.warn("Backend unreachable, signing out..."),localStorage.removeItem("token"),localStorage.removeItem("organizationId"),v(null),d(null),g([]),m(null);try{await T()}catch(e){}window.location.href="/sign-in";return}console.error("Failed to sync with backend:",e),localStorage.removeItem("token"),localStorage.removeItem("organizationId"),v(null),d(null),g([]),m(null)}}else!1===I&&(localStorage.removeItem("token"),localStorage.removeItem("organizationId"),v(null),d(null),g([]),m(null));b(!1)})()},[C,I,k]),(0,a.useEffect)(()=>{if(!C||!I)return;let e=async()=>{try{let e=await k();e&&(localStorage.setItem("token",e),v(e),window.dispatchEvent(new CustomEvent("auth-token-refreshed")))}catch(e){console.error("Failed to refresh Clerk token:",e)}},t=setInterval(e,3e4);e();let o=()=>{console.log("Token expired event received, refreshing token..."),e()};window.addEventListener("auth-token-expired",o);let r=()=>{"visible"===document.visibilityState&&(console.log("Tab became visible, refreshing token..."),e())};document.addEventListener("visibilitychange",r);let a=()=>{console.log("Window focused, refreshing token..."),e()};return window.addEventListener("focus",a),()=>{clearInterval(t),window.removeEventListener("auth-token-expired",o),document.removeEventListener("visibilitychange",r),window.removeEventListener("focus",a)}},[C,I,k]),(0,a.useEffect)(()=>{let e=e=>{let t=null==e?void 0:e.detail,o=null==t?void 0:t.organization;o&&g(e=>e.map(e=>e.orgId===o.id?{...e,organization:{...e.organization,...o}}:e))},t=e=>{let{status:t,orgId:r}=(null==e?void 0:e.detail)||{};console.warn("Org context error: status=".concat(t,", orgId=").concat(r)),(null==o?void 0:o.personalOrgId)&&u.find(e=>e.orgId===o.personalOrgId)&&(console.log("Recovering from org error by switching to personal org ".concat(o.personalOrgId)),m(o.personalOrgId),s.F.organizations.setActiveOrganization(o.personalOrgId),window.dispatchEvent(new CustomEvent("organizationChanged",{detail:{orgId:o.personalOrgId,recovered:!0}})))};return window.addEventListener("organizationUpdated",e),window.addEventListener("org-context-error",t),()=>{window.removeEventListener("organizationUpdated",e),window.removeEventListener("org-context-error",t)}},[o,u]);let j=async e=>{localStorage.setItem("token",e.token),v(e.token);let t=await s.F.auth.bootstrap();d(O(t)),g(t.memberships||[]);let o=t.personalOrgId||t.recommendedActiveOrgId||null;o?s.F.organizations.setActiveOrganization(o):s.F.organizations.setActiveOrganization(null),m(o),f.push("/dashboard")},R=async e=>{if(I)return void f.push("/dashboard");if(!y||!E)throw Error("Clerk not initialized");b(!0);try{if(localStorage.removeItem("organizationId"),m(null),e.email.toLowerCase().endsWith("@example.com")){let t=await fetch("".concat("http://localhost:3001","/auth/test-login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.message||"Login failed")}let{token:o}=await t.json(),r=await y.create({strategy:"ticket",ticket:o});if("complete"===r.status){await E({session:r.createdSessionId}),f.push("/dashboard");return}throw Error("Sign-in incomplete: ".concat(r.status))}let t=await y.create({identifier:e.email,password:e.password});if("complete"===t.status)await E({session:t.createdSessionId}),f.push("/dashboard");else if("needs_second_factor"===t.status)throw console.log("Sign-in requires second factor:",{status:t.status,supportedSecondFactors:t.supportedSecondFactors,firstFactorVerification:t.firstFactorVerification}),Error("This account requires email verification. Please check your email for a verification code.");else if("needs_first_factor"===t.status)throw console.log("Sign-in needs first factor:",t.supportedFirstFactors),Error("Sign-in requires additional verification. Please try again.");else throw console.log("Sign-in requires additional steps:",t.status,t),Error("Sign-in incomplete: ".concat(t.status))}catch(e){var t,o,r,a;if(b(!1),console.error("Login failed:",e),(null==(o=e.errors)||null==(t=o[0])?void 0:t.code)==="session_exists"||(null==(r=e.message)?void 0:r.includes("already signed in")))return void f.push("/dashboard");if(e.errors)throw Error((null==(a=e.errors[0])?void 0:a.message)||"Login failed");throw e}},N=async e=>{var t,o;if(I)return void f.push("/dashboard");if(!A||!S)throw Error("Clerk not initialized");b(!0);try{localStorage.removeItem("organizationId"),m(null);let o=e.name.trim().split(" "),r=o[0]||"",a=o.slice(1).join(" ")||"",n=await A.create({emailAddress:e.email,password:e.password,firstName:r,lastName:a,unsafeMetadata:{accountType:e.accountType}});if("complete"===n.status)await S({session:n.createdSessionId}),f.push("/dashboard");else if("missing_requirements"===n.status){if(null==(t=n.unverifiedFields)?void 0:t.includes("email_address"))throw await A.prepareEmailAddressVerification({strategy:"email_code"}),Error("EMAIL_VERIFICATION_REQUIRED");throw Error("Registration incomplete: ".concat(n.status))}else throw Error("Registration incomplete: ".concat(n.status))}catch(e){if(b(!1),console.error("Registration failed:",e),e.errors)throw Error((null==(o=e.errors[0])?void 0:o.message)||"Registration failed");throw e}},P=async(e,t)=>{if(I)return void f.push("/dashboard");if(!y)throw Error("Clerk not initialized");b(!0);try{localStorage.removeItem("organizationId"),m(null),await y.authenticateWithRedirect({strategy:"google"===e?"oauth_google":"oauth_facebook",redirectUrl:"/sso-callback",redirectUrlComplete:"/dashboard"})}catch(e){if(b(!1),console.error("OAuth login failed:",e),e.errors){var o;throw Error((null==(o=e.errors[0])?void 0:o.message)||"OAuth login failed")}throw e}},F=async e=>{b(!0);try{localStorage.removeItem("organizationId"),m(null),await j(e)}catch(e){throw console.error("Onboarding completion failed:",e),e}finally{b(!1)}},D=async()=>{try{await T()}catch(e){console.error("Clerk signout error:",e)}localStorage.removeItem("token"),localStorage.removeItem("organizationId"),v(null),d(null),g([]),m(null),window.location.href="/"};return(0,r.jsx)(c.Provider,{value:{user:o,memberships:u,activeOrganizationId:p,token:h,isLoading:w,login:R,register:N,loginWithOAuth:P,completeOnboarding:F,logout:D,switchOrganization:e=>{if(e&&!u.some(t=>t.orgId===e)){var t;console.warn("Attempted to switch to invalid org ".concat(e,", recovering..."));let r=(null==o?void 0:o.personalOrgId)||(null==(t=u[0])?void 0:t.orgId)||null;r&&(m(r),s.F.organizations.setActiveOrganization(r),window.dispatchEvent(new CustomEvent("organizationChanged",{detail:{orgId:r}})));return}m(e),s.F.organizations.setActiveOrganization(e),window.dispatchEvent(new CustomEvent("organizationChanged",{detail:{orgId:e}}))}},children:t})}function u(){let e=(0,a.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);