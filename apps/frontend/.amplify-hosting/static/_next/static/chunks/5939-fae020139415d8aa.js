"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5939],{65939:(e,o,t)=>{t.d(o,{A:()=>u,O:()=>c});var r=t(95155),n=t(12115),i=t(28014),a=t(47471),s=t(95657),l=t(20063);let d=(0,n.createContext)(void 0);function c(e){let{children:o}=e,[t,c]=(0,n.useState)(null),[u,g]=(0,n.useState)([]),[h,m]=(0,n.useState)(null),[v,p]=(0,n.useState)(null),[w,f]=(0,n.useState)(!0),I=(0,l.useRouter)(),{signIn:E,setActive:O}=(0,i.go)(),{signUp:b,setActive:A}=(0,i.yC)(),{signOut:C}=(0,i.ho)(),{isSignedIn:S,isLoaded:k,getToken:z}=(0,a.d)(),y=e=>{let o=(e.accountType||"").toUpperCase(),t="AGENT"===o?"AGENT":"PROVIDER"===o?"PROVIDER":"COMPANY"===o?"COMPANY":"PROVIDER";return{...e,accountType:t,role:t}};(0,n.useEffect)(()=>{(async()=>{if(console.debug("[AuthContext] initAuth START | isClerkLoaded=%s isSignedIn=%s",k,S),!k)return console.debug("[AuthContext] Waiting for Clerk to load...");if(S){var e,o,t,r,n,i;try{let r=await z();if(console.debug("[AuthContext] Clerk token obtained: %s",r?"".concat(r.substring(0,20),"..."):"NONE"),r){let n,i;localStorage.setItem("token",r),p(r);let a=0,l=localStorage.getItem("organizationId");for(console.debug("[AuthContext] Before bootstrap | storedOrgId=%s",l||"NONE");a<=2;)try{console.debug("[AuthContext] Calling /auth/me/bootstrap (attempt %d)",a+1),n=await s.F.auth.bootstrap(),console.debug("[AuthContext] Bootstrap SUCCESS | userId=%s personalOrgId=%s recommendedOrgId=%s memberships=%d",n.id,n.personalOrgId,n.recommendedActiveOrgId,(null==(e=n.memberships)?void 0:e.length)||0);break}catch(n){let e=null==n||null==(o=n.message)?void 0:o.includes("403"),r=null==n||null==(t=n.message)?void 0:t.includes("404");if((e||r)&&a<2){console.warn("[AuthContext] Bootstrap attempt ".concat(a+1," failed with org error, clearing org and retrying...")),localStorage.removeItem("organizationId"),s.F.organizations.setActiveOrganization(null),a++;continue}throw n}if(!n)throw Error("Failed to bootstrap after retries");c(y(n));let d=n.memberships||[];g(d);let u=s.F.organizations.getActiveOrganization(),h=u&&d.some(e=>e.orgId===u),v=!u;console.debug("[AuthContext] Org resolution | storedOrg=%s isValid=%s isFirstLogin=%s memberships=[%s]",u||"NONE",h,v,d.map(e=>e.orgId).join(", ")),u&&!h&&(console.warn("[AuthContext] Stored org ".concat(u," is no longer valid, clearing...")),localStorage.removeItem("organizationId")),i=h?u:v&&n.personalOrgId?n.personalOrgId:n.recommendedActiveOrgId||n.personalOrgId||null,console.debug("[AuthContext] Resolved orgId=%s (storedValid=%s, isFirstLogin=%s, recommended=%s, personal=%s)",i,h?u:"N/A",v,n.recommendedActiveOrgId,n.personalOrgId),i?s.F.organizations.setActiveOrganization(i):(console.error("[AuthContext] No valid org after bootstrap - this should not happen"),s.F.organizations.setActiveOrganization(null)),m(i),console.debug("[AuthContext] initAuth COMPLETE | activeOrgId=%s",i)}}catch(e){if((null==e||null==(r=e.message)?void 0:r.includes("Network Error"))||(null==e||null==(n=e.message)?void 0:n.includes("Failed to fetch"))||(null==e||null==(i=e.message)?void 0:i.includes("ERR_CONNECTION_REFUSED"))||(null==e?void 0:e.name)==="TypeError"){console.warn("Backend unreachable, signing out..."),localStorage.removeItem("token"),localStorage.removeItem("organizationId"),p(null),c(null),g([]),m(null);try{await C()}catch(e){}window.location.href="/sign-in";return}console.error("Failed to sync with backend:",e),localStorage.removeItem("token"),localStorage.removeItem("organizationId"),p(null),c(null),g([]),m(null)}}else!1===S&&(localStorage.removeItem("token"),localStorage.removeItem("organizationId"),p(null),c(null),g([]),m(null));f(!1)})()},[k,S,z]),(0,n.useEffect)(()=>{if(!k||!S)return;let e=async()=>{try{let e=await z();e&&(localStorage.setItem("token",e),p(e),window.dispatchEvent(new CustomEvent("auth-token-refreshed")))}catch(e){console.error("Failed to refresh Clerk token:",e)}},o=setInterval(e,3e4);e();let t=()=>{console.log("Token expired event received, refreshing token..."),e()};window.addEventListener("auth-token-expired",t);let r=()=>{"visible"===document.visibilityState&&(console.log("Tab became visible, refreshing token..."),e())};document.addEventListener("visibilitychange",r);let n=()=>{console.log("Window focused, refreshing token..."),e()};return window.addEventListener("focus",n),()=>{clearInterval(o),window.removeEventListener("auth-token-expired",t),document.removeEventListener("visibilitychange",r),window.removeEventListener("focus",n)}},[k,S,z]),(0,n.useEffect)(()=>{let e=e=>{let o=null==e?void 0:e.detail,t=null==o?void 0:o.organization;t&&g(e=>e.map(e=>e.orgId===t.id?{...e,organization:{...e.organization,...t}}:e))},o=e=>{let{status:o,orgId:r}=(null==e?void 0:e.detail)||{};console.warn("Org context error: status=".concat(o,", orgId=").concat(r)),(null==t?void 0:t.personalOrgId)&&u.find(e=>e.orgId===t.personalOrgId)&&(console.log("Recovering from org error by switching to personal org ".concat(t.personalOrgId)),m(t.personalOrgId),s.F.organizations.setActiveOrganization(t.personalOrgId),window.dispatchEvent(new CustomEvent("organizationChanged",{detail:{orgId:t.personalOrgId,recovered:!0}})))};return window.addEventListener("organizationUpdated",e),window.addEventListener("org-context-error",o),()=>{window.removeEventListener("organizationUpdated",e),window.removeEventListener("org-context-error",o)}},[t,u]);let F=async e=>{localStorage.setItem("token",e.token),p(e.token);let o=await s.F.auth.bootstrap();c(y(o)),g(o.memberships||[]);let t=o.personalOrgId||o.recommendedActiveOrgId||null;t?s.F.organizations.setActiveOrganization(t):s.F.organizations.setActiveOrganization(null),m(t),I.push("/dashboard")},x=async e=>{if(S)return void I.push("/dashboard");if(!E||!O)throw Error("Clerk not initialized");f(!0);try{if(localStorage.removeItem("organizationId"),m(null),e.email.toLowerCase().endsWith("@example.com")){let o=await fetch("".concat("http://localhost:3001","/auth/test-login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok){let e=await o.json().catch(()=>({}));throw Error(e.message||"Login failed")}let{token:t}=await o.json(),r=await E.create({strategy:"ticket",ticket:t});if("complete"===r.status){await O({session:r.createdSessionId}),I.push("/dashboard");return}throw Error("Sign-in incomplete: ".concat(r.status))}let o=await E.create({identifier:e.email,password:e.password});if("complete"===o.status)await O({session:o.createdSessionId}),I.push("/dashboard");else if("needs_second_factor"===o.status)throw console.log("Sign-in requires second factor:",{status:o.status,supportedSecondFactors:o.supportedSecondFactors,firstFactorVerification:o.firstFactorVerification}),Error("This account requires email verification. Please check your email for a verification code.");else if("needs_first_factor"===o.status)throw console.log("Sign-in needs first factor:",o.supportedFirstFactors),Error("Sign-in requires additional verification. Please try again.");else throw console.log("Sign-in requires additional steps:",o.status,o),Error("Sign-in incomplete: ".concat(o.status))}catch(e){var o,t,r,n;if(f(!1),console.error("Login failed:",e),(null==(t=e.errors)||null==(o=t[0])?void 0:o.code)==="session_exists"||(null==(r=e.message)?void 0:r.includes("already signed in")))return void I.push("/dashboard");if(e.errors)throw Error((null==(n=e.errors[0])?void 0:n.message)||"Login failed");throw e}},R=async e=>{var o,t;if(S)return void I.push("/dashboard");if(!b||!A)throw Error("Clerk not initialized");f(!0);try{localStorage.removeItem("organizationId"),m(null);let t=e.name.trim().split(" "),r=t[0]||"",n=t.slice(1).join(" ")||"",i=await b.create({emailAddress:e.email,password:e.password,firstName:r,lastName:n,unsafeMetadata:{accountType:e.accountType}});if("complete"===i.status)await A({session:i.createdSessionId}),I.push("/dashboard");else if("missing_requirements"===i.status){if(null==(o=i.unverifiedFields)?void 0:o.includes("email_address"))throw await b.prepareEmailAddressVerification({strategy:"email_code"}),Error("EMAIL_VERIFICATION_REQUIRED");throw Error("Registration incomplete: ".concat(i.status))}else throw Error("Registration incomplete: ".concat(i.status))}catch(e){if(f(!1),console.error("Registration failed:",e),e.errors)throw Error((null==(t=e.errors[0])?void 0:t.message)||"Registration failed");throw e}},L=async(e,o)=>{if(S)return void I.push("/dashboard");if(!E)throw Error("Clerk not initialized");f(!0);try{localStorage.removeItem("organizationId"),m(null),await E.authenticateWithRedirect({strategy:"google"===e?"oauth_google":"oauth_facebook",redirectUrl:"/sso-callback",redirectUrlComplete:"/dashboard"})}catch(e){if(f(!1),console.error("OAuth login failed:",e),e.errors){var t;throw Error((null==(t=e.errors[0])?void 0:t.message)||"OAuth login failed")}throw e}},N=async e=>{f(!0);try{localStorage.removeItem("organizationId"),m(null),await F(e)}catch(e){throw console.error("Onboarding completion failed:",e),e}finally{f(!1)}},_=async()=>{try{await C()}catch(e){console.error("Clerk signout error:",e)}localStorage.removeItem("token"),localStorage.removeItem("organizationId"),p(null),c(null),g([]),m(null),window.location.href="/"};return(0,r.jsx)(d.Provider,{value:{user:t,memberships:u,activeOrganizationId:h,token:v,isLoading:w,login:x,register:R,loginWithOAuth:L,completeOnboarding:N,logout:_,switchOrganization:e=>{if(e&&!u.some(o=>o.orgId===e)){var o;console.warn("Attempted to switch to invalid org ".concat(e,", recovering..."));let r=(null==t?void 0:t.personalOrgId)||(null==(o=u[0])?void 0:o.orgId)||null;r&&(m(r),s.F.organizations.setActiveOrganization(r),window.dispatchEvent(new CustomEvent("organizationChanged",{detail:{orgId:r}})));return}m(e),s.F.organizations.setActiveOrganization(e),window.dispatchEvent(new CustomEvent("organizationChanged",{detail:{orgId:e}}))}},children:o})}function u(){let e=(0,n.useContext)(d);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);