# Stripe Integration Testing Guide

## Overview

VREM uses Stripe Checkout for processing payments when agents place orders with photography provider companies.

## Prerequisites

1. **Stripe Account**: Create a free account at [stripe.com](https://stripe.com)
2. **Stripe CLI**: Install for local webhook testing

### Installing Stripe CLI

```bash
# macOS
brew install stripe/stripe-cli/stripe

# Windows (via scoop)
scoop install stripe

# Linux
# Download from https://github.com/stripe/stripe-cli/releases
```

## Environment Setup

### Backend (.env)

```env
# Stripe Configuration
STRIPE_SECRET_KEY="sk_test_..."      # From Stripe Dashboard > Developers > API Keys
STRIPE_WEBHOOK_SECRET="whsec_..."    # Generated by Stripe CLI (see below)

# Frontend URL for redirects
FRONTEND_URL="http://localhost:3000"
```

### Frontend (.env.local)

```env
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."  # Optional - for future client-side Stripe.js
```

## Local Development

### 1. Start the Backend

```bash
cd apps/backend
npm run start:dev
```

### 2. Start Stripe CLI Webhook Forwarding

```bash
stripe listen --forward-to localhost:3001/webhooks/stripe
```

This will output a webhook signing secret like:
```
Ready! Your webhook signing secret is whsec_1234567890abcdef...
```

Copy this to your `.env` as `STRIPE_WEBHOOK_SECRET`.

### 3. Start the Frontend

```bash
cd apps/frontend/vrem-app
npm run dev
```

## Test Cards

Use these test card numbers in Stripe Checkout:

| Card Number | Description |
|-------------|-------------|
| `4242 4242 4242 4242` | Succeeds and immediately processes |
| `4000 0025 0000 3155` | Requires 3D Secure authentication |
| `4000 0000 0000 9995` | Declines with insufficient funds |
| `4000 0000 0000 0002` | Declines (generic decline) |

**For all test cards:**
- Use any future expiration date (e.g., 12/34)
- Use any 3-digit CVC (e.g., 123)
- Use any billing postal code (e.g., 12345)

## Payment Flow

### Agent Booking Flow

1. Agent logs in and navigates to `/booking`
2. Agent selects a provider organization
3. Agent selects packages and add-ons
4. Agent fills in property details and scheduling
5. Agent clicks "Proceed to Payment"
6. Agent is redirected to Stripe Checkout
7. Agent completes payment with test card
8. Stripe sends webhook to backend
9. Backend creates the project
10. Agent is redirected to success page
11. Success page polls until project is ready

### Webhook Events Handled

| Event | Action |
|-------|--------|
| `checkout.session.completed` | Creates project from PendingOrder |
| `checkout.session.expired` | Marks PendingOrder as expired |
| `payment_intent.payment_failed` | Logs failure (no action) |

## Testing Scenarios

### Successful Payment

1. Go through booking flow
2. Use card `4242 4242 4242 4242`
3. Complete checkout
4. Verify project appears in jobs list

### Failed Payment

1. Go through booking flow
2. Use card `4000 0000 0000 9995`
3. Payment should fail
4. Verify no project is created

### 3D Secure Authentication

1. Go through booking flow
2. Use card `4000 0025 0000 3155`
3. Complete 3D Secure popup (click "Complete")
4. Verify project is created

### Session Expiry

1. Start booking flow
2. Get to Stripe Checkout
3. Wait 24 hours (or manually expire via Stripe Dashboard)
4. Verify PendingOrder status is EXPIRED

## Debugging

### View Stripe Events

```bash
stripe events list --limit 10
```

### Trigger Test Webhook

```bash
stripe trigger checkout.session.completed
```

### View Webhook Logs

In Stripe Dashboard: Developers > Webhooks > Select endpoint > View logs

### Backend Logs

The backend logs webhook events:
```
[StripeWebhookController] Received Stripe event: checkout.session.completed
[OrderFulfillmentService] Created project proj-123 for order pending-456
```

## Database Records

### PendingOrder Status Flow

```
PENDING_PAYMENT → PAYMENT_COMPLETED → PROJECT_CREATED
                ↘ EXPIRED (if session expires)
                ↘ CANCELLED (if manually cancelled)
```

### Checking Records

```sql
-- View pending orders
SELECT id, status, "totalAmount", "createdAt" FROM "PendingOrder" ORDER BY "createdAt" DESC;

-- View projects with payment info
SELECT id, "addressLine1", "paidAt", "paymentAmount" FROM "Project" WHERE "paidAt" IS NOT NULL;
```

## Production Checklist

Before going live:

- [ ] Switch to live Stripe keys (`sk_live_...`, `pk_live_...`)
- [ ] Configure production webhook endpoint in Stripe Dashboard
- [ ] Update `STRIPE_WEBHOOK_SECRET` with production webhook secret
- [ ] Update `FRONTEND_URL` to production URL
- [ ] Test with real card (small amount, then refund)
- [ ] Enable Stripe Radar for fraud detection
- [ ] Set up Stripe email receipts

## Troubleshooting

### "Webhook signature verification failed"

- Ensure `STRIPE_WEBHOOK_SECRET` matches the CLI output
- Restart backend after changing the secret
- Make sure you're using the correct secret (CLI vs Dashboard)

### "Project not created after payment"

- Check backend logs for errors
- Verify webhook is being received (`stripe listen` shows events)
- Check PendingOrder status in database

### "Checkout session expired"

- Sessions expire after 24 hours by default
- User must complete payment within this window
- Expired orders must be re-created

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/orders/checkout` | Create Stripe Checkout session |
| GET | `/orders/status/:sessionId` | Get order status by session ID |
| POST | `/webhooks/stripe` | Stripe webhook handler |
